<!DOCTYPE html>
<html lang="en">
<head>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6672302762343789"
     crossorigin="anonymous"></script>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXZS8C1FLY"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XXZS8C1FLY');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMBA APB Protocol Masterclass - EcrioniX</title>
    <meta name="description" content="Complete Guide and Simulator for ARM AMBA APB Protocol (APB2, APB3, APB4, APB5). Interactive State Machine and Waveforms.">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Orbitron:wght@500;700&family=JetBrains+Mono&family=Merriweather:ital,wght@0,300;0,700;1,300&display=swap" rel="stylesheet">
    <!-- MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #020617; color: #f8fafc; overflow: hidden; }
        .tech-font { font-family: 'Orbitron', sans-serif; }
        .mono-font { font-family: 'JetBrains Mono', monospace; }
        .read-font { font-family: 'Merriweather', serif; }

        /* Mobile Scroll */
        @media (max-width: 1024px) { body { overflow-y: auto; } }

        .watermark {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 8rem; font-weight: 900; color: rgba(147, 51, 234, 0.03); /* Purple tint */
            pointer-events: none; user-select: none; z-index: 0;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        /* Tabs - Updated for distinct button look */
        .tab-btn {
            @apply px-6 py-2 text-xs font-bold transition-all rounded-lg border border-slate-700 text-slate-400 uppercase tracking-wider hover:text-white hover:border-purple-500 hover:bg-purple-900/20;
        }
        .tab-active {
            @apply border-purple-500 text-white bg-purple-600 shadow-lg shadow-purple-500/30;
        }

        /* Waveform Canvas */
        #wave-canvas {
            background-color: #0b0f19;
            border-radius: 8px;
            border: 1px solid #1e293b;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 20px 20px;
            width: 100%;
            height: 100%;
            display: block;
        }

        /* State Machine Visuals */
        .state-node {
            fill: #1e293b; stroke: #64748b; stroke-width: 2; transition: all 0.3s;
        }
        .state-active {
            fill: #4c1d95; stroke: #a78bfa; filter: drop-shadow(0 0 10px #8b5cf6);
        }
        .state-text {
            font-family: 'Orbitron', sans-serif; font-size: 12px; fill: #cbd5e1; font-weight: bold; text-anchor: middle; pointer-events: none;
        }
        .transition-line {
            fill: none; stroke: #475569; stroke-width: 2; marker-end: url(#arrow); transition: stroke 0.2s;
        }
        .transition-active {
            stroke: #fbbf24; stroke-width: 3; filter: drop-shadow(0 0 5px #fbbf24); marker-end: url(#arrow-active);
        }

        /* Theory Styles */
        .prose h1 { @apply text-3xl md:text-4xl font-bold text-white mb-8 tech-font border-b border-slate-800 pb-4; }
        .prose h2 { @apply text-xl md:text-2xl font-bold text-purple-400 mt-12 mb-6 uppercase tracking-wider flex items-center gap-3; }
        .prose h3 { @apply text-lg font-bold text-emerald-400 mt-8 mb-3; }
        .prose p { @apply text-slate-300 mb-4 leading-relaxed text-sm md:text-base font-light; }
        .prose strong { @apply text-white font-semibold; }
        .prose ul { @apply list-disc list-outside space-y-2 text-slate-400 mb-6 ml-6; }
        .prose table { @apply w-full text-left text-sm text-slate-400 border-collapse mb-8; }
        .prose th { @apply border-b border-slate-700 p-3 text-purple-300 font-bold bg-slate-900/50; }
        .prose td { @apply border-b border-slate-800 p-3; }
        .prose code { @apply bg-slate-900 px-1.5 py-0.5 rounded text-yellow-300 font-mono text-xs border border-slate-700; }
        .prose .highlight-box { @apply bg-slate-900/80 border-l-4 border-purple-500 p-6 my-8 rounded-r-lg shadow-lg; }

        input[type=range] { accent-color: #8b5cf6; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col relative">

    <div class="watermark">AMBA APB</div>

    <!-- Header -->
    <nav class="border-b border-slate-800 bg-slate-900/90 px-6 py-4 flex justify-between items-center z-20 sticky top-0 backdrop-blur-md">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-purple-600 rounded flex items-center justify-center text-white font-bold tech-font text-xl">A</div>
            <div>
                <h1 class="text-xl md:text-2xl font-bold text-white tech-font tracking-wide">AMBA <span class="text-purple-400">APB</span></h1>
                <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold hidden md:block">Advanced Peripheral Bus Protocol Specification</p>
            </div>
        </div>
        
        <!-- Updated Navigation Buttons with Gap -->
        <div class="flex gap-4">
            <button onclick="switchView('theory')" id="btn-theory" class="tab-btn tab-active">Spec Guide</button>
            <button onclick="switchView('lab')" id="btn-lab" class="tab-btn">Simulator Lab</button>
        </div>

        <button onclick="window.history.back()" class="group flex items-center text-slate-400 hover:text-white transition bg-slate-800/50 px-4 py-2 rounded-lg border border-slate-700 hover:border-purple-500">
            <span class="text-xs font-bold uppercase">Exit</span>
        </button>
    </nav>

    <!-- Main Content -->
    <div class="flex-grow relative overflow-y-auto lg:overflow-hidden bg-[#020617]">

        <!-- VIEW 1: THEORY GUIDE -->
        <div id="view-theory" class="absolute inset-0 z-10 overflow-y-auto custom-scroll p-4 md:p-12 flex justify-center">
            <div class="max-w-5xl w-full glass-panel p-8 md:p-16 prose mb-20 read-font">
                
                <h1>AMBA APB Protocol Specification</h1>
                <p class="lead text-lg text-slate-400 mb-8">
                    The Advanced Peripheral Bus (APB) is part of the ARM Advanced Microcontroller Bus Architecture (AMBA) family. It is a low-cost, low-power interface optimized for minimal power consumption and reduced interface complexity.
                </p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
                    <div class="highlight-box mt-0">
                        <h3 class="text-white mt-0">Key Characteristics</h3>
                        <ul class="mb-0">
                            <li><strong>Non-Pipelined:</strong> Simple request/response model.</li>
                            <li><strong>Synchronous:</strong> All signals timed to rising edge of <code>PCLK</code>.</li>
                            <li><strong>Two-Cycle Min:</strong> Every transfer takes at least 2 cycles (Setup + Access).</li>
                            <li><strong>Low Bandwidth:</strong> Ideal for configuration registers and low-speed peripherals (UART, Timer, GPIO).</li>
                        </ul>
                    </div>
                    <div class="highlight-box mt-0 border-emerald-500">
                        <h3 class="text-white mt-0">Terminology</h3>
                        <ul class="mb-0">
                            <li><strong>Requester:</strong> The Bridge/Master initiating the transfer.</li>
                            <li><strong>Completer:</strong> The Peripheral/Slave responding.</li>
                            <li><strong>Bridge:</strong> Converts high-performance bus (AHB/AXI) to APB.</li>
                        </ul>
                    </div>
                </div>

                <h2>1. Signal Descriptions (Chapter 2)</h2>
                <p>The APB interface has evolved from APB2 to APB5. Below is the complete signal list.</p>
                
                <table>
                    <thead>
                        <tr><th>Signal</th><th>Source</th><th>Description</th></tr>
                    </thead>
                    <tbody>
                        <tr><td><code>PCLK</code></td><td>Clock</td><td>Global Clock source. Rising edge active.</td></tr>
                        <tr><td><code>PRESETn</code></td><td>Reset</td><td>System Reset. Active LOW.</td></tr>
                        <tr><td><code>PADDR</code></td><td>Requester</td><td>Address Bus (up to 32-bit).</td></tr>
                        <tr><td><code>PSELx</code></td><td>Requester</td><td>Select signal for each Completer.</td></tr>
                        <tr><td><code>PENABLE</code></td><td>Requester</td><td>Enable. Indicates 2nd cycle of transfer.</td></tr>
                        <tr><td><code>PWRITE</code></td><td>Requester</td><td>Direction. High=Write, Low=Read.</td></tr>
                        <tr><td><code>PWDATA</code></td><td>Requester</td><td>Write Data Bus.</td></tr>
                        <tr><td><code>PRDATA</code></td><td>Completer</td><td>Read Data Bus.</td></tr>
                        <tr><td><code>PREADY</code></td><td>Completer</td><td>Ready. Used to extend transfer (Wait States).</td></tr>
                        <tr><td><code>PSLVERR</code></td><td>Completer</td><td>Error. Indicates transfer failure.</td></tr>
                        <tr><td><code>PPROT</code></td><td>Requester</td><td>Protection level (Privileged/Secure/Instruction).</td></tr>
                        <tr><td><code>PSTRB</code></td><td>Requester</td><td>Write Strobe (Sparse data writes).</td></tr>
                        <tr><td><code>PWAKEUP</code></td><td>Requester</td><td>Indicates activity to wake up clock domain (APB5).</td></tr>
                        <tr><td><code>PAUSER</code></td><td>Requester</td><td>User-defined attribute for request (APB5).</td></tr>
                        <tr><td><code>PNSE</code></td><td>Requester</td><td>Realm Management Extension (RME) Security (APB5).</td></tr>
                        <tr><td><code>P*CHK</code></td><td>Both</td><td>Parity Check signals for all buses (APB5).</td></tr>
                    </tbody>
                </table>

                <h2>2. Operating States (Chapter 4)</h2>
                <p>The APB state machine is the core of the protocol. It is simple and robust.</p>
                
                <h3>State 1: IDLE</h3>
                <p>The default state. <code>PSEL</code> and <code>PENABLE</code> are both LOW. No transfer is occurring.</p>

                <h3>State 2: SETUP</h3>
                <p>
                    The bus moves here when a transfer is required. 
                    <br><strong>Actions:</strong> Assert <code>PSEL</code>. Set <code>PADDR</code> and <code>PWRITE</code>. If Write, set <code>PWDATA</code>.
                    <br><strong>Duration:</strong> Exactly ONE clock cycle. <code>PENABLE</code> remains LOW.
                </p>

                <h3>State 3: ACCESS</h3>
                <p>
                    The enable phase.
                    <br><strong>Actions:</strong> Assert <code>PENABLE</code>. <code>PSEL</code> remains HIGH.
                    <br><strong>Exit Condition:</strong> Sample <code>PREADY</code> from Completer.
                    <ul>
                        <li>If <code>PREADY = 0</code>: Stay in ACCESS (Wait State). Signals must remain stable.</li>
                        <li>If <code>PREADY = 1</code> and no new transfer: Transfer complete. Go to <strong>IDLE</strong>.</li>
                        <li>If <code>PREADY = 1</code> and new transfer pending: Transfer complete. Go immediately to <strong>SETUP</strong> (Back-to-Back).</li>
                    </ul>
                </p>

                <h2>3. Transfer Types (Chapter 3)</h2>

                <h3>3.1 Write Transfer</h3>
                <p>
                    <strong>Cycle 1 (Setup):</strong> Requester drives Address, Write Data, Write Signal, and Select.<br>
                    <strong>Cycle 2 (Access):</strong> Requester asserts Enable. Completer samples data on rising edge of clock if Ready is high.
                </p>

                <h3>3.2 Read Transfer</h3>
                <p>
                    <strong>Cycle 1 (Setup):</strong> Requester drives Address, Select. PWRITE is Low.<br>
                    <strong>Cycle 2 (Access):</strong> Requester asserts Enable. Completer drives Read Data onto <code>PRDATA</code>. Requester samples data at end of cycle if Ready is high.
                </p>

                <h3>3.3 Wait States</h3>
                <p>
                    The Completer can assert <code>PREADY = LOW</code> to hold the bus in the ACCESS state. This effectively freezes all control signals until the peripheral is ready to complete the task.
                </p>

                <h3>3.4 Error Response (PSLVERR)</h3>
                <p>
                    Used to indicate an invalid transfer (e.g., writing to a read-only register). <code>PSLVERR</code> is only valid during the last cycle of an APB transfer (when PSEL, PENABLE, and PREADY are all HIGH).
                </p>

                <h2>4. APB5 Enhancements (Modern Features)</h2>
                <div class="bg-purple-500/5 p-6 rounded-lg border border-purple-500/30">
                    <h3 class="mt-0 text-purple-300">1. Parity Protection (Chapter 5)</h3>
                    <p>For safety-critical systems (ISO 26262), APB5 adds interface protection. Signals like <code>PADDR</code>, <code>PWDATA</code>, and control signals are accompanied by Check signals (e.g., <code>PADDRCHK</code>). Odd parity is standard.</p>

                    <h3 class="text-purple-300">2. Wake-up Signaling</h3>
                    <p><code>PWAKEUP</code> indicates activity on the interface, allowing clock controllers to restore power/clocks to the peripheral subsystem before the transaction begins.</p>

                    <h3 class="text-purple-300">3. User Signals</h3>
                    <p><code>PAUSER</code>, <code>PWUSER</code>, etc., allow designers to add custom sideband signals to the protocol without violating the spec.</p>
                </div>

                <div class="h-24"></div>
            </div>
        </div>

        <!-- VIEW 2: LAB SIMULATION -->
        <div id="view-lab" class="absolute inset-0 z-0 opacity-0 pointer-events-none flex flex-col lg:flex-row p-4 gap-6 overflow-y-auto custom-scroll">
            
            <!-- CONTROLS (Left) -->
            <div class="w-full lg:w-96 flex flex-col gap-4 flex-shrink-0">
                <div class="glass-panel p-6">
                    <h2 class="text-purple-400 font-bold mb-4 uppercase text-[10px] tracking-widest">Master (Requester)</h2>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="space-y-1">
                                <label class="text-[10px] text-slate-500 font-bold uppercase">Address (Hex)</label>
                                <input type="text" id="inp-addr" value="0x1A0" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white font-mono text-sm focus:border-purple-500 outline-none">
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] text-slate-500 font-bold uppercase">Write Data (Hex)</label>
                                <input type="text" id="inp-data" value="0xFF" class="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white font-mono text-sm focus:border-purple-500 outline-none">
                            </div>
                        </div>

                        <div class="flex gap-2 pt-2">
                            <button onclick="initiateTransfer('WRITE')" id="btn-write" class="flex-1 py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-lg shadow-lg border border-indigo-400 transition text-xs">
                                START WRITE
                            </button>
                            <button onclick="initiateTransfer('READ')" id="btn-read" class="flex-1 py-3 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-lg shadow-lg border border-emerald-400 transition text-xs">
                                START READ
                            </button>
                        </div>
                    </div>
                </div>

                <div class="glass-panel p-6">
                    <h2 class="text-purple-400 font-bold mb-4 uppercase text-[10px] tracking-widest">Slave (Completer) Response</h2>
                    
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-3 bg-slate-900/50 rounded border border-slate-700">
                            <div class="flex flex-col">
                                <span class="text-xs text-slate-300 font-bold">Inject Wait States</span>
                                <span class="text-[10px] text-slate-500">Delays PREADY high</span>
                            </div>
                            <input type="range" id="slider-wait" min="0" max="5" value="0" class="w-24 h-2 bg-slate-700 rounded-lg cursor-pointer">
                            <span id="val-wait" class="text-xs font-mono text-purple-400 w-6 text-right">0</span>
                        </div>

                        <div class="flex items-center justify-between p-3 bg-slate-900/50 rounded border border-slate-700">
                             <div class="flex flex-col">
                                 <span class="text-xs text-slate-300 font-bold">Inject Error</span>
                                 <span class="text-[10px] text-slate-500">Asserts PSLVERR</span>
                             </div>
                             <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="chk-error" class="sr-only peer">
                                <div class="w-9 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-red-500"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="glass-panel p-6 flex-grow flex flex-col">
                    <h2 class="text-slate-400 font-bold mb-2 uppercase text-[10px] tracking-widest">Protocol Log</h2>
                    <div id="sim-log" class="flex-grow bg-[#0b0f19] rounded border border-slate-800 p-2 font-mono text-[10px] text-slate-400 overflow-y-auto h-32 leading-relaxed">
                        <div class="text-green-400">> System Reset. IDLE state.</div>
                    </div>
                </div>
            </div>

            <!-- Visualizer -->
            <div class="flex-grow flex flex-col gap-6">
                
                <!-- State Machine Diagram -->
                <div class="glass-panel p-4 h-64 relative bg-slate-900/50 flex flex-col">
                    <div class="absolute top-4 left-4 text-[10px] text-slate-500 font-bold uppercase tracking-widest">FSM State Visualizer</div>
                    
                    <div class="flex-grow flex items-center justify-center">
                        <svg width="600" height="200" viewBox="0 0 600 200" id="fsm-svg">
                            <defs>
                                <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#475569" /></marker>
                                <marker id="arrow-active" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#fbbf24" /></marker>
                            </defs>

                            <!-- IDLE -->
                            <g transform="translate(100, 100)" id="state-idle">
                                <circle r="40" class="state-node state-active" />
                                <text dy="5" class="state-text">IDLE</text>
                            </g>

                            <!-- SETUP -->
                            <g transform="translate(300, 100)" id="state-setup">
                                <circle r="40" class="state-node" />
                                <text dy="5" class="state-text">SETUP</text>
                            </g>

                            <!-- ACCESS -->
                            <g transform="translate(500, 100)" id="state-access">
                                <circle r="40" class="state-node" />
                                <text dy="5" class="state-text">ACCESS</text>
                            </g>

                            <!-- Transitions -->
                            <!-- IDLE -> SETUP -->
                            <path d="M140,100 H260" class="transition-line" id="tr-idle-setup" />
                            <!-- SETUP -> ACCESS -->
                            <path d="M340,100 H460" class="transition-line" id="tr-setup-access" />
                            <!-- ACCESS -> IDLE (Loop back bottom) -->
                            <path d="M500,140 Q300,220 100,140" class="transition-line" fill="none" id="tr-access-idle" />
                            <!-- ACCESS -> ACCESS (Wait state loop top) -->
                            <path d="M470,70 Q500,20 530,70" class="transition-line" fill="none" id="tr-access-access" />
                            <!-- ACCESS -> SETUP (Back-to-Back Transfer) -->
                            <path d="M470,130 Q400,160 330,130" class="transition-line" fill="none" stroke-dasharray="4,4" id="tr-access-setup" />

                        </svg>
                    </div>
                </div>

                <!-- Waveform Analyzer -->
                <div class="glass-panel p-4 flex-grow flex flex-col h-[400px]">
                    <div class="flex justify-between items-center mb-2 px-2">
                        <span class="text-[10px] font-bold text-slate-500 uppercase">Timing Diagram</span>
                        <div class="flex flex-wrap gap-3 text-[10px] font-mono justify-end">
                            <span class="text-slate-500">PCLK</span>
                            <span class="text-yellow-400">PSEL</span>
                            <span class="text-blue-400">PENABLE</span>
                            <span class="text-green-400">PREADY</span>
                            <span class="text-white">PADDR</span>
                            <span class="text-purple-400">PDATA</span>
                            <span class="text-red-500">PSLVERR</span>
                        </div>
                    </div>
                    <div class="flex-grow relative bg-[#0b0f19] rounded overflow-hidden border border-slate-800">
                        <canvas id="waveCanvas" class="w-full h-full"></canvas>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <script>
        // --- State Enum ---
        const STATE_IDLE = 0;
        const STATE_SETUP = 1;
        const STATE_ACCESS = 2;

        // --- Simulation State ---
        let currentState = STATE_IDLE;
        let simTime = 0;
        let clock = 0;
        let transferQueue = []; // Queue for transfers
        let currentTx = null; // Currently processing transaction
        let waitCycles = 0;
        let remainingWaits = 0;

        // Signals
        let sigPSEL = 0;
        let sigPENABLE = 0;
        let sigPWRITE = 0;
        let sigPREADY = 0;
        let sigPADDR = "0x00";
        let sigPDATA = "0x00"; // Combined W/R data for vis
        let sigPSLVERR = 0;

        // History
        let history = [];
        const MAX_HISTORY = 300;

        // DOM
        const logBox = document.getElementById('sim-log');
        const cvs = document.getElementById('waveCanvas');
        const ctx = cvs.getContext('2d');
        const sWait = document.getElementById('slider-wait');

        // --- Logic ---
        sWait.addEventListener('input', (e) => {
            waitCycles = parseInt(e.target.value);
            document.getElementById('val-wait').innerText = waitCycles;
        });

        function switchView(v) {
            const theory = document.getElementById('view-theory');
            const lab = document.getElementById('view-lab');
            const btnT = document.getElementById('btn-theory');
            const btnL = document.getElementById('btn-lab');

            if (v === 'theory') {
                theory.classList.remove('opacity-0', 'pointer-events-none'); theory.classList.add('z-10');
                lab.classList.add('opacity-0', 'pointer-events-none'); lab.classList.remove('z-10');
                btnT.classList.add('tab-active'); btnL.classList.remove('tab-active');
            } else {
                lab.classList.remove('opacity-0', 'pointer-events-none'); lab.classList.add('z-10');
                theory.classList.add('opacity-0', 'pointer-events-none'); theory.classList.remove('z-10');
                btnL.classList.add('tab-active'); btnT.classList.remove('tab-active');
                resize();
            }
        }

        function initiateTransfer(type) {
            const addr = document.getElementById('inp-addr').value;
            const data = document.getElementById('inp-data').value;
            
            transferQueue.push({ type, addr, data });
            log(`Queueing ${type} @ ${addr}...`, "text-yellow-400");
        }

        function log(msg, cls="text-slate-400") {
            const div = document.createElement('div');
            div.className = cls;
            div.innerText = `[${simTime}] ${msg}`;
            logBox.prepend(div);
        }

        // --- FSM & Simulation Loop ---
        function step() {
            simTime++;
            clock = !clock; // Toggle clock

            if (clock) { // Rising Edge Logic
                
                // State Transitions
                switch (currentState) {
                    case STATE_IDLE:
                        sigPSEL = 0;
                        sigPENABLE = 0;
                        sigPREADY = 0; // Undefined really, but low for visual
                        sigPSLVERR = 0;
                        
                        if (transferQueue.length > 0) {
                            currentTx = transferQueue.shift();
                            currentState = STATE_SETUP;
                            log(`IDLE -> SETUP (${currentTx.type})`);
                            
                            // Setup Phase Signals
                            sigPSEL = 1;
                            sigPWRITE = currentTx.type === 'WRITE' ? 1 : 0;
                            sigPADDR = currentTx.addr;
                            sigPDATA = currentTx.type === 'WRITE' ? currentTx.data : "Z";
                            remainingWaits = waitCycles;
                        }
                        break;

                    case STATE_SETUP:
                        currentState = STATE_ACCESS;
                        log("SETUP -> ACCESS");
                        sigPENABLE = 1; // Assert Enable
                        
                        // Check for wait states immediately logic
                        if (remainingWaits > 0) {
                            sigPREADY = 0;
                            remainingWaits--;
                            log("Wait State inserted...", "text-slate-600");
                        } else {
                            sigPREADY = 1;
                        }
                        break;

                    case STATE_ACCESS:
                        if (remainingWaits > 0) {
                            // Stay in ACCESS
                            sigPREADY = 0;
                            remainingWaits--;
                            log("Wait State...", "text-slate-600");
                        } else {
                            // Ready to complete
                            sigPREADY = 1;
                            
                            // Check Error
                            if (document.getElementById('chk-error').checked) {
                                sigPSLVERR = 1;
                                log("Transfer Error (PSLVERR)!", "text-red-500");
                            } else {
                                sigPSLVERR = 0;
                                if (currentTx.type === 'READ') {
                                    sigPDATA = "0x5A"; // Simulated Read Data
                                    log("Read Data Valid: 0x5A", "text-green-400");
                                } else {
                                    log("Write Complete.", "text-green-400");
                                }
                            }
                            
                            // Check Queue for Back-to-Back
                            if (transferQueue.length > 0) {
                                currentTx = transferQueue.shift();
                                currentState = STATE_SETUP; // DIRECT TRANSITION TO SETUP
                                log(`ACCESS -> SETUP (Back-to-Back ${currentTx.type})`);
                                
                                // Immediate Signal Update for new Setup Phase
                                sigPENABLE = 0; // Deassert Enable
                                sigPSEL = 1;    // Keep Select High
                                sigPWRITE = currentTx.type === 'WRITE' ? 1 : 0;
                                sigPADDR = currentTx.addr;
                                sigPDATA = currentTx.type === 'WRITE' ? currentTx.data : "Z";
                                remainingWaits = waitCycles;
                            } else {
                                // Transition to IDLE
                                currentState = STATE_IDLE;
                                log("ACCESS -> IDLE");
                                currentTx = null;
                            }
                        }
                        break;
                }
            }

            updateVisuals();
            
            // Record History
            history.push({
                clk: clock,
                psel: sigPSEL,
                penable: sigPENABLE,
                pready: sigPREADY,
                pwrite: sigPWRITE,
                addr: sigPADDR,
                data: sigPDATA,
                err: sigPSLVERR
            });
            if (history.length > MAX_HISTORY) history.shift();

            drawWaveforms();
            
            // Slow down simulation loop for visibility
            setTimeout(() => requestAnimationFrame(step), 60); 
        }

        function updateVisuals() {
            // Update FSM SVG
            const states = ['idle', 'setup', 'access'];
            states.forEach((s, i) => {
                const node = document.getElementById(`state-${s}`).querySelector('circle');
                if (i === currentState) node.classList.add('state-active');
                else node.classList.remove('state-active');
            });

            // Transitions
            // Reset all
            document.querySelectorAll('.transition-line').forEach(l => l.classList.remove('transition-active'));
            
            if (currentState === STATE_SETUP && sigPENABLE === 0) {
                 // Entering Setup
                 // Could be from IDLE or ACCESS
                 // Since we don't have prev state var easily here, visual might flicker for B2B. 
                 // Simplified: If in SETUP, light up Idle->Setup path by default unless we track prev.
                 // Actually, let's light up based on queue
                 if(transferQueue.length > 0) document.getElementById('tr-idle-setup').classList.add('transition-active');
            }
            if (currentState === STATE_ACCESS) {
                // If moving to SETUP next frame (PREADY=1 && Queue>0)
                if (sigPREADY === 1 && transferQueue.length > 0) {
                     document.getElementById('tr-access-setup').classList.add('transition-active');
                }
                // If moving to IDLE next frame (PREADY=1 && Queue=0)
                else if (sigPREADY === 1 && transferQueue.length === 0) {
                     document.getElementById('tr-access-idle').classList.add('transition-active');
                }
                // Staying in ACCESS
                else if (sigPREADY === 0) {
                     document.getElementById('tr-access-access').classList.add('transition-active');
                }
                else {
                    // Just entered Access
                    document.getElementById('tr-setup-access').classList.add('transition-active');
                }
            }
        }

        function drawWaveforms() {
            if(!cvs.parentElement) return; // Safety check
            if(cvs.width !== cvs.parentElement.clientWidth) {
                cvs.width = cvs.parentElement.clientWidth;
                cvs.height = cvs.parentElement.clientHeight;
            }
            const w = cvs.width;
            const h = cvs.height;
            const step = w / MAX_HISTORY;

            ctx.clearRect(0,0,w,h);

            // Lanes Config
            const lanes = [
                { id: 'clk', label: 'PCLK', y: 30, color: '#94a3b8' },
                { id: 'psel', label: 'PSEL', y: 70, color: '#facc15' },
                { id: 'penable', label: 'PENABLE', y: 110, color: '#60a5fa' },
                { id: 'pready', label: 'PREADY', y: 150, color: '#4ade80' },
                { id: 'addr', label: 'PADDR', y: 190, color: '#ffffff', bus: true },
                { id: 'data', label: 'PDATA', y: 230, color: '#c084fc', bus: true },
                { id: 'err', label: 'PSLVERR', y: 270, color: '#ef4444' }
            ];

            lanes.forEach(l => {
                // Draw Label
                ctx.fillStyle = l.color;
                ctx.font = "10px monospace";
                ctx.fillText(l.label, 10, l.y - 10);

                if (!l.bus) {
                    // Binary Signal
                    ctx.strokeStyle = l.color;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    history.forEach((pt, i) => {
                        const val = pt[l.id]; // Access property by id
                        const x = i * step;
                        const y = val ? l.y - 10 : l.y + 10;
                        if(i===0) ctx.moveTo(x, y);
                        else {
                            const prevVal = history[i-1][l.id];
                            if(prevVal !== val) ctx.lineTo(x, val ? l.y+10 : l.y-10); // Vert line
                            ctx.lineTo(x, y);
                        }
                    });
                    ctx.stroke();
                } else {
                    // Bus Signal
                    ctx.strokeStyle = l.color;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    history.forEach((pt, i) => {
                        const val = pt[l.id];
                        const x = i * step;
                        const topY = l.y - 10;
                        const botY = l.y + 10;
                        
                        const valid = pt.psel; 
                        
                        if (valid) {
                            if (i>0 && history[i-1][l.id] !== val) {
                                // Transition cross
                                ctx.moveTo(x, topY); ctx.lineTo(x, botY);
                                ctx.moveTo(x, botY); ctx.lineTo(x, topY);
                            }
                            ctx.moveTo(x, topY); ctx.lineTo(x+step, topY);
                            ctx.moveTo(x, botY); ctx.lineTo(x+step, botY);
                            
                            // Text
                            if (i>0 && history[i-1][l.id] !== val) {
                                ctx.fillStyle = '#fff';
                                ctx.fillText(val, x+5, l.y+4);
                            }
                        } else {
                            // Z state - middle line
                            ctx.moveTo(x, l.y); ctx.lineTo(x+step, l.y);
                        }
                    });
                    ctx.stroke();
                }
            });
        }
        
        function resize() {
            if(cvs.parentElement) {
                cvs.width = cvs.parentElement.clientWidth;
                cvs.height = cvs.parentElement.clientHeight;
                drawWaveforms();
            }
        }
        window.addEventListener('resize', resize);
        // Initial resize check after slight delay to ensure DOM layout
        setTimeout(resize, 100);

        // Start
        step();

    </script>
</body>
</html>
