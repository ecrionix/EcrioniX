<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rocket Landing Simulator - EcrioniX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; overflow: hidden; touch-action: none; }
        .tech-font { font-family: 'Orbitron', sans-serif; }
        
        /* Watermark */
        .watermark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 8rem;
            font-weight: 900;
            color: rgba(99, 102, 241, 0.05);
            pointer-events: none;
            user-select: none;
            white-space: nowrap;
            z-index: 0;
        }

        #game-canvas {
            background: linear-gradient(to bottom, #020617 0%, #1e3a8a 80%, #0c4a6e 100%);
            width: 100%;
            height: 100%;
        }

        /* HUD */
        .hud-panel {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.2);
            backdrop-filter: blur(4px);
        }
        
        /* Controls */
        .btn-control {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.1s;
        }
        .btn-control:active {
            background: rgba(255,255,255,0.3);
            transform: scale(0.95);
        }
        .btn-thrust:active { background: #f59e0b; border-color: #f59e0b; }

    </style>
</head>
<body class="relative h-screen w-screen">

    <div class="watermark">EcrioniX Space</div>

    <canvas id="game-canvas"></canvas>

    <!-- Start Overlay (Required for Audio Context) -->
    <div id="start-overlay" class="absolute inset-0 bg-black/90 z-50 flex flex-col items-center justify-center cursor-pointer transition-opacity duration-500">
        <h1 class="text-6xl font-bold text-white tech-font mb-4 tracking-widest">FALCON LANDER</h1>
        <div class="animate-pulse text-indigo-400 text-xl font-mono border border-indigo-500 px-6 py-2 rounded">CLICK TO START MISSION</div>
        <div class="mt-8 text-slate-500 text-sm max-w-md text-center">
            <p>Use <strong>ARROW KEYS</strong> to control descent.</p>
            <p class="mt-1">Audio Enabled.</p>
        </div>
    </div>

    <!-- HUD -->
    <div class="absolute top-4 left-4 p-4 rounded-xl hud-panel w-64 pointer-events-none">
        <h1 class="text-xl font-bold text-white tech-font mb-2">TELEMETRY</h1>
        <div class="grid grid-cols-2 gap-2 text-xs font-mono">
            <div class="text-slate-400">ALTITUDE</div>
            <div id="hud-alt" class="text-right text-white">0 m</div>
            
            <div class="text-slate-400">VELOCITY Y</div>
            <div id="hud-vy" class="text-right text-white">0 m/s</div>
            
            <div class="text-slate-400">VELOCITY X</div>
            <div id="hud-vx" class="text-right text-white">0 m/s</div>
            
            <div class="text-slate-400">FUEL</div>
            <div class="text-right">
                <div class="w-full bg-slate-700 h-2 rounded-full mt-1">
                    <div id="hud-fuel" class="bg-green-500 h-2 rounded-full" style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mute Button -->
    <button id="btn-mute" class="absolute top-4 right-4 p-3 bg-slate-800/80 rounded-full border border-slate-600 text-white hover:bg-slate-700 transition z-40">
        üîä
    </button>

    <!-- Status Message -->
    <div id="status-msg" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-center hidden z-40">
        <h2 id="status-title" class="text-5xl font-bold text-white tech-font mb-2 drop-shadow-lg">LANDED</h2>
        <p id="status-sub" class="text-xl text-slate-200">Perfect Touchdown!</p>
        <button onclick="resetGameWithSound()" class="mt-6 px-8 py-3 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-bold shadow-lg transition pointer-events-auto">RETRY MISSION</button>
    </div>

    <!-- Mobile Controls -->
    <div class="absolute bottom-6 left-6 right-6 flex justify-between items-end md:hidden z-40">
        <div class="flex gap-4">
            <button id="btn-left" class="btn-control w-16 h-16 rounded-full text-2xl text-white">‚Üê</button>
            <button id="btn-right" class="btn-control w-16 h-16 rounded-full text-2xl text-white">‚Üí</button>
        </div>
        <button id="btn-thrust" class="btn-control w-20 h-20 rounded-full text-xl font-bold border-2 border-yellow-500/50 text-yellow-400 btn-thrust">
            BURN
        </button>
    </div>

    <!-- Instructions (Desktop) -->
    <div class="absolute bottom-6 right-6 text-right hidden md:block text-slate-400 text-xs pointer-events-none">
        <p><strong>UP ARROW</strong> - Main Engine</p>
        <p><strong>LEFT / RIGHT</strong> - RCS Thrusters</p>
    </div>

    <script>
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        
        // --- Game State ---
        let width, height;
        let gameState = 'IDLE'; // IDLE, PLAYING, LANDED, CRASHED
        
        // Physics Constants
        const GRAVITY = 0.05;
        const THRUST_POWER = 0.15;
        const ROTATION_SPEED = 0.02;
        const RCS_POWER = 0.02;
        const DRAG = 0.99;

        // Rocket Object
        const rocket = {
            x: 0, y: 0,
            vx: 0, vy: 0,
            angle: 0,
            width: 20, height: 100,
            fuel: 100,
            legsDeployed: false,
            thrusting: false,
            rotatingLeft: false,
            rotatingRight: false
        };

        // Drone Ship
        const ship = {
            x: 0, y: 0,
            width: 200, height: 20
        };

        // Particles (Smoke/Fire)
        let particles = [];

        // --- Audio System ---
        let audioCtx = null;
        let masterGain = null;
        let thrustOsc = null;
        let thrustNoiseNode = null;
        let thrustGain = null;
        let isMuted = false;
        let noiseBuffer = null;

        function initAudio() {
            if (audioCtx) return;
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            
            masterGain = audioCtx.createGain();
            masterGain.gain.value = 0.3; // Master Volume
            masterGain.connect(audioCtx.destination);

            // Generate global noise buffer
            const bufferSize = audioCtx.sampleRate * 2; // 2 sec buffer
            noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = noiseBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }

            // Engine Rumble Setup
            thrustNoiseNode = audioCtx.createBufferSource();
            thrustNoiseNode.buffer = noiseBuffer;
            thrustNoiseNode.loop = true;
            
            // Filter for rumble effect
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 800;

            thrustGain = audioCtx.createGain();
            thrustGain.gain.value = 0;

            thrustNoiseNode.connect(filter);
            filter.connect(thrustGain);
            thrustGain.connect(masterGain);
            thrustNoiseNode.start();
        }

        function setThrustVolume(active) {
            if (!audioCtx || isMuted) return;
            const now = audioCtx.currentTime;
            const target = active ? 0.8 : 0;
            thrustGain.gain.setTargetAtTime(target, now, 0.1);
        }

        function playSound(type) {
            if (!audioCtx || isMuted) return;
            const now = audioCtx.currentTime;

            if (type === 'explosion') {
                // COMPLEX EXPLOSION SOUND
                // 1. Noise Burst (The Crunch)
                const noise = audioCtx.createBufferSource();
                noise.buffer = noiseBuffer;
                
                const noiseFilter = audioCtx.createBiquadFilter();
                noiseFilter.type = 'lowpass';
                noiseFilter.frequency.setValueAtTime(1000, now);
                noiseFilter.frequency.exponentialRampToValueAtTime(100, now + 1);

                const noiseGain = audioCtx.createGain();
                noiseGain.gain.setValueAtTime(1, now);
                noiseGain.gain.exponentialRampToValueAtTime(0.01, now + 1.5);

                noise.connect(noiseFilter);
                noiseFilter.connect(noiseGain);
                noiseGain.connect(masterGain);
                noise.start();

                // 2. Sub-bass Oscillator (The Thud)
                const subOsc = audioCtx.createOscillator();
                subOsc.type = 'triangle';
                subOsc.frequency.setValueAtTime(80, now);
                subOsc.frequency.exponentialRampToValueAtTime(10, now + 1);

                const subGain = audioCtx.createGain();
                subGain.gain.setValueAtTime(0.8, now);
                subGain.gain.exponentialRampToValueAtTime(0.01, now + 1);

                subOsc.connect(subGain);
                subGain.connect(masterGain);
                subOsc.start();
                subOsc.stop(now + 1.5);

            } else if (type === 'success') {
                // Success Chime
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(masterGain);

                osc.type = 'sine';
                osc.frequency.setValueAtTime(440, now); 
                osc.frequency.setValueAtTime(554, now + 0.1); 
                osc.frequency.setValueAtTime(659, now + 0.2); 
                
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.5, now + 0.1);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 1.5);
                
                osc.start();
                osc.stop(now + 1.5);
            } else if (type === 'reset') {
                // Mechanical Latch Sound for Retry
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(masterGain);
                
                osc.type = 'square';
                osc.frequency.setValueAtTime(200, now);
                osc.frequency.exponentialRampToValueAtTime(50, now + 0.1);
                
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                
                osc.start();
                osc.stop(now + 0.1);
            }
        }
        
        document.getElementById('btn-mute').addEventListener('click', () => {
            isMuted = !isMuted;
            document.getElementById('btn-mute').innerText = isMuted ? 'üîá' : 'üîä';
            if(audioCtx && isMuted) {
                masterGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.1);
            } else if (audioCtx && !isMuted) {
                masterGain.gain.setTargetAtTime(0.3, audioCtx.currentTime, 0.1);
            }
        });

        // --- Init ---
        function init() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;

            // Reset Rocket
            rocket.x = width / 2;
            rocket.y = 100;
            rocket.vx = (Math.random() - 0.5) * 4; // Random initial drift
            rocket.vy = 2; // Initial drop speed
            rocket.angle = (Math.random() - 0.5) * 0.5; // Random initial tilt
            rocket.fuel = 100;
            rocket.legsDeployed = false;
            rocket.thrusting = false;

            // Position Ship
            ship.x = width / 2 - ship.width / 2;
            ship.y = height - 50;

            gameState = 'PLAYING';
            particles = [];
            
            document.getElementById('status-msg').classList.add('hidden');
        }

        // --- UI Interactions ---
        const overlay = document.getElementById('start-overlay');
        overlay.addEventListener('click', () => {
            initAudio();
            overlay.style.opacity = 0;
            setTimeout(() => overlay.remove(), 500);
            init();
            loop();
        });

        function resetGame() {
            init();
        }

        function resetGameWithSound() {
            playSound('reset');
            init();
        }

        // --- Inputs ---
        window.addEventListener('keydown', (e) => {
            if (gameState !== 'PLAYING') return;
            if (e.code === 'ArrowUp' || e.code === 'Space') { rocket.thrusting = true; setThrustVolume(true); }
            if (e.code === 'ArrowLeft') rocket.rotatingLeft = true;
            if (e.code === 'ArrowRight') rocket.rotatingRight = true;
        });

        window.addEventListener('keyup', (e) => {
            if (e.code === 'ArrowUp' || e.code === 'Space') { rocket.thrusting = false; setThrustVolume(false); }
            if (e.code === 'ArrowLeft') rocket.rotatingLeft = false;
            if (e.code === 'ArrowRight') rocket.rotatingRight = false;
        });

        // Touch/Mouse for Mobile
        const btnThrust = document.getElementById('btn-thrust');
        const btnLeft = document.getElementById('btn-left');
        const btnRight = document.getElementById('btn-right');

        const addTouch = (el, prop) => {
            const start = (e) => { 
                e.preventDefault(); 
                rocket[prop] = true; 
                if(prop === 'thrusting') setThrustVolume(true);
            };
            const end = (e) => { 
                e.preventDefault(); 
                rocket[prop] = false; 
                if(prop === 'thrusting') setThrustVolume(false);
            };
            el.addEventListener('touchstart', start);
            el.addEventListener('touchend', end);
            el.addEventListener('mousedown', start);
            el.addEventListener('mouseup', end);
        };
        addTouch(btnThrust, 'thrusting');
        addTouch(btnLeft, 'rotatingLeft');
        addTouch(btnRight, 'rotatingRight');

        // --- Physics Engine ---
        function update() {
            if (gameState !== 'PLAYING') {
                setThrustVolume(false); // Cut sound if crashed/landed
                return;
            }

            // Gravity
            rocket.vy += GRAVITY;

            // Thrust
            if (rocket.thrusting && rocket.fuel > 0) {
                rocket.fuel -= 0.3;
                rocket.vx += Math.sin(rocket.angle) * THRUST_POWER; 
                rocket.vy -= Math.cos(rocket.angle) * THRUST_POWER;

                // Particles
                createParticles(10, 'fire');
            } else {
                 if (rocket.thrusting && rocket.fuel <= 0) setThrustVolume(false);
            }

            // RCS (Rotation)
            if (rocket.rotatingLeft) {
                rocket.angle -= ROTATION_SPEED;
                rocket.fuel -= 0.05;
                createParticles(1, 'rcs-left');
            }
            if (rocket.rotatingRight) {
                rocket.angle += ROTATION_SPEED;
                rocket.fuel -= 0.05;
                createParticles(1, 'rcs-right');
            }

            // Air Resistance
            rocket.vx *= DRAG;

            // Position
            rocket.x += rocket.vx;
            rocket.y += rocket.vy;

            // Deploy Legs if close
            if (rocket.y > height - 200) {
                rocket.legsDeployed = true;
            }

            // Collision Detection
            checkCollision();
            
            // Particle Updates
            particles.forEach((p, i) => {
                p.x += p.vx;
                p.y += p.vy;
                p.life--;
                if(p.life <= 0) particles.splice(i, 1);
            });
        }

        function checkCollision() {
            const groundY = ship.y;
            const rocketBottom = rocket.y + 50; 

            // Water hit
            if (rocketBottom >= height) {
                gameState = 'CRASHED';
                showStatus('SPLASHDOWN', 'Rocket lost at sea.', 'text-blue-400');
                createParticles(100, 'splash');
                playSound('explosion');
                return;
            }

            if (rocketBottom >= groundY && rocket.x > ship.x && rocket.x < ship.x + ship.width) {
                // Check Horizontal alignment with Ship
                
                // Check Speed and Angle
                const safeSpeed = Math.abs(rocket.vy) < 2.5 && Math.abs(rocket.vx) < 1.5;
                const safeAngle = Math.abs(rocket.angle) < 0.2; // ~11 degrees

                if (safeSpeed && safeAngle) {
                    gameState = 'LANDED';
                    showStatus('TOUCHDOWN', 'The Falcon has landed.', 'text-green-500');
                    rocket.y = groundY - 50; // Snap to deck
                    rocket.vy = 0;
                    rocket.vx = 0;
                    rocket.angle = 0;
                    playSound('success');
                } else {
                    gameState = 'CRASHED';
                    showStatus('RUD', 'Rapid Unscheduled Disassembly.', 'text-red-500');
                    createParticles(100, 'explosion');
                    playSound('explosion');
                }
            }
        }

        // --- Rendering ---
        function draw() {
            // Clear
            ctx.clearRect(0, 0, width, height);

            // 1. Draw Ocean
            ctx.fillStyle = '#0f172a'; // Deep water
            ctx.fillRect(0, height-20, width, 20);

            // 2. Draw Drone Ship
            ctx.fillStyle = '#334155';
            ctx.fillRect(ship.x, ship.y, ship.width, ship.height);
            // "X" mark
            ctx.strokeStyle = '#facc15';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(ship.x + ship.width/2 - 20, ship.y + 5);
            ctx.lineTo(ship.x + ship.width/2 + 20, ship.y + 15);
            ctx.moveTo(ship.x + ship.width/2 + 20, ship.y + 5);
            ctx.lineTo(ship.x + ship.width/2 - 20, ship.y + 15);
            ctx.stroke();

            // 3. Draw Particles
            particles.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.globalAlpha = p.life / 50;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
                ctx.fill();
                ctx.globalAlpha = 1;
            });

            // 4. Draw Rocket
            if (gameState !== 'CRASHED') {
                ctx.save();
                ctx.translate(rocket.x, rocket.y);
                ctx.rotate(rocket.angle);

                // Body
                ctx.fillStyle = '#e2e8f0'; // White
                ctx.fillRect(-10, -50, 20, 100);
                
                // Nose cone (Fairing?)
                ctx.beginPath();
                ctx.moveTo(-10, -50);
                ctx.lineTo(0, -70);
                ctx.lineTo(10, -50);
                ctx.fill();

                // Grid Fins
                ctx.fillStyle = '#1e293b';
                ctx.fillRect(-14, -40, 4, 8); // Left
                ctx.fillRect(10, -40, 4, 8);  // Right

                // Landing Legs
                if (rocket.legsDeployed) {
                    ctx.strokeStyle = '#1e293b';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(-10, 40);
                    ctx.lineTo(-25, 60);
                    ctx.moveTo(10, 40);
                    ctx.lineTo(25, 60);
                    ctx.stroke();
                }

                // Engine Bell
                ctx.fillStyle = '#334155';
                ctx.beginPath();
                ctx.moveTo(-5, 50);
                ctx.lineTo(5, 50);
                ctx.lineTo(8, 55);
                ctx.lineTo(-8, 55);
                ctx.fill();

                // Thrust Flame
                if (rocket.thrusting && rocket.fuel > 0) {
                    ctx.fillStyle = `rgba(255, ${Math.random()*100+100}, 0, 0.8)`;
                    ctx.beginPath();
                    ctx.moveTo(-5, 55);
                    ctx.lineTo(5, 55);
                    ctx.lineTo(0, 55 + Math.random()*40 + 20);
                    ctx.fill();
                }

                ctx.restore();
            }

            // Update HUD
            document.getElementById('hud-alt').innerText = Math.max(0, Math.floor((ship.y - (rocket.y+50)))).toFixed(0) + " m";
            document.getElementById('hud-vy').innerText = (rocket.vy * -10).toFixed(1) + " m/s"; 
            document.getElementById('hud-vx').innerText = (rocket.vx * 10).toFixed(1) + " m/s";
            
            const fuelEl = document.getElementById('hud-fuel');
            fuelEl.style.width = rocket.fuel + "%";
            if(rocket.fuel < 20) fuelEl.classList.replace('bg-green-500', 'bg-red-500');
        }

        function createParticles(count, type) {
            for(let i=0; i<count; i++) {
                let p = {
                    x: rocket.x, 
                    y: rocket.y + 50, 
                    life: 30 + Math.random() * 20,
                    size: Math.random() * 4 + 2,
                    vx: (Math.random() - 0.5) * 2,
                    vy: 2 + Math.random() * 2,
                    color: `rgba(255, ${Math.floor(Math.random()*200)}, 0, 1)`
                };

                if (type === 'explosion') {
                    p.x = rocket.x;
                    p.y = rocket.y;
                    p.vx = (Math.random() - 0.5) * 10;
                    p.vy = (Math.random() - 0.5) * 10;
                    p.life = 100;
                    p.color = Math.random() > 0.5 ? '#ef4444' : '#fbbf24';
                }
                else if (type === 'splash') {
                    p.x = rocket.x;
                    p.y = height;
                    p.vx = (Math.random() - 0.5) * 10;
                    p.vy = -Math.random() * 10;
                    p.life = 60;
                    p.color = '#38bdf8';
                }
                else if (type === 'rcs-left') {
                    p.y = rocket.y - 40;
                    p.x = rocket.x + 10;
                    p.vx = 2; 
                    p.vy = (Math.random() - 0.5);
                    p.color = '#fff';
                    p.size = 2;
                }
                else if (type === 'rcs-right') {
                    p.y = rocket.y - 40;
                    p.x = rocket.x - 10;
                    p.vx = -2;
                    p.vy = (Math.random() - 0.5);
                    p.color = '#fff';
                    p.size = 2;
                }

                particles.push(p);
            }
        }

        function showStatus(title, sub, colorClass) {
            document.getElementById('status-title').innerText = title;
            document.getElementById('status-title').className = `text-5xl font-bold tech-font mb-2 drop-shadow-lg ${colorClass}`;
            document.getElementById('status-sub').innerText = sub;
            document.getElementById('status-msg').classList.remove('hidden');
        }

        // --- Loop ---
        function loop() {
            if(gameState !== 'IDLE') {
                update();
                draw();
            }
            requestAnimationFrame(loop);
        }

        window.addEventListener('resize', init);
        init();
        loop();

    </script>
</body>
</html>
