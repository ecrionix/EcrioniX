<!DOCTYPE html>
<html lang="en">
<head>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6672302762343789"
     crossorigin="anonymous"></script>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXZS8C1FLY"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XXZS8C1FLY');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase Locked Loop (PLL) Lab - EcrioniX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Orbitron:wght@500;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <!-- MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #020617; color: #f8fafc; overflow: hidden; }
        .tech-font { font-family: 'Orbitron', sans-serif; }
        .mono-font { font-family: 'JetBrains Mono', monospace; }

        .watermark {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 8rem; font-weight: 900; color: rgba(99, 102, 241, 0.03);
            pointer-events: none; user-select: none; z-index: 0;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px;
        }

        /* Tabs */
        .tab-btn {
            @apply px-4 py-2 text-xs font-bold rounded-lg transition-all border border-transparent text-slate-400 uppercase tracking-wider;
        }
        .tab-active {
            @apply bg-indigo-600 text-white border-indigo-500 shadow-lg shadow-indigo-500/30;
        }

        /* Schematic Components */
        .block-box { fill: #1e293b; stroke: #94a3b8; stroke-width: 2; transition: all 0.3s; }
        .block-active { stroke: #fbbf24; filter: drop-shadow(0 0 5px #fbbf24); }
        .wire { fill: none; stroke: #475569; stroke-width: 2.5; stroke-linecap: round; stroke-linejoin: round; transition: stroke 0.1s; }
        .wire-active { stroke: #fbbf24; filter: drop-shadow(0 0 3px #fbbf24); }
        .wire-signal { stroke: #4ade80; }

        /* Waveform */
        .wave-canvas { background: #0b0f19; border: 1px solid #334155; border-radius: 6px; }

        input[type=range] { accent-color: #6366f1; }

        /* Theory Styles */
        .prose h1 { @apply text-3xl font-bold text-white mb-6 tech-font border-b border-slate-800 pb-2; }
        .prose h2 { @apply text-xl font-bold text-indigo-400 mt-8 mb-4 uppercase tracking-wider; }
        .prose p { @apply text-slate-400 mb-4 leading-relaxed; }
        .prose strong { @apply text-white font-semibold; }
        .prose ul { @apply list-disc list-inside space-y-2 text-slate-400 mb-4; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col relative">

    <div class="watermark">EcrioniX Logic</div>

    <!-- Header -->
    <nav class="border-b border-slate-800 bg-slate-900/80 px-6 py-4 flex justify-between items-center z-20">
        <div>
            <h1 class="text-2xl font-bold text-indigo-400 tech-font uppercase">PHASE LOCKED <span class="text-white">LOOP</span></h1>
            <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Clock Synthesis & Synchronization</p>
        </div>
        
        <div class="flex bg-slate-950 p-1 rounded-xl border border-slate-800">
            <button onclick="switchView('theory')" id="btn-theory" class="tab-btn tab-active">Theory Guide</button>
            <button onclick="switchView('lab')" id="btn-lab" class="tab-btn">Simulation Lab</button>
        </div>

        <button onclick="window.history.back()" class="group flex items-center text-slate-400 hover:text-white transition bg-slate-800/80 px-4 py-2 rounded-lg border border-slate-700 hover:border-indigo-500">
            <span class="text-xs font-bold uppercase">Exit Lab</span>
        </button>
    </nav>

    <!-- Content -->
    <div class="flex-grow relative overflow-hidden">

        <!-- THEORY VIEW -->
        <div id="view-theory" class="absolute inset-0 z-10 overflow-y-auto p-8 flex justify-center">
            <div class="max-w-4xl w-full glass-panel p-10 prose">
                <h1>Understanding Phase Locked Loops (PLL)</h1>
                <p>
                    A **Phase Locked Loop (PLL)** is a control system that generates an output signal whose phase is related to the phase of an input signal. It is a fundamental building block in modern electronics, used for frequency synthesis, clock recovery, and synchronization.
                </p>

                <h2>1. Core Architecture</h2>
                <p>
                    A basic PLL consists of four main components connected in a negative feedback loop:
                </p>
                <ul>
                    <li><strong>Phase Detector (PD) / Phase Frequency Detector (PFD):</strong> Compares the phase/frequency of the reference clock ($f_{ref}$) with the feedback clock ($f_{fb}$). It outputs an error signal (UP/DOWN pulses) proportional to the phase difference.</li>
                    <li><strong>Charge Pump (CP):</strong> Converts the digital UP/DOWN pulses from the PFD into analog current pulses.</li>
                    <li><strong>Loop Filter (LF):</strong> A low-pass filter (usually RC) that integrates the current from the charge pump to produce a smooth Control Voltage ($V_{ctrl}$). This voltage determines the stability and bandwidth of the loop.</li>
                    <li><strong>Voltage Controlled Oscillator (VCO):</strong> Generates an output frequency ($f_{out}$) proportional to the input Control Voltage. Higher voltage usually means higher frequency.</li>
                    <li><strong>Feedback Divider ($1/N$):</strong> Divides the high-frequency output of the VCO down to match the reference frequency range. This allows the PLL to multiply the reference frequency ($f_{out} = N \times f_{ref}$).</li>
                </ul>

                <h2>2. How Locking Works</h2>
                <p>
                    The PLL operates by constantly adjusting the VCO frequency to minimize the phase error.
                </p>
                <ul>
                    <li>If $f_{fb} < f_{ref}$ (VCO too slow), the PFD generates "UP" pulses. The Charge Pump adds charge to the Loop Filter, increasing $V_{ctrl}$. The VCO speeds up.</li>
                    <li>If $f_{fb} > f_{ref}$ (VCO too fast), the PFD generates "DOWN" pulses. The Charge Pump removes charge, decreasing $V_{ctrl}$. The VCO slows down.</li>
                    <li><strong>Lock State:</strong> When the phase and frequency of the feedback signal match the reference, the error becomes zero (or constant), $V_{ctrl}$ stabilizes, and the PLL is "Locked".</li>
                </ul>

                <h2>3. Applications</h2>
                <p>
                    PLLs are ubiquitous in digital systems:
                </p>
                <ul>
                    <li><strong>Clock Generation:</strong> Generating a GHz-range CPU clock from a low-frequency (e.g., 25MHz) crystal oscillator.</li>
                    <li><strong>Clock Deskewing:</strong> Aligning internal chip clocks with external system clocks to eliminate distribution delays.</li>
                    <li><strong>SerDes (Serializer/Deserializer):</strong> Recovering clock data from high-speed serial data streams (e.g., PCIe, USB, Ethernet).</li>
                    <li><strong>Frequency Modulation/Demodulation:</strong> Used in radio communications.</li>
                </ul>

                <h2>4. Key Performance Metrics</h2>
                <ul>
                    <li><strong>Lock Time:</strong> How long it takes to reach a stable frequency after startup or a frequency change.</li>
                    <li><strong>Jitter:</strong> Short-term variations in the output clock period. Low jitter is crucial for high-speed data.</li>
                    <li><strong>Phase Noise:</strong> Frequency domain representation of jitter.</li>
                    <li><strong>Bandwidth:</strong> Determines the loop's response speed and ability to filter reference noise.</li>
                </ul>

                <div class="mt-8 text-center">
                    <button onclick="switchView('lab')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-8 py-3 rounded-xl font-bold transition shadow-lg shadow-indigo-500/20">Launch PLL Simulation &rarr;</button>
                </div>
            </div>
        </div>

        <!-- LAB VIEW -->
        <div id="view-lab" class="absolute inset-0 z-0 opacity-0 pointer-events-none flex p-6 gap-6">
            
            <!-- Left: Controls -->
            <div class="w-80 flex flex-col gap-4 overflow-y-auto pr-2">
                <div class="glass-panel p-6">
                    <h2 class="text-indigo-400 font-bold mb-4 uppercase text-[10px] tracking-widest">PLL Configuration</h2>
                    
                    <div class="space-y-6">
                        <!-- Reference Frequency -->
                        <div>
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-slate-300">Reference Freq ($f_{ref}$)</span>
                                <span id="val-ref" class="font-mono text-white font-bold">10 MHz</span>
                            </div>
                            <input type="range" id="slider-ref" min="5" max="25" step="1" value="10" class="w-full">
                        </div>

                        <!-- Divider N -->
                        <div>
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-slate-300">Feedback Divider ($N$)</span>
                                <span id="val-n" class="font-mono text-yellow-400 font-bold">4</span>
                            </div>
                            <input type="range" id="slider-n" min="1" max="16" step="1" value="4" class="w-full">
                        </div>
                        
                         <!-- Loop Filter Bandwidth (Simplification) -->
                        <div>
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-slate-300">Loop Response Speed</span>
                                <span id="val-bw" class="font-mono text-blue-400 font-bold">Medium</span>
                            </div>
                            <input type="range" id="slider-bw" min="1" max="5" step="1" value="3" class="w-full">
                        </div>

                        <button onclick="resetSim()" class="w-full py-2 bg-red-900/30 text-red-400 border border-red-800 rounded text-xs font-bold hover:bg-red-900/50">RESET PLL</button>
                    </div>
                </div>

                <!-- Stats -->
                <div class="glass-panel p-6 flex-grow">
                    <h2 class="text-emerald-400 font-bold mb-4 uppercase text-[10px] tracking-widest">Loop Status</h2>
                    <div class="space-y-3">
                        <div class="bg-black/40 p-3 rounded border border-slate-800">
                            <div class="text-[10px] text-slate-500 uppercase">Target Frequency</div>
                            <div id="stat-target" class="text-white font-mono font-bold">40 MHz</div>
                        </div>
                        <div class="bg-black/40 p-3 rounded border border-slate-800">
                            <div class="text-[10px] text-slate-500 uppercase">VCO Output</div>
                            <div id="stat-vco" class="text-emerald-400 font-mono font-bold">0 MHz</div>
                        </div>
                        <div class="bg-black/40 p-3 rounded border border-slate-800 flex justify-between items-center">
                            <div class="text-[10px] text-slate-500 uppercase">Lock Status</div>
                            <div id="stat-lock" class="text-red-500 font-bold text-xs px-2 py-1 bg-red-900/20 rounded border border-red-900/50">UNLOCKED</div>
                        </div>
                         <div class="bg-black/40 p-3 rounded border border-slate-800">
                            <div class="text-[10px] text-slate-500 uppercase">Control Voltage</div>
                            <div class="w-full h-2 bg-slate-800 rounded-full mt-2 relative overflow-hidden">
                                <div id="bar-vctrl" class="absolute h-full bg-indigo-500 transition-all duration-100" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Visualization -->
            <div class="flex-grow flex flex-col gap-6">
                
                <!-- Schematic -->
                <div class="glass-panel p-1 relative flex-grow overflow-hidden flex items-center justify-center bg-slate-900/50">
                    <div class="absolute top-4 left-4 text-[10px] text-slate-500 font-bold uppercase tracking-widest bg-black/60 px-2 py-1 rounded">Architecture</div>
                    
                    <div id="schematic-container" class="w-full h-full flex items-center justify-center p-4">
                        <svg id="svg-circuit" width="800" height="400" viewBox="0 0 800 400">
                            <!-- Reference Clock Input -->
                            <text x="50" y="145" fill="#fbbf24" font-size="12" font-weight="bold">REF CLK</text>
                            <line x1="100" y1="140" x2="200" y2="140" class="wire" id="wire-ref" />

                            <!-- PFD -->
                            <rect x="200" y="100" width="80" height="80" class="block-box" id="blk-pfd" />
                            <text x="240" y="145" text-anchor="middle" class="gate-text" fill="#cbd5e1" font-size="12">PFD</text>

                            <!-- Charge Pump & Loop Filter -->
                            <line x1="280" y1="140" x2="350" y2="140" class="wire" id="wire-err" /> <!-- Error Signal -->
                            <text x="315" y="130" text-anchor="middle" fill="#64748b" font-size="10">UP/DN</text>
                            
                            <rect x="350" y="110" width="100" height="60" class="block-box" id="blk-lf" />
                            <text x="400" y="145" text-anchor="middle" class="gate-text" fill="#cbd5e1" font-size="12">FILTER</text>

                            <!-- Control Voltage to VCO -->
                            <line x1="450" y1="140" x2="550" y2="140" class="wire" id="wire-vctrl" />
                            <text x="500" y="130" text-anchor="middle" fill="#818cf8" font-size="10">V_CTRL</text>

                            <!-- VCO -->
                            <rect x="550" y="100" width="80" height="80" class="block-box" id="blk-vco" />
                            <text x="590" y="145" text-anchor="middle" class="gate-text" fill="#cbd5e1" font-size="12">VCO</text>

                            <!-- Output -->
                            <line x1="630" y1="140" x2="750" y2="140" class="wire" id="wire-out" />
                            <text x="760" y="145" fill="#4ade80" font-size="14" font-weight="bold">CLK_OUT</text>

                            <!-- Feedback Path -->
                            <path d="M680,140 V300 H450" class="wire" />
                            
                            <!-- Divider -->
                            <rect x="350" y="270" width="100" height="60" class="block-box" id="blk-div" />
                            <text x="400" y="305" text-anchor="middle" class="gate-text" fill="#cbd5e1" font-size="12">รท N</text>
                            
                            <!-- Feedback to PFD -->
                            <path d="M350,300 H240 V180" class="wire" id="wire-fb" />
                            <text x="180" y="295" fill="#3b82f6" font-size="12" font-weight="bold">FB CLK</text>
                            
                        </svg>
                    </div>
                </div>

                <!-- Waveforms -->
                <div class="glass-panel p-4 h-64 bg-gray-900 border border-slate-800 flex flex-col">
                    <div class="flex justify-between items-center mb-2 px-2">
                        <span class="text-[10px] font-bold text-slate-500 uppercase">Signal Analyzer</span>
                        <div class="flex gap-4 text-[10px] font-mono">
                            <span class="text-yellow-400">REF</span>
                            <span class="text-blue-400">FEEDBACK</span>
                            <span class="text-green-400">OUTPUT</span>
                        </div>
                    </div>
                    <div class="flex-grow relative bg-[#0b0f19] rounded overflow-hidden">
                        <canvas id="waveCanvas" class="w-full h-full"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- State ---
        let refFreq = 10; // MHz
        let divN = 4;
        let loopSpeed = 0.05; // gain

        let vcoFreq = 0; // Current VCO Output Freq
        let vCtrl = 0;   // Control Voltage (0-1)
        
        let simTime = 0;
        let phaseRef = 0;
        let phaseFb = 0;
        let phaseOut = 0;
        
        const history = [];
        const MAX_HISTORY = 400;

        // DOM
        const sRef = document.getElementById('slider-ref');
        const sN = document.getElementById('slider-n');
        const sBw = document.getElementById('slider-bw');
        const canvas = document.getElementById('waveCanvas');
        const ctx = canvas.getContext('2d');
        const statLock = document.getElementById('stat-lock');
        const barVctrl = document.getElementById('bar-vctrl');

        // Schematic Wires
        const wRef = document.getElementById('wire-ref');
        const wFb = document.getElementById('wire-fb');
        const wOut = document.getElementById('wire-out');
        const wVctrl = document.getElementById('wire-vctrl');

        // --- Logic ---
        function switchView(v) {
            const theory = document.getElementById('view-theory');
            const lab = document.getElementById('view-lab');
            const btnT = document.getElementById('btn-theory');
            const btnL = document.getElementById('btn-lab');

            if (v === 'theory') {
                theory.classList.remove('opacity-0', 'pointer-events-none'); theory.classList.add('z-10');
                lab.classList.add('opacity-0', 'pointer-events-none'); lab.classList.remove('z-10');
                btnT.classList.add('tab-active'); btnL.classList.remove('tab-active');
            } else {
                lab.classList.remove('opacity-0', 'pointer-events-none'); lab.classList.add('z-10');
                theory.classList.add('opacity-0', 'pointer-events-none'); theory.classList.remove('z-10');
                btnL.classList.add('tab-active'); btnT.classList.remove('tab-active');
                resize();
            }
        }

        sRef.addEventListener('input', (e) => {
            refFreq = parseInt(e.target.value);
            document.getElementById('val-ref').innerText = refFreq + " MHz";
            updateTarget();
        });

        sN.addEventListener('input', (e) => {
            divN = parseInt(e.target.value);
            document.getElementById('val-n').innerText = divN;
            updateTarget();
        });

        sBw.addEventListener('input', (e) => {
            loopSpeed = parseInt(e.target.value) * 0.02; // Adjust response speed
        });

        function updateTarget() {
            const target = refFreq * divN;
            document.getElementById('stat-target').innerText = target + " MHz";
        }

        function resetSim() {
            vcoFreq = 0;
            vCtrl = 0;
            history.length = 0;
            updateTarget();
        }

        // --- Physics Loop ---
        function step() {
            simTime++;
            
            // 1. Reference Clock
            // freq to phase increment: dPhi = 2*PI * f * dt
            // Let's abstract: step = freq * scale
            const refStep = refFreq * 0.05;
            phaseRef += refStep;

            // 2. Feedback Clock (Output / N)
            // Current Output Freq
            const outStep = vcoFreq * 0.05;
            phaseOut += outStep;
            
            // Feedback is Output divided by N
            // Phase of FB tracks Phase of Out / N? No, Freq divides.
            // So FB Step = Out Step / N
            const fbStep = outStep / divN;
            phaseFb += fbStep;

            // 3. Phase Detector (Simplified Model)
            // Error proportional to freq difference + phase difference
            // Target Freq = Ref * N
            const targetFreq = refFreq * divN;
            
            // Simple P-Controller behavior for simulation visual
            // Error = Target - Current
            const error = targetFreq - vcoFreq;
            
            // Apply Loop Filter (Integration/Smoothing)
            // vCtrl moves towards ideal required voltage
            // Assume linear VCO: F = K * V
            // We just nudge vcoFreq towards target based on loopSpeed
            
            // Simulate realistic "hunting" or damping
            vcoFreq += error * loopSpeed; 
            
            // Update V_ctrl visual (0-100% of max range)
            // Max range in sim is say 25*16 = 400 MHz.
            const vCtrlPct = Math.min(100, (vcoFreq / 400) * 100);
            barVctrl.style.width = `${vCtrlPct}%`;

            // Lock Detection
            // If error is small
            if (Math.abs(error) < 1.0) {
                statLock.innerText = "LOCKED";
                statLock.className = "text-green-500 font-bold text-xs px-2 py-1 bg-green-900/20 rounded border border-green-900/50";
            } else {
                statLock.innerText = "ACQUIRING...";
                statLock.className = "text-yellow-500 font-bold text-xs px-2 py-1 bg-yellow-900/20 rounded border border-yellow-900/50 animate-pulse";
            }
            
            document.getElementById('stat-vco').innerText = vcoFreq.toFixed(1) + " MHz";

            // Visual Updates
            // Blink wires based on phase (Square wave approximation)
            const refVal = Math.sin(phaseRef) > 0 ? 1 : 0;
            const fbVal = Math.sin(phaseFb) > 0 ? 1 : 0;
            const outVal = Math.sin(phaseOut) > 0 ? 1 : 0;
            
            wRef.classList.toggle('wire-active', refVal);
            wFb.classList.toggle('wire-active', fbVal);
            wOut.classList.toggle('wire-active', outVal);
            
            // VCtrl Wire color intensity
            // Can't easily animate color of wire smoothly with class, just use active if > 0
            wVctrl.classList.toggle('wire-active', vcoFreq > 0);

            // History
            history.push({ ref: refVal, fb: fbVal, out: outVal });
            if (history.length > MAX_HISTORY) history.shift();

            drawWaveforms();
            requestAnimationFrame(step);
        }

        function drawWaveforms() {
            if(canvas.width !== canvas.offsetWidth) {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.parentElement.clientHeight;
            }
            const w = canvas.width;
            const h = canvas.height;
            const stepWidth = w / MAX_HISTORY;

            ctx.clearRect(0,0,w,h);

            const lanes = [
                { id: 'ref', y: 40, c: '#fbbf24' }, // Yellow
                { id: 'fb', y: 100, c: '#3b82f6' }, // Blue
                { id: 'out', y: 160, c: '#4ade80' } // Green
            ];

            lanes.forEach(lane => {
                ctx.strokeStyle = lane.c;
                ctx.lineWidth = 2;
                ctx.beginPath();
                for(let i=0; i<history.length; i++) {
                    const val = history[i][lane.id];
                    const x = i * stepWidth;
                    const y = val ? lane.y - 15 : lane.y + 15;

                    if(i===0) ctx.moveTo(x, y);
                    else {
                        if (history[i-1][lane.id] !== val) ctx.lineTo(x, val ? lane.y+15 : lane.y-15);
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();

                ctx.strokeStyle = 'rgba(255,255,255,0.05)';
                ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(0, lane.y); ctx.lineTo(w, lane.y); ctx.stroke();
            });
        }
        
        function resize() {
            // Placeholder for resize logic if needed
        }

        // Init
        updateTarget();
        requestAnimationFrame(step);

    </script>
</body>
</html>
