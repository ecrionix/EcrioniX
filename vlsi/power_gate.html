<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXZS8C1FLY"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XXZS8C1FLY');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Gating Lab - EcrioniX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Orbitron:wght@500;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <!-- MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #020617; color: #f8fafc; overflow: hidden; }
        .tech-font { font-family: 'Orbitron', sans-serif; }
        .mono-font { font-family: 'JetBrains Mono', monospace; }

        .watermark {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 8rem; font-weight: 900; color: rgba(99, 102, 241, 0.03);
            pointer-events: none; user-select: none; z-index: 0;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px;
        }

        /* Tabs */
        .tab-btn {
            @apply px-4 py-2 text-xs font-bold rounded-lg transition-all border border-transparent text-slate-400 uppercase tracking-wider;
        }
        .tab-active {
            @apply bg-indigo-600 text-white border-indigo-500 shadow-lg shadow-indigo-500/30;
        }

        /* Circuit Components */
        .wire { fill: none; stroke: #475569; stroke-width: 2.5; stroke-linecap: round; stroke-linejoin: round; transition: stroke 0.1s; }
        .wire-active { stroke: #fbbf24; filter: drop-shadow(0 0 3px #fbbf24); }
        .wire-gnd { stroke: #3b82f6; }
        .wire-vdd { stroke: #ef4444; }
        .wire-virtual { stroke: #a855f7; stroke-dasharray: 4; } /* Virtual VDD/GND */
        
        .mos-body { fill: none; stroke: #cbd5e1; stroke-width: 2; }
        .mos-gate { fill: none; stroke: #94a3b8; stroke-width: 2; }
        .mos-bubble { fill: #0f172a; stroke: #cbd5e1; stroke-width: 2; }
        .mos-active .mos-gate { stroke: #facc15; }

        /* Logic Block */
        .logic-cloud { fill: #1e293b; stroke: #64748b; stroke-width: 2; }
        .logic-active { fill: #312e81; stroke: #818cf8; filter: drop-shadow(0 0 10px #4ade80); }

        /* Sliders */
        input[type=range] { accent-color: #6366f1; }

        /* Theory Styles */
        .prose h1 { @apply text-3xl font-bold text-white mb-6 tech-font border-b border-slate-800 pb-2; }
        .prose h2 { @apply text-xl font-bold text-indigo-400 mt-8 mb-4 uppercase tracking-wider; }
        .prose p { @apply text-slate-400 mb-4 leading-relaxed; }
        .prose strong { @apply text-white font-semibold; }
        .prose ul { @apply list-disc list-inside space-y-2 text-slate-400 mb-4; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col relative">

    <div class="watermark">EcrioniX Low Power</div>

    <!-- Header -->
    <nav class="border-b border-slate-800 bg-slate-900/80 px-6 py-4 flex justify-between items-center z-20">
        <div>
            <h1 class="text-2xl font-bold text-indigo-400 tech-font uppercase">POWER <span class="text-white">GATING</span></h1>
            <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Low Power VLSI Design: Sleep Transistors</p>
        </div>
        
        <div class="flex bg-slate-950 p-1 rounded-xl border border-slate-800">
            <button onclick="switchView('theory')" id="btn-theory" class="tab-btn tab-active">Theory Guide</button>
            <button onclick="switchView('lab')" id="btn-lab" class="tab-btn">Simulation Lab</button>
        </div>

        <button onclick="window.history.back()" class="group flex items-center text-slate-400 hover:text-white transition bg-slate-800/80 px-4 py-2 rounded-lg border border-slate-700 hover:border-indigo-500">
            <span class="text-xs font-bold uppercase">Exit Lab</span>
        </button>
    </nav>

    <!-- Content -->
    <div class="flex-grow relative overflow-hidden">

        <!-- THEORY VIEW -->
        <div id="view-theory" class="absolute inset-0 z-10 overflow-y-auto p-8 flex justify-center">
            <div class="max-w-4xl w-full glass-panel p-10 prose">
                <h1>Shutting Down: The Power Gating Concept</h1>
                <p>
                    As transistors shrink (scaling), leakage power becomes a dominant consumer of energy, even when the chip is idle. **Power Gating** is the most aggressive technique to reduce this static leakage by completely cutting off the power supply to inactive circuit blocks.
                </p>

                <h2>1. The Problem: Leakage Current</h2>
                <p>
                    Even when a digital CMOS circuit is not switching (Idle), current flows from $V_{DD}$ to $GND$ due to **Subthreshold Leakage** ($I_{sub}$) and **Gate Oxide Leakage** ($I_{gate}$). In modern processes (7nm, 5nm), this can account for >40% of total power.
                </p>

                <h2>2. The Solution: Sleep Transistors</h2>
                <p>
                    Power gating inserts a large, high-threshold voltage ($High-V_{th}$) transistor in series with the logic block and the power rail. This transistor acts as a switch.
                </p>
                <ul>
                    <li><strong>Header Switch (PMOS):</strong> Placed between true $V_{DD}$ and the circuit's virtual $V_{DD\_V}$. Used for high-side gating.</li>
                    <li><strong>Footer Switch (NMOS):</strong> Placed between true $GND$ and the circuit's virtual $GND\_V$. Used for low-side gating.</li>
                    <li><strong>Active Mode:</strong> The switch is ON (linear region), connecting the logic to the rail. It acts as a small resistor ($R_{on}$).</li>
                    <li><strong>Sleep Mode:</strong> The switch is OFF (cutoff region), breaking the path. Leakage is reduced exponentially because the sleep transistor is high-$V_{th}$.</li>
                </ul>

                <h2>3. Design Challenges (IR Drop & Wake-up)</h2>
                <p>
                    <strong>IR Drop:</strong> When active, the sleep transistor is not a perfect wire. It has resistance ($R_{on}$). The current drawn by the logic ($I_{load}$) creates a voltage drop ($V_{drop} = I_{load} \times R_{on}$). This reduces the effective voltage seen by the logic ($V_{DD\_V} = V_{DD} - V_{drop}$), slowing it down.
                    <br><br>
                    <strong>In-Rush Current:</strong> When waking up, the virtual power rail capacitance must charge up quickly. This causes a massive spike in current from the main grid, which can cause voltage droops (noise) affecting other active blocks. Designers use "Daisy Chaining" to turn on sleep transistors gradually.
                </p>

                <h2>4. State Retention</h2>
                <p>
                    When power is cut, standard flip-flops lose their data. If the block needs to resume where it left off, special **Retention Flip-Flops (RFF)** are used. These have a secondary low-leakage power supply to keep the data alive during sleep mode.
                </p>
                
                <div class="mt-8 text-center">
                    <button onclick="switchView('lab')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-8 py-3 rounded-xl font-bold transition shadow-lg shadow-indigo-500/20">Launch Experiment &rarr;</button>
                </div>
            </div>
        </div>

        <!-- LAB VIEW -->
        <div id="view-lab" class="absolute inset-0 z-0 opacity-0 pointer-events-none flex p-6 gap-6">
            
            <!-- Left: Controls -->
            <div class="w-80 flex flex-col gap-4 overflow-y-auto pr-2">
                
                <div class="glass-panel p-6">
                    <h2 class="text-indigo-400 font-bold mb-4 uppercase text-[10px] tracking-widest">Configuration</h2>
                    
                    <div class="space-y-6">
                        <!-- Topology -->
                        <div>
                            <span class="text-xs text-slate-300 font-bold block mb-2">Gating Topology</span>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="setMode('HEADER')" id="btn-header" class="py-2 bg-indigo-600 text-white rounded border border-indigo-500 text-xs font-bold transition shadow">HEADER (PMOS)</button>
                                <button onclick="setMode('FOOTER')" id="btn-footer" class="py-2 bg-slate-800 text-slate-400 rounded border border-slate-700 text-xs font-bold transition hover:text-white">FOOTER (NMOS)</button>
                            </div>
                        </div>

                        <!-- Transistor Sizing -->
                        <div>
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-slate-300">Sleep Tx Size (Width)</span>
                                <span id="val-width" class="font-mono text-white font-bold">10 um</span>
                            </div>
                            <input type="range" id="slider-width" min="1" max="50" step="1" value="10" class="w-full">
                            <p class="text-[9px] text-slate-500 mt-1">Larger width = Lower IR Drop, but more Area.</p>
                        </div>

                        <!-- Power Toggle -->
                        <button onclick="toggleSleep()" id="btn-sleep" class="w-full py-4 bg-red-600 hover:bg-red-500 text-white font-bold rounded-xl shadow-lg transition active:scale-95 border-b-4 border-red-800 active:border-b-0 active:translate-y-1">
                            ENTER SLEEP MODE
                        </button>
                    </div>
                </div>

                <!-- Telemetry -->
                <div class="glass-panel p-6 flex-grow flex flex-col">
                    <h2 class="text-emerald-400 font-bold mb-4 uppercase text-[10px] tracking-widest">Power Monitor</h2>
                    <div class="space-y-3">
                        <div class="bg-black/40 p-3 rounded border border-slate-800 flex justify-between items-center">
                            <span class="text-xs text-slate-400">Virtual Rail ($V_v$)</span>
                            <span id="val-vv" class="text-yellow-400 font-bold mono-font">1.00 V</span>
                        </div>
                        <div class="bg-black/40 p-3 rounded border border-slate-800 flex justify-between items-center">
                            <span class="text-xs text-slate-400">Current ($I_{total}$)</span>
                            <span id="val-current" class="text-blue-400 font-bold mono-font">100.0 μA</span>
                        </div>
                        <div class="bg-black/40 p-3 rounded border border-slate-800 flex justify-between items-center">
                            <span class="text-xs text-slate-400">IR Drop</span>
                            <span id="val-irdrop" class="text-red-400 font-bold mono-font">0.00 mV</span>
                        </div>
                        <div class="bg-black/40 p-3 rounded border border-slate-800 flex justify-between items-center">
                            <span class="text-xs text-slate-400">Leakage Savings</span>
                            <span id="val-savings" class="text-emerald-400 font-bold mono-font">0%</span>
                        </div>
                    </div>
                </div>

                <!-- Reset Button -->
                <button onclick="resetLab()" class="mt-4 w-full py-2 text-xs font-bold text-red-400 border border-red-900/30 rounded hover:bg-red-900/10">RESET STAGE</button>
            </div>

            <!-- Right: Visualization -->
            <div class="flex-grow flex flex-col gap-6">
                
                <!-- Schematic -->
                <div class="glass-panel p-1 relative flex-grow overflow-hidden flex items-center justify-center bg-slate-900/50">
                    <div class="absolute top-4 left-4 text-[10px] text-slate-500 font-bold uppercase tracking-widest bg-black/60 px-2 py-1 rounded">Power Domain View</div>
                    
                    <div id="schematic-container" class="w-full h-full flex items-center justify-center p-4">
                        <svg id="svg-circuit" width="600" height="400" viewBox="0 0 600 400">
                            <!-- Defs -->
                            <defs>
                                <g id="nmos">
                                    <path d="M-15,0 H0 M-15,30 H0 M-15,15 H0" class="mos-body" />
                                    <line x1="0" y1="0" x2="0" y2="30" class="mos-body" />
                                    <line x1="5" y1="0" x2="5" y2="30" class="mos-gate" />
                                    <line x1="5" y1="15" x2="20" y2="15" class="wire" />
                                    <line x1="-8" y1="0" x2="-8" y2="-20" class="wire" />
                                    <line x1="-8" y1="30" x2="-8" y2="50" class="wire" />
                                </g>
                                <g id="pmos">
                                    <path d="M-15,0 H0 M-15,30 H0 M-15,15 H0" class="mos-body" />
                                    <line x1="0" y1="0" x2="0" y2="30" class="mos-body" />
                                    <line x1="5" y1="0" x2="5" y2="30" class="mos-gate" />
                                    <circle cx="12" cy="15" r="3" class="mos-bubble" />
                                    <line x1="15" y1="15" x2="30" y2="15" class="wire" />
                                    <line x1="-8" y1="0" x2="-8" y2="-20" class="wire" />
                                    <line x1="-8" y1="30" x2="-8" y2="50" class="wire" />
                                </g>
                            </defs>
                            
                            <!-- Global VDD/GND -->
                            <line x1="200" y1="50" x2="400" y2="50" class="wire wire-vdd" />
                            <text x="410" y="55" fill="#ef4444" font-size="12" font-weight="bold">VDD Global</text>

                            <line x1="200" y1="350" x2="400" y2="350" class="wire wire-gnd" />
                            <text x="410" y="355" fill="#3b82f6" font-size="12" font-weight="bold">GND Global</text>

                            <!-- Logic Block (The Load) -->
                            <rect x="250" y="150" width="100" height="100" rx="8" class="logic-cloud" id="logic-block" />
                            <text x="300" y="205" text-anchor="middle" fill="#cbd5e1" font-size="12" class="tech-font">LOGIC CORE</text>
                            
                            <!-- Sleep Transistor (Dynamic Group) -->
                            <g id="sleep-tx-group"></g>

                            <!-- Virtual Rails -->
                            <line x1="250" y1="140" x2="350" y2="140" class="wire wire-virtual" id="rail-vvdd" style="display:none" />
                            <line x1="250" y1="260" x2="350" y2="260" class="wire wire-virtual" id="rail-vgnd" style="display:none" />
                            
                            <!-- Sleep Control Signal -->
                            <text x="150" y="200" text-anchor="end" fill="#fbbf24" font-size="12" font-weight="bold" id="lbl-sleep">SLEEP_CTRL</text>
                            <line x1="160" y1="195" x2="210" y2="195" class="wire" id="wire-sleep" />

                        </svg>
                    </div>
                </div>

                <!-- IR Drop / Wakeup Graph -->
                <div class="glass-panel p-4 h-64 flex flex-col">
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Virtual Rail Voltage ($V_{virtual}$) vs Time</h2>
                    <div class="w-full h-full bg-black/20 rounded relative">
                        <canvas id="wave-canvas"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- State ---
        let mode = 'HEADER'; // HEADER or FOOTER
        let isSleeping = false;
        let widthTx = 10;
        let vdd = 1.0;
        
        let simTime = 0;
        let vVirtual = 1.0; // Current voltage of virtual rail
        
        const history = [];
        const MAX_HISTORY = 300;

        // DOM
        const sliderW = document.getElementById('slider-width');
        const btnSleep = document.getElementById('btn-sleep');
        const svgGroup = document.getElementById('sleep-tx-group');
        const wireSleep = document.getElementById('wire-sleep');
        const logicBlock = document.getElementById('logic-block');
        
        const valVv = document.getElementById('val-vv');
        const valI = document.getElementById('val-current');
        const valDrop = document.getElementById('val-irdrop');
        const valSave = document.getElementById('val-savings');
        
        const cvs = document.getElementById('wave-canvas');
        const ctx = cvs.getContext('2d');

        // --- Logic ---
        function switchView(v) {
            const theory = document.getElementById('view-theory');
            const lab = document.getElementById('view-lab');
            const btnT = document.getElementById('btn-theory');
            const btnL = document.getElementById('btn-lab');

            if (v === 'theory') {
                theory.classList.remove('opacity-0', 'pointer-events-none'); theory.classList.add('z-10');
                lab.classList.add('opacity-0', 'pointer-events-none'); lab.classList.remove('z-10');
                btnT.classList.add('tab-active'); btnL.classList.remove('tab-active');
            } else {
                lab.classList.remove('opacity-0', 'pointer-events-none'); lab.classList.add('z-10');
                theory.classList.add('opacity-0', 'pointer-events-none'); theory.classList.remove('z-10');
                btnL.classList.add('tab-active'); btnT.classList.remove('tab-active');
                resize();
            }
        }

        function setMode(m) {
            mode = m;
            document.getElementById('btn-header').className = m==='HEADER' ? "py-2 bg-indigo-600 text-white rounded border border-indigo-500 text-xs font-bold transition shadow" : "py-2 bg-slate-800 text-slate-400 rounded border border-slate-700 text-xs font-bold transition hover:text-white";
            document.getElementById('btn-footer').className = m==='FOOTER' ? "py-2 bg-indigo-600 text-white rounded border border-indigo-500 text-xs font-bold transition shadow" : "py-2 bg-slate-800 text-slate-400 rounded border border-slate-700 text-xs font-bold transition hover:text-white";
            
            drawSchematic();
        }

        function drawSchematic() {
            let svg = '';
            document.getElementById('rail-vvdd').style.display = mode === 'HEADER' ? 'block' : 'none';
            document.getElementById('rail-vgnd').style.display = mode === 'FOOTER' ? 'block' : 'none';

            if (mode === 'HEADER') {
                // PMOS between VDD and Logic
                // Logic Top: y=150. VDD: y=50. PMOS Center: 100
                svg += `<line x1="300" y1="50" x2="300" y2="70" class="wire wire-vdd" />`;
                svg += `<g transform="translate(308, 100)" id="tx-sleep"><use href="#pmos" class="${!isSleeping?'mos-active':''}"/></g>`;
                svg += `<line x1="300" y1="130" x2="300" y2="150" class="wire wire-virtual" />`; // Connect to logic top
                // GND Hardwired
                svg += `<line x1="300" y1="250" x2="300" y2="350" class="wire wire-gnd" />`; 
                
                // Sleep wire to Gate (y=115)
                wireSleep.setAttribute('x1', 160); wireSleep.setAttribute('y1', 115);
                wireSleep.setAttribute('x2', 320); wireSleep.setAttribute('y2', 115);
                document.getElementById('lbl-sleep').setAttribute('y', 120);

            } else {
                // VDD Hardwired
                svg += `<line x1="300" y1="50" x2="300" y2="150" class="wire wire-vdd" />`;
                // NMOS between Logic and GND
                // Logic Bot: y=250. GND: y=350. NMOS Center: 300
                svg += `<line x1="300" y1="250" x2="300" y2="270" class="wire wire-virtual" />`; 
                svg += `<g transform="translate(308, 300)" id="tx-sleep"><use href="#nmos" class="${!isSleeping?'mos-active':''}"/></g>`;
                svg += `<line x1="300" y1="330" x2="300" y2="350" class="wire wire-gnd" />`;

                // Sleep wire to Gate (y=315)
                wireSleep.setAttribute('x1', 160); wireSleep.setAttribute('y1', 315);
                wireSleep.setAttribute('x2', 310); wireSleep.setAttribute('y2', 315);
                document.getElementById('lbl-sleep').setAttribute('y', 320);
            }
            svgGroup.innerHTML = svg;
        }

        function toggleSleep() {
            isSleeping = !isSleeping;
            const btn = document.getElementById('btn-sleep');
            if (isSleeping) {
                btn.innerText = "WAKE UP";
                btn.classList.replace('bg-red-600', 'bg-green-600');
                btn.classList.replace('hover:bg-red-500', 'hover:bg-green-500');
                btn.classList.replace('border-red-800', 'border-green-800');
            } else {
                btn.innerText = "ENTER SLEEP MODE";
                btn.classList.replace('bg-green-600', 'bg-red-600');
                btn.classList.replace('hover:bg-green-500', 'hover:bg-red-500');
                btn.classList.replace('border-green-800', 'border-red-800');
            }
            drawSchematic(); // Update MOS visual state
        }
        
        function resetLab() {
             isSleeping = false;
             vVirtual = mode === 'HEADER' ? 1.0 : 0.0;
             history.length = 0;
             simTime = 0;
             
             // Reset UI state for sleep button
             const btn = document.getElementById('btn-sleep');
             btn.innerText = "ENTER SLEEP MODE";
             btn.classList.remove('bg-green-600', 'hover:bg-green-500', 'border-green-800');
             btn.classList.add('bg-red-600', 'hover:bg-red-500', 'border-red-800');
             
             drawSchematic();
        }

        // --- Physics Loop ---
        function step() {
            simTime++;
            widthTx = parseInt(sliderW.value);
            document.getElementById('val-width').innerText = widthTx + " um";

            // Physics Calculation
            let targetV = 0; // Where V_virtual wants to go
            
            if (mode === 'HEADER') {
                // V_virtual is V_vdd_virtual. 
                // Active: VDD - Drop. Sleep: 0 (Discharge).
                if (!isSleeping) {
                    // IR Drop = I_load / Width_factor
                    // Assume I_load = 100uA baseline.
                    // Resistance ~ 1/Width
                    const drop = 0.2 / (widthTx / 5); // Example math
                    targetV = 1.0 - drop;
                } else {
                    targetV = 0.0;
                }
            } else {
                // V_virtual is V_gnd_virtual.
                // Active: GND + Drop. Sleep: 1.0 (Charge up to VDD due to leakage/floating).
                if (!isSleeping) {
                    const drop = 0.2 / (widthTx / 5);
                    targetV = 0.0 + drop;
                } else {
                    targetV = 1.0;
                }
            }

            // Smooth transition (RC delay simulation)
            const speed = 0.1;
            vVirtual += (targetV - vVirtual) * speed;

            // Metrics
            const irDrop = mode==='HEADER' ? (1.0 - vVirtual) : (vVirtual - 0.0);
            
            // Logic Active Visual
            if (!isSleeping && Math.abs(vVirtual - (mode==='HEADER'?1:0)) < 0.2) {
                logicBlock.classList.add('logic-active');
            } else {
                logicBlock.classList.remove('logic-active');
            }
            
            // Current Calculation
            let current = 0;
            if (!isSleeping) current = 100; // Active dynamic current
            else current = 0.1; // Leakage

            // Update UI
            valVv.innerText = vVirtual.toFixed(3) + " V";
            valI.innerText = current.toFixed(1) + " μA";
            
            // IR Drop is valid only when active
            if (!isSleeping) {
                valDrop.innerText = (irDrop * 1000).toFixed(1) + " mV";
                valDrop.className = irDrop > 0.1 ? "text-red-500 font-bold mono-font animate-pulse" : "text-emerald-400 font-bold mono-font";
                valSave.innerText = "0%";
            } else {
                valDrop.innerText = "--";
                valDrop.className = "text-slate-500 font-bold mono-font";
                valSave.innerText = "99.9%";
            }

            // Wire Sleep Color
            let sleepSigLevel = 0;
            if (mode === 'HEADER') sleepSigLevel = isSleeping ? 1 : 0;
            else sleepSigLevel = isSleeping ? 0 : 1;
            
            wireSleep.classList.toggle('wire-active', sleepSigLevel === 1);

            // History
            history.push(vVirtual);
            if(history.length > MAX_HISTORY) history.shift();

            drawGraph();
            requestAnimationFrame(step);
        }

        function drawGraph() {
            if(cvs.width !== cvs.parentElement.clientWidth) {
                cvs.width = cvs.parentElement.clientWidth;
                cvs.height = cvs.parentElement.clientHeight;
            }
            const w = cvs.width;
            const h = cvs.height;
            const step = w / MAX_HISTORY;
            
            ctx.clearRect(0,0,w,h);

            // Grid
            ctx.strokeStyle = '#1e293b';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, h/2); ctx.lineTo(w, h/2); // 0.5V line
            ctx.stroke();

            // Trace
            ctx.strokeStyle = '#a855f7'; // Purple for virtual rail
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            for(let i=0; i<history.length; i++) {
                const x = i * step;
                // Map 0-1V to height. Bottom=0V, Top=1V.
                // Padding 20px
                const y = (h-20) - (history[i] * (h-40)); 
                if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            }
            ctx.stroke();
            
            // Fill
            ctx.lineTo(w, h);
            ctx.lineTo(0, h);
            ctx.fillStyle = 'rgba(168, 85, 247, 0.1)';
            ctx.fill();
        }
        
        function resize() {
            drawGraph();
        }
        window.addEventListener('resize', resize);

        // Init
        setMode('HEADER');
        requestAnimationFrame(step);

    </script>
</body>
</html>
