<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXZS8C1FLY"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XXZS8C1FLY');
</script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D Flip-Flop & Timing - EcrioniX Labs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Orbitron:wght@500;700&family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .brand-font { font-family: 'Orbitron', sans-serif; }
        .mono-font { font-family: 'JetBrains Mono', monospace; }

        /* Watermark */
        .watermark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 8rem;
            font-weight: 900;
            color: rgba(99, 102, 241, 0.03);
            pointer-events: none;
            user-select: none;
            white-space: nowrap;
            z-index: 0;
        }

        /* Circuit Components */
        .gate-body { fill: #1e293b; stroke: #94a3b8; stroke-width: 2; transition: all 0.2s; }
        .gate-active { stroke: #facc15; fill: #422006; }
        .gate-text { font-family: 'Orbitron', sans-serif; fill: #cbd5e1; font-size: 10px; }
        
        .wire { fill: none; stroke: #475569; stroke-width: 3; transition: stroke 0.1s; stroke-linecap: round; }
        .wire-high { stroke: #4ade80; filter: drop-shadow(0 0 4px #4ade80); }
        .wire-low { stroke: #1e293b; opacity: 0.3; }
        
        /* Waveform Canvas */
        .wave-screen {
            background-color: #111827;
            border: 1px solid #374151;
            border-radius: 6px;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Toggle Switches */
        .switch-btn {
            transition: all 0.1s;
            box-shadow: 0 4px 0 #334155;
        }
        .switch-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #334155;
        }
        .switch-on { background-color: #4ade80; color: #064e3b; box-shadow: 0 4px 0 #166534; }
        .switch-on:active { box-shadow: 0 0 0 #166534; }
        
        /* Violation Zone */
        .violation-box {
            animation: pulse-red 0.5s ease-in-out;
        }
        @keyframes pulse-red {
            0%, 100% { background-color: transparent; }
            50% { background-color: rgba(239, 68, 68, 0.2); }
        }
    </style>
</head>
<body class="relative min-h-screen flex flex-col overflow-x-hidden">

    <div class="watermark">EcrioniX</div>

    <!-- Navigation -->
    <div class="fixed top-4 left-4 z-50">
        <button onclick="window.history.back()" class="group flex items-center text-slate-400 hover:text-white transition bg-slate-900/80 px-3 py-1 rounded-full border border-slate-700">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            <span class="text-xs font-bold">EXIT LAB</span>
        </button>
    </div>

    <!-- Header -->
    <header class="pt-8 pb-4 text-center relative z-10">
        <h1 class="text-3xl font-bold text-white brand-font tracking-wide">D FLIP-FLOP <span class="text-cyan-400">INTERNALS</span></h1>
        <p class="text-slate-400 text-sm mt-2">Master-Slave Architecture & Timing Analysis</p>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 w-full flex-grow grid grid-cols-1 lg:grid-cols-12 gap-6 pb-12 relative z-10">
        
        <!-- LEFT: Controls & Theory -->
        <div class="lg:col-span-4 space-y-6">
            
            <!-- Control Panel -->
            <div class="bg-slate-800/80 backdrop-blur border border-slate-700 rounded-xl p-6 shadow-xl">
                <h2 class="text-sm font-bold text-cyan-400 mb-4 uppercase tracking-wider flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                    Input Controls
                </h2>

                <div class="space-y-6">
                    <!-- Data Input -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-slate-300 text-sm font-bold">Data Input (D)</span>
                            <span id="d-val" class="text-xs font-mono px-2 py-1 bg-slate-900 rounded text-slate-500">0</span>
                        </div>
                        <button id="btn-d" onmousedown="toggleD()" class="switch-btn w-full py-4 rounded-lg bg-slate-700 text-slate-300 font-bold border border-slate-600 text-lg">
                            TOGGLE DATA (0)
                        </button>
                        <p class="text-[10px] text-slate-500 mt-1">Click to flip input bit. Try changing just before Clock rises!</p>
                    </div>

                    <!-- Clock Control -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-slate-300 text-sm font-bold">Clock (CLK)</span>
                            <span id="clk-val" class="text-xs font-mono px-2 py-1 bg-slate-900 rounded text-slate-500">0</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <button id="btn-clk-man" onmousedown="manualClock()" class="switch-btn py-3 rounded-lg bg-yellow-600 text-white font-bold border border-yellow-500">
                                PULSE CLOCK
                            </button>
                            <button id="btn-clk-auto" onclick="toggleAuto()" class="switch-btn py-3 rounded-lg bg-slate-700 text-slate-300 font-bold border border-slate-600">
                                AUTO RUN
                            </button>
                        </div>
                    </div>

                    <!-- Speed Slider -->
                    <div>
                        <label class="text-xs text-slate-400 font-bold">SIMULATION SPEED</label>
                        <input type="range" id="sim-speed" min="1" max="10" value="3" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer mt-2">
                    </div>
                </div>
            </div>

            <!-- Theory Box -->
            <div class="bg-slate-900/80 border border-slate-800 rounded-xl p-5">
                <h3 class="text-xs font-bold text-white mb-2 uppercase border-l-2 border-indigo-500 pl-2">Timing Concepts</h3>
                <div class="space-y-3 text-xs text-slate-400">
                    <div>
                        <strong class="text-indigo-400">Setup Time (t<sub>su</sub>):</strong>
                        <p>Data must be stable <em>before</em> the clock edge. If D changes in this window, the internal Master latch may capture a glitch.</p>
                    </div>
                    <div>
                        <strong class="text-pink-400">Hold Time (t<sub>h</sub>):</strong>
                        <p>Data must remain stable <em>after</em> the clock edge. Changing D too soon disrupts the Master latch locking process.</p>
                    </div>
                </div>
            </div>

        </div>

        <!-- RIGHT: Visualization -->
        <div class="lg:col-span-8 space-y-6">
            
            <!-- Internal Schematic -->
            <div class="bg-slate-800 rounded-xl shadow-xl border border-slate-700 p-1 relative overflow-hidden">
                <div class="absolute top-2 left-3 text-[10px] font-bold text-slate-500 tracking-widest">MASTER-SLAVE TOPOLOGY</div>
                
                <div class="bg-slate-900 h-64 w-full rounded-lg mt-6 flex items-center justify-center relative" id="schematic-container">
                    <svg id="schematic" width="100%" height="100%" viewBox="0 0 600 200">
                        <defs>
                            <marker id="arrow" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
                                <path d="M0,0 L10,5 L0,10" fill="#475569" />
                            </marker>
                        </defs>

                        <!-- Input D -->
                        <text x="30" y="85" class="gate-text" font-size="14" font-weight="bold">D</text>
                        <line id="w-d" x1="50" y1="80" x2="100" y2="80" class="wire" />

                        <!-- Master Latch (Gated D Latch) -->
                        <g transform="translate(100, 40)">
                            <rect id="master-body" width="80" height="80" rx="4" class="gate-body" />
                            <text x="40" y="25" text-anchor="middle" class="gate-text">MASTER</text>
                            <text x="40" y="45" text-anchor="middle" class="gate-text" font-size="8">(Transparent when CLK=0)</text>
                            <text x="10" y="40" class="gate-text">D</text>
                            <text x="10" y="70" class="gate-text">EN</text>
                            <circle cx="5" cy="65" r="3" fill="none" stroke="#94a3b8" stroke-width="1.5"/> <!-- Inverted Input Bubble -->
                        </g>

                        <!-- Wire: Master to Slave -->
                        <line id="w-mq" x1="180" y1="80" x2="250" y2="80" class="wire" />
                        <text x="215" y="70" class="gate-text" fill="#64748b">Qm</text>

                        <!-- Slave Latch (Gated D Latch) -->
                        <g transform="translate(250, 40)">
                            <rect id="slave-body" width="80" height="80" rx="4" class="gate-body" />
                            <text x="40" y="25" text-anchor="middle" class="gate-text">SLAVE</text>
                            <text x="40" y="45" text-anchor="middle" class="gate-text" font-size="8">(Transparent when CLK=1)</text>
                            <text x="10" y="40" class="gate-text">D</text>
                            <text x="10" y="70" class="gate-text">EN</text>
                        </g>

                        <!-- Output Q -->
                        <line id="w-q" x1="330" y1="80" x2="380" y2="80" class="wire" />
                        <text x="390" y="85" class="gate-text" font-size="14" font-weight="bold" fill="#fff">Q</text>

                        <!-- Clock Network -->
                        <text x="30" y="165" class="gate-text" font-size="14" font-weight="bold" fill="#eab308">CLK</text>
                        <line id="w-clk-main" x1="50" y1="160" x2="280" y2="160" class="wire" stroke="#eab308" />
                        
                        <!-- Clock to Master (Inverted logic visual) -->
                        <line id="w-clk-m" x1="130" y1="160" x2="130" y2="120" class="wire" stroke="#eab308" />
                        
                        <!-- Clock to Slave -->
                        <line id="w-clk-s" x1="280" y1="160" x2="280" y2="120" class="wire" stroke="#eab308" />

                        <!-- Setup/Hold Indicators (Hidden by default) -->
                        <g id="violation-indicator" opacity="0">
                            <rect x="80" y="20" width="120" height="120" fill="none" stroke="#ef4444" stroke-width="4" stroke-dasharray="5,5" />
                            <text x="140" y="160" text-anchor="middle" fill="#ef4444" font-weight="bold" font-size="12">TIMING VIOLATION!</text>
                        </g>

                    </svg>
                </div>
            </div>

            <!-- Waveform Monitor -->
            <div class="bg-slate-900 rounded-xl border border-slate-700 overflow-hidden">
                <div class="bg-slate-800 px-4 py-2 border-b border-slate-700 flex justify-between items-center">
                    <span class="text-xs font-bold text-slate-300">TIMING DIAGRAM</span>
                    <div class="flex space-x-4 text-[10px] font-mono">
                        <span class="text-yellow-500">CLK</span>
                        <span class="text-blue-400">DATA (D)</span>
                        <span class="text-green-400">OUTPUT (Q)</span>
                    </div>
                </div>
                <div class="p-2 relative">
                    <canvas id="waveCanvas" height="200" width="800" class="wave-screen w-full"></canvas>
                    
                    <!-- Violation Zone Overlay -->
                    <div id="wave-overlay" class="absolute inset-0 pointer-events-none"></div>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-auto border-t border-slate-800 bg-slate-950 py-8 text-center relative z-10">
        <p class="text-slate-600 text-sm">
            &copy; 2026 EcrioniX Labs. Owned by <span class="text-cyan-400">Elangovan</span>.
        </p>
    </footer>

    <!-- Logic -->
    <script>
        // --- State ---
        let d = 0;
        let q = 0;
        let qMaster = 0;
        let clk = 0;
        
        let isAuto = false;
        let autoInterval = null;
        let time = 0;
        
        let lastClkRise = -9999;
        let lastDChange = -9999;
        
        // Timing Constants (in simulation frames)
        const SETUP_WINDOW = 15;
        const HOLD_WINDOW = 15;
        
        // History for Canvas
        const history = [];
        const MAX_HISTORY = 600;

        // DOM
        const wD = document.getElementById('w-d');
        const wMq = document.getElementById('w-mq');
        const wQ = document.getElementById('w-q');
        const wClkMain = document.getElementById('w-clk-main');
        const wClkM = document.getElementById('w-clk-m');
        const wClkS = document.getElementById('w-clk-s');
        
        const masterBody = document.getElementById('master-body');
        const slaveBody = document.getElementById('slave-body');
        const violationInd = document.getElementById('violation-indicator');
        
        const btnD = document.getElementById('btn-d');
        const dValDisp = document.getElementById('d-val');
        const clkValDisp = document.getElementById('clk-val');
        const btnClkAuto = document.getElementById('btn-clk-auto');
        
        const canvas = document.getElementById('waveCanvas');
        const ctx = canvas.getContext('2d');
        const sliderSpeed = document.getElementById('sim-speed');

        // --- Core Logic ---

        function toggleD() {
            d = d ? 0 : 1;
            lastDChange = time;
            updateUI();
        }

        function toggleAuto() {
            isAuto = !isAuto;
            if (isAuto) {
                btnClkAuto.classList.add('switch-on');
                btnClkAuto.innerText = "STOP AUTO";
            } else {
                btnClkAuto.classList.remove('switch-on');
                btnClkAuto.innerText = "AUTO RUN";
            }
        }

        function manualClock() {
            if(isAuto) toggleAuto();
            // Pulse: 0 -> 1 -> 0
            if (clk === 0) {
                clk = 1;
                handleClockEdge();
            } else {
                clk = 0;
            }
            updateUI();
        }

        function handleClockEdge() {
            lastClkRise = time;
            // On Rising Edge (Slave Transparent, Master Locked)
            // But wait, Master captures when CLK=0. Slave captures when CLK=1.
            
            // Checking Timing Violations
            const timeSinceChange = time - lastDChange;
            
            // SETUP Violation: Did D change just before clock rose?
            if (timeSinceChange < SETUP_WINDOW) {
                triggerViolation("SETUP");
            }
        }

        function triggerViolation(type) {
            violationInd.style.opacity = 1;
            setTimeout(() => violationInd.style.opacity = 0, 500);
            
            // Add visual marker to history
            if (history.length > 0) {
                history[history.length - 1].violation = type;
            }
        }

        function step() {
            // Speed Control
            const speed = parseInt(sliderSpeed.value);
            
            // Auto Clock Logic
            if (isAuto) {
                if (time % (100/speed) < 1) { // roughly creates periodic clock
                    const prevClk = clk;
                    clk = Math.floor(time / (100/speed)) % 2;
                    if (prevClk === 0 && clk === 1) handleClockEdge();
                }
            }

            // HOLD Check: Did D change just AFTER clock rose?
            if (clk === 1 && (time - lastClkRise) < HOLD_WINDOW && (time - lastDChange) < 2) {
                triggerViolation("HOLD");
            }

            // --- FLIP FLOP BEHAVIOR (Master-Slave) ---
            
            // Master Latch (Active Low Clock)
            if (clk === 0) {
                qMaster = d; // Transparent
                masterBody.classList.add('gate-active');
            } else {
                masterBody.classList.remove('gate-active');
                // Master holds value
            }

            // Slave Latch (Active High Clock)
            if (clk === 1) {
                q = qMaster; // Transparent (copy master)
                slaveBody.classList.add('gate-active');
            } else {
                slaveBody.classList.remove('gate-active');
                // Slave holds value
            }

            // Visual Updates
            updateWires();
            
            // Canvas History
            history.push({ t: time, clk, d, q, qm: qMaster, violation: null });
            if (history.length > MAX_HISTORY) history.shift();
            
            drawWaveforms();
            
            time++;
            requestAnimationFrame(step);
        }

        function updateUI() {
            btnD.innerText = `TOGGLE DATA (${d})`;
            btnD.className = d ? "switch-btn w-full py-4 rounded-lg bg-blue-500 text-white font-bold border border-blue-600 text-lg shadow-lg" : 
                                 "switch-btn w-full py-4 rounded-lg bg-slate-700 text-slate-300 font-bold border border-slate-600 text-lg";
            
            dValDisp.innerText = d;
            dValDisp.className = d ? "text-xs font-mono px-2 py-1 bg-blue-900 text-blue-300 rounded" : "text-xs font-mono px-2 py-1 bg-slate-900 text-slate-500 rounded";
            
            clkValDisp.innerText = clk;
            clkValDisp.className = clk ? "text-xs font-mono px-2 py-1 bg-yellow-900 text-yellow-300 rounded" : "text-xs font-mono px-2 py-1 bg-slate-900 text-slate-500 rounded";
        }

        function updateWires() {
            const set = (el, val) => {
                el.className.baseVal = "wire " + (val ? "wire-high" : "wire-low");
            };
            set(wD, d);
            set(wMq, qMaster);
            set(wQ, q);
            
            // Clock wires
            wClkMain.className.baseVal = "wire " + (clk ? "wire-high" : "wire-low");
            wClkM.className.baseVal = "wire " + (clk ? "wire-high" : "wire-low");
            wClkS.className.baseVal = "wire " + (clk ? "wire-high" : "wire-low");
            
            // Manual adjustment for clock color visual override (yellow)
            if(clk) {
                wClkMain.style.stroke = "#facc15"; wClkMain.style.filter = "drop-shadow(0 0 4px #facc15)";
                wClkM.style.stroke = "#facc15"; wClkM.style.filter = "drop-shadow(0 0 4px #facc15)";
                wClkS.style.stroke = "#facc15"; wClkS.style.filter = "drop-shadow(0 0 4px #facc15)";
            } else {
                wClkMain.style.stroke = ""; wClkMain.style.filter = "";
                wClkM.style.stroke = ""; wClkM.style.filter = "";
                wClkS.style.stroke = ""; wClkS.style.filter = "";
            }
        }

        function drawWaveforms() {
            if(canvas.width !== canvas.offsetWidth) canvas.width = canvas.offsetWidth;
            const w = canvas.width;
            const h = canvas.height;
            const step = w / MAX_HISTORY;

            ctx.clearRect(0,0,w,h);

            // Setup/Hold Zones (Grey areas around clock edge)
            // Hard to draw dynamically without looking ahead, but we can draw markers on edges in history.

            const lanes = [
                { id: 'clk', y: 40, h: 15, c: '#facc15' },
                { id: 'd', y: 90, h: 15, c: '#60a5fa' },
                { id: 'qm', y: 130, h: 15, c: '#94a3b8' }, // Internal node
                { id: 'q', y: 170, h: 15, c: '#4ade80' }
            ];

            lanes.forEach(lane => {
                ctx.strokeStyle = lane.c;
                ctx.lineWidth = 2;
                ctx.beginPath();

                for(let i=0; i<history.length; i++) {
                    const val = history[i][lane.id];
                    const x = i * step;
                    const y = val ? lane.y - lane.h : lane.y + lane.h;

                    // Draw Setup/Hold Violation (Red Segment)
                    if (history[i].violation && lane.id === 'd') {
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.strokeStyle = '#ef4444'; // Red
                        ctx.lineWidth = 4;
                        ctx.lineTo(x, y);
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.strokeStyle = lane.c; // Restore
                        ctx.lineWidth = 2;
                    }

                    if (i===0) ctx.moveTo(x, y);
                    else {
                        ctx.lineTo(x, y);
                        if (history[i-1][lane.id] !== val) {
                            ctx.lineTo(x, val ? lane.y + lane.h : lane.y - lane.h);
                            ctx.moveTo(x, y);
                        }
                    }
                }
                ctx.stroke();
                
                // Labels
                ctx.fillStyle = lane.c;
                ctx.font = "10px monospace";
                ctx.fillText(lane.id.toUpperCase(), 5, lane.y - 20);
            });
        }

        // Start
        requestAnimationFrame(step);

    </script>
</body>
</html>
