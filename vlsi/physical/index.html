<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clock Tree Synthesis (CTS) Lab - EcrioniX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for Waveforms -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Orbitron:wght@500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .tech-font { font-family: 'Orbitron', sans-serif; }
        
        /* Watermark */
        .watermark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 5rem;
            font-weight: 900;
            color: rgba(250, 204, 21, 0.05); /* Yellow tint */
            pointer-events: none;
            user-select: none;
            white-space: nowrap;
            z-index: 9999;
        }

        /* Canvas */
        #tree-canvas {
            background-color: #1e1e1e;
            background-image: radial-gradient(#334155 1px, transparent 1px);
            background-size: 20px 20px;
            border: 2px solid #475569;
            cursor: crosshair;
        }

        /* Waveform Container */
        .wave-container {
            background: #111827;
            border: 1px solid #374151;
            border-radius: 8px;
            padding: 10px;
        }

        /* Interactive Elements */
        .buffer-node {
            cursor: pointer;
            transition: transform 0.1s;
        }
        .buffer-node:hover { transform: scale(1.2); }
        
        .sink-active { fill: #4ade80; filter: drop-shadow(0 0 5px #4ade80); }
        .sink-late { fill: #ef4444; filter: drop-shadow(0 0 5px #ef4444); }
        
        /* Metric Box */
        .metric-box {
            @apply bg-slate-900 border border-slate-700 p-4 rounded-xl text-center;
        }
        .metric-val {
            @apply text-2xl font-mono font-bold mt-1;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex flex-col relative overflow-x-hidden">

    <div class="watermark">EcrioniX Labs</div>

    <!-- Navigation -->
    <div class="max-w-[1400px] mx-auto w-full flex-grow relative z-10 flex justify-between items-start mb-6">
        <button onclick="window.history.back()" class="group flex items-center text-gray-500 hover:text-white transition bg-slate-900 px-4 py-2 rounded-full border border-slate-700">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            <span class="text-sm font-bold">EXIT LAB</span>
        </button>
        
        <div class="flex items-center space-x-2 bg-slate-800 px-4 py-2 rounded-full border border-slate-700">
            <div class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></div>
            <span class="text-xs font-bold text-gray-300">SIMULATION LIVE</span>
        </div>
    </div>

    <!-- Header -->
    <div class="max-w-[1400px] mx-auto w-full mb-8 border-b border-gray-700 pb-4 relative z-10">
        <h1 class="text-3xl font-bold text-white tech-font tracking-wide">CLOCK TREE <span class="text-yellow-500 text-sm align-top">SYNTHESIS</span></h1>
        <p class="text-gray-400 text-sm">Interactive Skew Balancing & Latency Visualization</p>
    </div>

    <!-- Main Content -->
    <div class="max-w-[1400px] mx-auto w-full grid grid-cols-1 lg:grid-cols-12 gap-6 relative z-10">
        
        <!-- LEFT: Controls & Theory -->
        <div class="lg:col-span-4 space-y-6">
            
            <!-- Controls -->
            <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 shadow-lg">
                <h2 class="text-sm font-bold text-white mb-4 uppercase tracking-wider flex items-center">
                    <svg class="w-4 h-4 mr-2 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                    CTS ENGINEER TOOLKIT
                </h2>

                <div class="space-y-4">
                    <p class="text-xs text-gray-400">
                        Click on the yellow wires in the diagram to insert <strong>Buffers</strong>. Each buffer adds delay to that branch.
                    </p>
                    <div class="flex items-center justify-between bg-slate-900 p-3 rounded border border-slate-700">
                        <span class="text-xs font-bold text-gray-300">Buffer Delay</span>
                        <span class="text-xs font-mono text-yellow-400">+50 ps</span>
                    </div>
                    
                    <button onclick="resetTree()" class="w-full py-3 rounded-lg bg-red-900/30 text-red-400 border border-red-800 hover:bg-red-900/50 text-xs font-bold transition">
                        RESET TREE (REMOVE BUFFERS)
                    </button>
                </div>
            </div>

            <!-- Theory -->
            <div class="bg-gray-900 rounded-xl border border-gray-700 p-5 space-y-4">
                <h3 class="text-sm font-bold text-white border-l-4 border-yellow-500 pl-3">Understanding CTS</h3>
                
                <div class="text-xs text-gray-400 space-y-2">
                    <p><strong class="text-blue-400">Latency:</strong> Total time taken for the clock signal to travel from the Source (PLL) to a Sink (Flip-Flop).</p>
                    <p><strong class="text-red-400">Skew:</strong> The difference in arrival times between two sinks. Ideally, Skew = 0.</p>
                    <p class="bg-slate-800 p-2 rounded italic">
                        "If Sink A gets the clock 100ps later than Sink B, we have 100ps of Skew. We fix this by adding buffers to the faster path (Sink B) to slow it down."
                    </p>
                </div>
            </div>

            <!-- Metrics -->
            <div class="grid grid-cols-2 gap-4">
                <div class="metric-box">
                    <div class="text-[10px] uppercase text-gray-500 font-bold">Max Latency</div>
                    <div id="max-latency" class="metric-val text-blue-400">0 ps</div>
                </div>
                <div class="metric-box">
                    <div class="text-[10px] uppercase text-gray-500 font-bold">Global Skew</div>
                    <div id="global-skew" class="metric-val text-red-400">0 ps</div>
                </div>
            </div>

        </div>

        <!-- RIGHT: Visualization -->
        <div class="lg:col-span-8 space-y-6">
            
            <!-- H-Tree Canvas -->
            <div class="bg-gray-800 rounded-xl shadow-xl border border-gray-700 p-1 relative">
                <div class="absolute top-2 left-3 text-[10px] font-bold text-gray-500 tracking-widest">CLOCK NETWORK TOPOLOGY</div>
                
                <div class="bg-slate-900 h-[400px] w-full rounded-lg mt-6 overflow-hidden relative flex items-center justify-center">
                    <svg id="tree-svg" width="100%" height="100%" viewBox="0 0 800 400">
                        <!-- Defined in JS -->
                    </svg>
                    
                    <!-- Labels -->
                    <div class="absolute top-4 left-1/2 -translate-x-1/2 text-xs font-bold text-yellow-500 bg-black/50 px-2 rounded">SOURCE (PLL)</div>
                    <div class="absolute bottom-4 left-4 text-[10px] text-gray-500">Click wires to add delay</div>
                </div>
            </div>

            <!-- Waveform Monitor -->
            <div class="wave-container h-64 relative">
                <div class="absolute top-2 right-4 flex space-x-4 text-[10px] font-mono">
                    <span class="text-yellow-500">SOURCE</span>
                    <span class="text-green-400">SINK 1</span>
                    <span class="text-blue-400">SINK 4</span>
                </div>
                <canvas id="waveChart"></canvas>
            </div>

        </div>

    </div>

    <!-- Footer -->
    <footer class="mt-12 py-6 border-t border-gray-800 text-center relative z-10 bg-gray-900/80 backdrop-blur-sm">
        <p class="text-gray-400 font-semibold mb-1">Owned & Operated by Elangovan</p>
        <p class="text-slate-600 text-sm font-medium mt-2">Â© 2026 EcrioniX Labs</p>
    </footer>

    <script>
        // --- Configuration ---
        const WIRE_DELAY_PER_UNIT = 0.5; // ps per pixel
        const BUFFER_DELAY = 50; // ps per buffer
        
        // Tree Structure Definition (Simple H-Tree Level 2)
        // Root -> (Left, Right) -> (LL, LR, RL, RR)
        // Coordinates relative to 800x400 SVG
        const root = { x: 400, y: 50 };
        
        // Nodes (Sinks)
        const sinks = [
            { id: 1, x: 100, y: 350, name: "FF1", buffers: 0, pathLen: 0, arrival: 0 },
            { id: 2, x: 300, y: 350, name: "FF2", buffers: 0, pathLen: 0, arrival: 0 },
            { id: 3, x: 500, y: 350, name: "FF3", buffers: 0, pathLen: 0, arrival: 0 },
            { id: 4, x: 700, y: 350, name: "FF4", buffers: 0, pathLen: 0, arrival: 0 }
        ];

        // Branches (Wires)
        // We define logical segments where buffers can be placed
        // Branch 0: Root to Mid
        // Branch 1: Mid to Left Sub-root
        // Branch 2: Mid to Right Sub-root... simplified for interaction
        
        // Let's model paths to specific sinks for simplicity in data
        // Path 1: Root -> Mid(400,200) -> LeftMid(200,200) -> FF1
        // To make it interesting, let's intentionally skew the lengths initially visually, 
        // but physically calculate based on logical length + buffers.
        
        // We will store segments. Clicking a segment increments its buffer count.
        const segments = [
            { id: 'trunk', x1: 400, y1: 50, x2: 400, y2: 200, buffers: 0, len: 150 },
            { id: 'left-arm', x1: 400, y1: 200, x2: 200, y2: 200, buffers: 0, len: 200 },
            { id: 'right-arm', x1: 400, y1: 200, x2: 600, y2: 200, buffers: 0, len: 200 },
            { id: 'l-leg-1', x1: 200, y1: 200, x2: 100, y2: 350, buffers: 0, len: 180 }, // To FF1
            { id: 'l-leg-2', x1: 200, y1: 200, x2: 300, y2: 350, buffers: 0, len: 180 }, // To FF2
            { id: 'r-leg-1', x1: 600, y1: 200, x2: 500, y2: 350, buffers: 0, len: 180 }, // To FF3
            { id: 'r-leg-2', x1: 600, y1: 200, x2: 700, y2: 350, buffers: 0, len: 180 }, // To FF4
        ];
        
        // Map sinks to the segments they traverse
        const sinkPaths = {
            1: ['trunk', 'left-arm', 'l-leg-1'],
            2: ['trunk', 'left-arm', 'l-leg-2'],
            3: ['trunk', 'right-arm', 'r-leg-1'],
            4: ['trunk', 'right-arm', 'r-leg-2']
        };

        // DOM
        const svg = document.getElementById('tree-svg');
        const metricLat = document.getElementById('max-latency');
        const metricSkew = document.getElementById('global-skew');

        // Chart
        let waveChart;

        // --- Logic ---

        function init() {
            // Intentionally unbalance the tree initially for the lab
            // e.g., make Branch to FF4 shorter physically or logically?
            // Let's just say 'r-leg-2' has 0 buffers, but maybe we change lengths.
            // For visual simplicity, lengths are fixed, we just assume intrinsic delay.
            // Let's add default buffers to skew it.
            getSegment('left-arm').buffers = 2; // Left side is slow
            getSegment('r-leg-1').buffers = 1;  // FF3 is slow
            // FF4 has 0 buffers -> Fast
            
            initChart(); // Initialize chart first to avoid undefined errors
            renderTree();
            recalcTiming();
        }

        function getSegment(id) {
            return segments.find(s => s.id === id);
        }

        function recalcTiming() {
            let arrivals = [];
            
            sinks.forEach(s => {
                let delay = 0;
                const pathIds = sinkPaths[s.id];
                pathIds.forEach(pid => {
                    const seg = getSegment(pid);
                    delay += (seg.len * WIRE_DELAY_PER_UNIT) + (seg.buffers * BUFFER_DELAY);
                });
                s.arrival = delay;
                arrivals.push(delay);
            });

            const min = Math.min(...arrivals);
            const max = Math.max(...arrivals);
            const skew = max - min;

            metricLat.innerText = Math.round(max) + " ps";
            metricSkew.innerText = Math.round(skew) + " ps";
            
            // Color code skew
            if (skew < 20) metricSkew.className = "metric-val text-green-400";
            else if (skew < 100) metricSkew.className = "metric-val text-yellow-400";
            else metricSkew.className = "metric-val text-red-400";

            updateChart(arrivals);
        }

        function renderTree() {
            let html = '';
            
            // Draw Segments
            segments.forEach(seg => {
                // Line
                html += `<line x1="${seg.x1}" y1="${seg.y1}" x2="${seg.x2}" y2="${seg.y2}" 
                          stroke="#64748b" stroke-width="4" class="cursor-pointer hover:stroke-yellow-500 transition"
                          onclick="addBuffer('${seg.id}')" />`;
                
                // Draw Buffers
                if (seg.buffers > 0) {
                    // Distribute buffers along line
                    for(let i=1; i<=seg.buffers; i++) {
                        const t = i / (seg.buffers + 1);
                        const bx = seg.x1 + (seg.x2 - seg.x1) * t;
                        const by = seg.y1 + (seg.y2 - seg.y1) * t;
                        // Triangle shape for buffer
                        html += `<path d="M${bx-6},${by-6} L${bx+8},${by} L${bx-6},${by+6} Z" fill="#facc15" stroke="none" class="pointer-events-none" />`;
                    }
                }
            });

            // Draw Sinks
            sinks.forEach(s => {
                html += `<rect x="${s.x-15}" y="${s.y}" width="30" height="30" fill="#1e293b" stroke="#94a3b8" stroke-width="2" />`;
                html += `<text x="${s.x}" y="${s.y+20}" text-anchor="middle" fill="#cbd5e1" font-size="10" font-family="monospace">${s.name}</text>`;
                // Clock pin
                html += `<path d="M${s.x-5},${s.y} L${s.x},${s.y+5} L${s.x+5},${s.y}" fill="none" stroke="#94a3b8" />`;
            });
            
            // Draw Root
            html += `<circle cx="${root.x}" cy="${root.y}" r="8" fill="#facc15" />`;

            svg.innerHTML = html;
        }

        window.addBuffer = function(segId) {
            const seg = getSegment(segId);
            seg.buffers++;
            renderTree();
            recalcTiming();
        };

        window.resetTree = function() {
            segments.forEach(s => s.buffers = 0);
            renderTree();
            recalcTiming();
        };

        // --- Waveform Chart ---
        function initChart() {
            const ctx = document.getElementById('waveChart').getContext('2d');
            waveChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 100}, (_, i) => i),
                    datasets: [
                        { label: 'Source', borderColor: '#facc15', borderWidth: 2, data: [], pointRadius: 0, stepped: true },
                        { label: 'Sink 1', borderColor: '#4ade80', borderWidth: 2, data: [], pointRadius: 0, stepped: true }, // Green
                        { label: 'Sink 4', borderColor: '#60a5fa', borderWidth: 2, data: [], pointRadius: 0, stepped: true }  // Blue
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    scales: {
                        x: { display: false },
                        y: { display: false, min: -0.5, max: 3.5 }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateChart(arrivals) {
            const period = 200; // arbitrary units
            const sourceEdge = 20; 
            
            // Generate Square Waves
            // Ideally: 0 -> 1 at (sourceEdge + delay)
            
            const generateWave = (delay, offsetY) => {
                return Array.from({length: 100}, (_, i) => {
                    const t = i * 5; // time scale
                    const edge = sourceEdge + (delay / 5); // scale delay to chart x
                    return (t > edge && t < edge + 100) ? 1 + offsetY : 0 + offsetY;
                });
            };

            const srcData = generateWave(0, 2); // Top
            const s1Data = generateWave(arrivals[0], 1); // Mid
            const s4Data = generateWave(arrivals[3], 0); // Bot

            // Check if waveChart exists before updating
            if (waveChart) {
                waveChart.data.datasets[0].data = srcData;
                waveChart.data.datasets[1].data = s1Data;
                waveChart.data.datasets[2].data = s4Data;
                waveChart.update();
            }
        }

        // Boot
        init();

    </script>
</body>
</html>
