<!DOCTYPE html>
<html lang="en">
<head>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6672302762343789"
     crossorigin="anonymous"></script>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXZS8C1FLY"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XXZS8C1FLY');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barrel Shifter Lab - EcrioniX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Orbitron:wght@500;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #020617; color: #f8fafc; overflow: hidden; }
        .tech-font { font-family: 'Orbitron', sans-serif; }
        .mono-font { font-family: 'JetBrains Mono', monospace; }

        .watermark {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 8rem; font-weight: 900; color: rgba(99, 102, 241, 0.03);
            pointer-events: none; user-select: none; z-index: 0;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px;
        }

        .tab-btn {
            @apply px-4 py-2 text-xs font-bold rounded-lg transition-all border border-transparent text-slate-400 uppercase tracking-wider;
        }
        .tab-active {
            @apply bg-indigo-600 text-white border-indigo-500 shadow-lg shadow-indigo-500/30;
        }

        /* Mux Visuals */
        .mux-trapezoid { fill: #1e293b; stroke: #64748b; stroke-width: 2; }
        .mux-sel { stroke: #fbbf24; }
        
        .wire { fill: none; stroke: #334155; stroke-width: 2; transition: all 0.2s; }
        .wire-active { stroke: #4ade80; filter: drop-shadow(0 0 3px #4ade80); opacity: 1; }
        .wire-inactive { stroke: #334155; opacity: 0.3; }

        .bit-btn {
            @apply w-8 h-8 rounded border flex items-center justify-center font-bold text-xs transition-all;
        }
        .bit-0 { @apply bg-slate-800 border-slate-600 text-slate-400; }
        .bit-1 { @apply bg-green-600 border-green-500 text-white shadow-lg shadow-green-500/30; }

        /* Theory Styles */
        .prose h1 { @apply text-3xl font-bold text-white mb-6 tech-font border-b border-slate-800 pb-2; }
        .prose h2 { @apply text-xl font-bold text-indigo-400 mt-8 mb-4 uppercase tracking-wider; }
        .prose p { @apply text-slate-400 mb-4 leading-relaxed text-sm; }
        .prose strong { @apply text-white font-semibold; }
        .prose ul { @apply list-disc list-inside space-y-2 text-slate-400 mb-4 text-sm; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col relative">

    <div class="watermark">EcrioniX Logic</div>

    <nav class="border-b border-slate-800 bg-slate-900/80 px-6 py-4 flex justify-between items-center z-20">
        <div>
            <h1 class="text-2xl font-bold text-indigo-400 tech-font uppercase">BARREL <span class="text-white">SHIFTER</span></h1>
            <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Combinational Logic Shifting</p>
        </div>
        
        <div class="flex bg-slate-950 p-1 rounded-xl border border-slate-800">
            <button onclick="switchView('theory')" id="btn-theory" class="tab-btn tab-active">Theory Guide</button>
            <button onclick="switchView('lab')" id="btn-lab" class="tab-btn">Shifter Lab</button>
        </div>

        <button onclick="window.history.back()" class="group flex items-center text-slate-400 hover:text-white transition bg-slate-800/80 px-4 py-2 rounded-lg border border-slate-700 hover:border-indigo-500">
            <span class="text-xs font-bold uppercase">Exit Lab</span>
        </button>
    </nav>

    <div class="flex-grow relative overflow-hidden">
        
        <!-- THEORY VIEW -->
        <div id="view-theory" class="absolute inset-0 z-10 overflow-y-auto p-8 flex justify-center">
            <div class="max-w-4xl w-full glass-panel p-10 prose">
                <h1>The Barrel Shifter Circuit</h1>
                <p>
                    A <strong>Barrel Shifter</strong> is a digital circuit that can shift a data word by a specified number of bits in a single clock cycle. Unlike a standard shift register which shifts one bit per clock cycle, a barrel shifter uses purely combinational logic (Multiplexers) to shift data instantly.
                </p>
                <p>
                    It is a critical component in ALUs (Arithmetic Logic Units) for operations like multiplication, division, and floating-point arithmetic.
                </p>

                <h2>1. Why "Combinational"?</h2>
                <p>
                    Sequential shift registers require $N$ clock cycles to shift $N$ bits. A Barrel Shifter accomplishes this in essentially zero time (gate propagation delay only) by routing the input bits to the correct output positions using a network of multiplexers.
                </p>

                <h2>2. Architecture: The Mux Array</h2>
                <p>
                    A standard $N$-bit barrel shifter is constructed using $\log_2(N)$ stages of multiplexers. For a 4-bit shifter:
                </p>
                <ul class="ml-4">
                    <li><strong>Stage 1 (Controlled by S0):</strong> Shifts data by 1 bit if $S0=1$, or passes through if $S0=0$.</li>
                    <li><strong>Stage 2 (Controlled by S1):</strong> Shifts data by 2 bits if $S1=1$, or passes through if $S1=0$.</li>
                </ul>
                <p>
                    By combining these stages, any shift from 0 to 3 positions can be achieved (e.g., Shift 3 = Shift 2 + Shift 1).
                </p>

                <h2>3. Operation Modes</h2>
                <div class="grid grid-cols-2 gap-4 my-6">
                    <div class="bg-indigo-500/10 border border-indigo-500/50 p-4 rounded-lg">
                        <h3 class="text-white font-bold mb-2 text-center">Logical Shift</h3>
                        <p class="text-xs text-slate-300">
                            <strong>Left (LSL):</strong> Bits move left. Zeros fill in from the right.<br>
                            <strong>Right (LSR):</strong> Bits move right. Zeros fill in from the left.
                        </p>
                    </div>
                    <div class="bg-emerald-500/10 border border-emerald-500/50 p-4 rounded-lg">
                        <h3 class="text-white font-bold mb-2 text-center">Rotate (Circular)</h3>
                        <p class="text-xs text-slate-300">
                            <strong>Rotate Left (ROL):</strong> Bits shifted out from the left wrap around to the right.<br>
                            <strong>Rotate Right (ROR):</strong> Bits shifted out from the right wrap around to the left.
                        </p>
                    </div>
                </div>

                <h2>4. Applications</h2>
                <ul>
                    <li><strong>DSP Processors:</strong> Fast scaling and normalization of data.</li>
                    <li><strong>Floating Point Units:</strong> Aligning mantissas during addition/subtraction.</li>
                    <li><strong>Bit Field Manipulation:</strong> Extracting or packing data packets in networking.</li>
                </ul>
                
                <div class="mt-8 text-center">
                    <button onclick="switchView('lab')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-8 py-3 rounded-xl font-bold transition shadow-lg shadow-indigo-500/20">Launch Experiment &rarr;</button>
                </div>
            </div>
        </div>

        <!-- LAB VIEW -->
        <div id="view-lab" class="absolute inset-0 z-0 opacity-0 pointer-events-none flex p-6 gap-6">
            
            <!-- Left: Controls -->
            <div class="w-80 flex flex-col gap-4 overflow-y-auto pr-2">
                
                <!-- Input Data -->
                <div class="glass-panel p-6">
                    <h2 class="text-indigo-400 font-bold mb-4 uppercase text-[10px] tracking-widest">Data Input (4-Bit)</h2>
                    <div class="flex justify-between font-mono text-xs text-slate-400 mb-2 px-2">
                        <span>D3</span><span>D2</span><span>D1</span><span>D0</span>
                    </div>
                    <div class="flex justify-between gap-2">
                        <button onclick="toggleBit(3)" id="btn-d3" class="bit-btn bit-0 flex-1">0</button>
                        <button onclick="toggleBit(2)" id="btn-d2" class="bit-btn bit-0 flex-1">0</button>
                        <button onclick="toggleBit(1)" id="btn-d1" class="bit-btn bit-0 flex-1">0</button>
                        <button onclick="toggleBit(0)" id="btn-d0" class="bit-btn bit-0 flex-1">0</button>
                    </div>
                    <div class="text-center mt-2 text-xs font-mono text-slate-500">Value: <span id="val-dec" class="text-white">0</span> (0x<span id="val-hex">0</span>)</div>
                </div>

                <!-- Shift Control -->
                <div class="glass-panel p-6">
                    <h2 class="text-emerald-400 font-bold mb-4 uppercase text-[10px] tracking-widest">Shift Control</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-slate-300 font-bold">Shift Amount</span>
                                <span id="val-shift" class="font-mono text-white font-bold">0</span>
                            </div>
                            <input type="range" id="slider-shift" min="0" max="3" step="1" value="0" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                        </div>

                        <div>
                            <span class="text-xs text-slate-300 font-bold block mb-2">Operation Mode</span>
                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="setOpMode('LSL')" id="btn-LSL" class="py-2 rounded bg-slate-800 border border-slate-600 text-xs font-bold text-slate-400 hover:text-white">LSL (<<)</button>
                                <button onclick="setOpMode('LSR')" id="btn-LSR" class="py-2 rounded bg-slate-800 border border-slate-600 text-xs font-bold text-slate-400 hover:text-white">LSR (>>)</button>
                                <button onclick="setOpMode('ROL')" id="btn-ROL" class="py-2 rounded bg-slate-800 border border-slate-600 text-xs font-bold text-slate-400 hover:text-white">ROL (<~)</button>
                                <button onclick="setOpMode('ROR')" id="btn-ROR" class="py-2 rounded bg-slate-800 border border-slate-600 text-xs font-bold text-slate-400 hover:text-white">ROR (~>)</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Output Display -->
                <div class="glass-panel p-6 flex-grow flex flex-col">
                    <h2 class="text-yellow-400 font-bold mb-4 uppercase text-[10px] tracking-widest">Output Result</h2>
                    <div class="flex justify-center gap-2 mb-2">
                        <div id="out-3" class="w-10 h-10 rounded border border-slate-600 bg-slate-900 flex items-center justify-center font-bold text-white transition-all">0</div>
                        <div id="out-2" class="w-10 h-10 rounded border-slate-600 bg-slate-900 flex items-center justify-center font-bold text-white border transition-all">0</div>
                        <div id="out-1" class="w-10 h-10 rounded border-slate-600 bg-slate-900 flex items-center justify-center font-bold text-white border transition-all">0</div>
                        <div id="out-0" class="w-10 h-10 rounded border-slate-600 bg-slate-900 flex items-center justify-center font-bold text-white border transition-all">0</div>
                    </div>
                    <div class="mt-auto pt-4 border-t border-slate-700 text-center">
                         <button onclick="resetLab()" class="text-xs text-red-400 hover:text-red-300 font-bold uppercase tracking-wider">Reset All</button>
                    </div>
                </div>
            </div>

            <!-- Right: Schematic -->
            <div class="flex-grow glass-panel relative flex flex-col p-1 overflow-hidden">
                <div class="absolute top-4 left-4 z-10 px-3 py-1 bg-black/60 rounded text-[10px] text-slate-400 border border-slate-700 font-bold uppercase tracking-widest">
                    2-Stage Mux Array
                </div>

                <div class="flex-grow flex items-center justify-center relative bg-slate-900/50">
                    <svg id="shifter-svg" width="800" height="500" viewBox="0 0 800 500">
                        <defs>
                            <g id="mux-2to1">
                                <path d="M0,0 L30,10 V50 L0,60 Z" class="mux-trapezoid" />
                                <text x="10" y="35" class="comp-text" font-size="8" fill="white">MUX</text>
                                <text x="2" y="15" class="comp-text" font-size="6" fill="#94a3b8">1</text>
                                <text x="2" y="50" class="comp-text" font-size="6" fill="#94a3b8">0</text>
                            </g>
                        </defs>

                        <!-- STAGE 1 (Shift 1) -->
                        <g transform="translate(250, 50)">
                            <text x="15" y="-10" fill="#64748b" font-size="10">STAGE 1 (Shift 1)</text>
                            <!-- Muxes -->
                            <g transform="translate(0, 0)" id="mux1-3"><use href="#mux-2to1"/></g>
                            <g transform="translate(0, 80)" id="mux1-2"><use href="#mux-2to1"/></g>
                            <g transform="translate(0, 160)" id="mux1-1"><use href="#mux-2to1"/></g>
                            <g transform="translate(0, 240)" id="mux1-0"><use href="#mux-2to1"/></g>
                            
                            <!-- S0 Line -->
                            <line x1="15" y1="300" x2="15" y2="330" class="mux-sel" stroke-width="2" />
                            <text x="15" y="345" text-anchor="middle" fill="#fbbf24" font-size="10">S0</text>
                        </g>

                        <!-- STAGE 2 (Shift 2) -->
                        <g transform="translate(500, 50)">
                            <text x="15" y="-10" fill="#64748b" font-size="10">STAGE 2 (Shift 2)</text>
                            <g transform="translate(0, 0)" id="mux2-3"><use href="#mux-2to1"/></g>
                            <g transform="translate(0, 80)" id="mux2-2"><use href="#mux-2to1"/></g>
                            <g transform="translate(0, 160)" id="mux2-1"><use href="#mux-2to1"/></g>
                            <g transform="translate(0, 240)" id="mux2-0"><use href="#mux-2to1"/></g>
                            
                             <!-- S1 Line -->
                            <line x1="15" y1="300" x2="15" y2="330" class="mux-sel" stroke-width="2" />
                            <text x="15" y="345" text-anchor="middle" fill="#fbbf24" font-size="10">S1</text>
                        </g>

                        <!-- Inputs -->
                        <g transform="translate(50, 50)">
                            <text x="100" y="35" text-anchor="end" fill="white" font-size="12">D3</text>
                            <text x="100" y="115" text-anchor="end" fill="white" font-size="12">D2</text>
                            <text x="100" y="195" text-anchor="end" fill="white" font-size="12">D1</text>
                            <text x="100" y="275" text-anchor="end" fill="white" font-size="12">D0</text>
                        </g>
                        
                        <!-- Wires Stage 1 Inputs (Hardcoded for LSL demo structure, logic will illuminate paths) -->
                        <!-- Input lines D3..D0 -->
                        <line x1="120" y1="80" x2="250" y2="80" class="wire" id="w-in-3" />
                        <line x1="120" y1="160" x2="250" y2="160" class="wire" id="w-in-2" />
                        <line x1="120" y1="240" x2="250" y2="240" class="wire" id="w-in-1" />
                        <line x1="120" y1="320" x2="250" y2="320" class="wire" id="w-in-0" />
                        
                        <!-- Interstage Wires (Straight) -->
                        <line x1="280" y1="80" x2="500" y2="80" class="wire" id="w-mid-3" />
                        <line x1="280" y1="160" x2="500" y2="160" class="wire" id="w-mid-2" />
                        <line x1="280" y1="240" x2="500" y2="240" class="wire" id="w-mid-1" />
                        <line x1="280" y1="320" x2="500" y2="320" class="wire" id="w-mid-0" />
                        
                        <!-- Output Wires -->
                        <line x1="530" y1="80" x2="650" y2="80" class="wire" id="w-out-3" />
                        <line x1="530" y1="160" x2="650" y2="160" class="wire" id="w-out-2" />
                        <line x1="530" y1="240" x2="650" y2="240" class="wire" id="w-out-1" />
                        <line x1="530" y1="320" x2="650" y2="320" class="wire" id="w-out-0" />

                        <!-- Shift Wires (Diagonals) - Dynamic via JS drawing or static paths hidden/shown -->
                        <!-- We will draw active paths dynamically using JS to avoid clutter -->
                        <g id="dynamic-paths"></g>
                        
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- State ---
        let data = [0, 0, 0, 0]; // D3, D2, D1, D0
        let shiftAmt = 0;
        let opMode = 'LSL'; // LSL, LSR, ROL, ROR

        // --- DOM ---
        const sliderShift = document.getElementById('slider-shift');
        const valShift = document.getElementById('val-shift');
        const dynamicPaths = document.getElementById('dynamic-paths');
        
        // --- Helpers ---
        function switchView(v) {
            const theory = document.getElementById('view-theory');
            const lab = document.getElementById('view-lab');
            const btnT = document.getElementById('btn-theory');
            const btnL = document.getElementById('btn-lab');

            if (v === 'theory') {
                theory.classList.remove('opacity-0', 'pointer-events-none'); theory.classList.add('z-10');
                lab.classList.add('opacity-0', 'pointer-events-none'); lab.classList.remove('z-10');
                btnT.classList.add('tab-active'); btnL.classList.remove('tab-active');
            } else {
                lab.classList.remove('opacity-0', 'pointer-events-none'); lab.classList.add('z-10');
                theory.classList.add('opacity-0', 'pointer-events-none'); theory.classList.remove('z-10');
                btnL.classList.add('tab-active'); btnT.classList.remove('tab-active');
            }
        }

        function toggleBit(idx) {
            data[idx] = data[idx] ? 0 : 1;
            updateUI();
        }

        function setOpMode(mode) {
            opMode = mode;
            ['LSL','LSR','ROL','ROR'].forEach(m => {
                const btn = document.getElementById(`btn-${m}`);
                if(m === mode) {
                    btn.classList.add('bg-indigo-600', 'text-white', 'border-indigo-500');
                    btn.classList.remove('bg-slate-800', 'text-slate-400');
                } else {
                    btn.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-500');
                    btn.classList.add('bg-slate-800', 'text-slate-400');
                }
            });
            updateUI();
        }

        sliderShift.addEventListener('input', (e) => {
            shiftAmt = parseInt(e.target.value);
            valShift.innerText = shiftAmt;
            updateUI();
        });

        function resetLab() {
            data = [0,0,0,0];
            shiftAmt = 0;
            sliderShift.value = 0;
            valShift.innerText = 0;
            setOpMode('LSL');
        }

        // --- Logic Engine ---
        function calculateOutput() {
            let out = [...data];
            // 4-bit array: [D3, D2, D1, D0]
            
            // Convert to int
            let val = parseInt(data.join(''), 2);
            
            if (opMode === 'LSL') {
                val = (val << shiftAmt) & 0xF;
            } else if (opMode === 'LSR') {
                val = (val >>> shiftAmt);
            } else if (opMode === 'ROL') {
                // (val << s) | (val >> (4-s))
                val = ((val << shiftAmt) | (val >>> (4 - shiftAmt))) & 0xF;
            } else if (opMode === 'ROR') {
                val = ((val >>> shiftAmt) | (val << (4 - shiftAmt))) & 0xF;
            }
            
            // Back to array
            return val.toString(2).padStart(4, '0').split('').map(Number);
        }

        function updateUI() {
            // Update Data Buttons
            for(let i=0; i<4; i++) {
                const btn = document.getElementById(`btn-d${i}`);
                if(data[i]) btn.className = "bit-btn bit-1 flex-1";
                else btn.className = "bit-btn bit-0 flex-1";
                btn.innerText = data[i];
            }
            
            // Dec/Hex values
            const val = parseInt(data.join(''), 2);
            document.getElementById('val-dec').innerText = val;
            document.getElementById('val-hex').innerText = val.toString(16).toUpperCase();

            // Calculate Output
            const outData = calculateOutput();
            
            // Update Output Display
            for(let i=0; i<4; i++) {
                const div = document.getElementById(`out-${3-i}`); // out-3 corresponds to index 0
                div.innerText = outData[i];
                if(outData[i]) {
                    div.className = "w-10 h-10 rounded border border-green-500 bg-green-900 text-green-300 flex items-center justify-center font-bold transition-all shadow-[0_0_10px_#22c55e]";
                } else {
                    div.className = "w-10 h-10 rounded border border-slate-600 bg-slate-900 text-slate-500 flex items-center justify-center font-bold transition-all";
                }
            }

            drawSchematicConnections(outData);
        }

        // --- Visualization Engine ---
        function drawSchematicConnections(finalData) {
            // Clear dynamic paths
            dynamicPaths.innerHTML = '';
            
            // Coordinates based on SVG layout
            // Inputs: x=120, y=80,160,240,320 (Top to Bottom: D3, D2, D1, D0)
            // Stage 1 Mux In: x=250. Out: x=280.
            // Stage 2 Mux In: x=500. Out: x=530.
            // Finals: x=650.
            
            // 1. Draw Input State
            // Highlight Input wires based on data
            ['w-in-3','w-in-2','w-in-1','w-in-0'].forEach((id, i) => {
                const el = document.getElementById(id);
                if(data[i]) el.classList.replace('wire', 'wire-active'); // i=0 is D3
                else el.classList.replace('wire-active', 'wire');
            });
            
            // 2. Calculate Stage 1 (Shift 1 bit or 0)
            // S0 determines shift 1.
            const s0 = shiftAmt & 1; 
            const s1 = (shiftAmt >> 1) & 1;

            let stage1Data = [...data]; // Default pass through
            
            // Draw Stage 1 Logic Paths
            // We need to draw lines from specific inputs to specific mux ports based on Mode & Shift
            
            // Helper to draw a line
            const drawLine = (x1, y1, x2, y2, active) => {
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                // Bezier curve for smoothness
                const d = `M${x1},${y1} C${(x1+x2)/2},${y1} ${(x1+x2)/2},${y2} ${x2},${y2}`;
                path.setAttribute("d", d);
                path.setAttribute("class", active ? "wire wire-active" : "wire");
                path.setAttribute("stroke-width", "2");
                path.setAttribute("fill", "none");
                dynamicPaths.appendChild(path);
            };

            // Logic Simulation for Stage 1 (S0)
            // This visualizes the connections inside the muxes
            // For a mux at bit position i:
            // Input 0 comes from bit i (Pass)
            // Input 1 comes from bit i+/-1 (Shift) based on Mode
            
            // Visualizing full connectivity is complex. Let's visualize the *Active Path* only.
            
            // Step 1: Input -> Stage 1 Output
            let intermediate = [0,0,0,0];
            
            for(let i=0; i<4; i++) {
                // i maps to D3, D2...
                // Target Y for mux i: 80 + i*80
                const targetY = 80 + i*80; 
                let sourceIdx = i; // Default pass through
                
                if (s0) {
                    if (opMode === 'LSL') sourceIdx = i + 1; // Left shift pulls from lower index (visually below)
                    if (opMode === 'LSR') sourceIdx = i - 1; 
                    if (opMode === 'ROL') sourceIdx = (i + 1) % 4;
                    if (opMode === 'ROR') sourceIdx = (i - 1 + 4) % 4;
                }

                // Boundary check for Logical shifts
                let val = 0;
                if (sourceIdx >= 0 && sourceIdx < 4) {
                    val = data[sourceIdx];
                    // Draw line from source Y to Mux In
                    const sourceY = 80 + sourceIdx*80;
                    drawLine(120, sourceY, 250, targetY, val === 1);
                } else {
                    // Pulling in 0 (Ground)
                    val = 0;
                }
                intermediate[i] = val;
            }

            // Step 2: Stage 1 Out -> Stage 2 In
            // Draw Intermediate wires
            ['w-mid-3','w-mid-2','w-mid-1','w-mid-0'].forEach((id, i) => {
                const el = document.getElementById(id);
                if(intermediate[i]) el.classList.replace('wire', 'wire-active');
                else el.classList.replace('wire-active', 'wire');
            });

            // Step 3: Stage 2 Logic (S1 - Shift 2)
            for(let i=0; i<4; i++) {
                const targetY = 80 + i*80; 
                let sourceIdx = i;
                
                if (s1) {
                    if (opMode === 'LSL') sourceIdx = i + 2; 
                    if (opMode === 'LSR') sourceIdx = i - 2; 
                    if (opMode === 'ROL') sourceIdx = (i + 2) % 4;
                    if (opMode === 'ROR') sourceIdx = (i - 2 + 4) % 4;
                }

                let val = 0;
                if (sourceIdx >= 0 && sourceIdx < 4) {
                    val = intermediate[sourceIdx];
                    const sourceY = 80 + sourceIdx*80;
                    // Draw from end of stage 1 wire (x=500) to mux input (x=500, but logic handles connection)
                    // Wait, Mux 2 is at 500. Mid wires go 280 -> 500.
                    // The mux chooses between direct (500,y) or shifted input.
                    // We need to draw the shift connection if S1 is active.
                    if (s1) {
                         drawLine(400, sourceY, 500, targetY, val === 1); // Start mid-wire to input
                    }
                }
            }

            // Final Output Wires
             ['w-out-3','w-out-2','w-out-1','w-out-0'].forEach((id, i) => {
                const el = document.getElementById(id);
                if(finalData[i]) el.classList.replace('wire', 'wire-active');
                else el.classList.replace('wire-active', 'wire');
            });
        }

        // Init
        setOpMode('LSL');
        updateUI();

    </script>
</body>
</html>
