<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6672302762343789"
     crossorigin="anonymous"></script>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXZS8C1FLY"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XXZS8C1FLY');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDC & Metastability Lab - EcrioniX Labs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Orbitron:wght@500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .tech-font { font-family: 'Orbitron', sans-serif; }
        .code-font { font-family: 'JetBrains Mono', monospace; }
        
        /* Watermark */
        .watermark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 5rem;
            font-weight: 900;
            color: rgba(99, 102, 241, 0.08);
            pointer-events: none;
            user-select: none;
            white-space: nowrap;
            z-index: 9999;
        }

        /* Waveform Canvas */
        .wave-screen {
            background-color: #111827;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            border: 1px solid #374151;
            border-radius: 6px;
        }

        /* Logic Gates / FFs */
        .ff-box {
            fill: #1e293b;
            stroke: #94a3b8;
            stroke-width: 2;
        }
        .ff-text { font-family: sans-serif; font-size: 10px; fill: #cbd5e1; }
        
        /* Domain coloring */
        .domain-a { stroke: #eab308; fill: none; stroke-width: 2; } /* Yellow */
        .domain-b { stroke: #3b82f6; fill: none; stroke-width: 2; } /* Blue */
        .meta-wire { stroke: #ef4444; stroke-width: 2; stroke-dasharray: 4; animation: buzz 0.2s infinite; }
        
        @keyframes buzz {
            0% { transform: translateX(0); opacity: 1; }
            50% { transform: translateX(1px); opacity: 0.7; }
            100% { transform: translateX(0); opacity: 1; }
        }

        /* Glitch Effect Text */
        .glitch-text {
            color: #ef4444;
            font-weight: bold;
            animation: flash 0.5s;
        }
        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.2; } 100% { opacity: 1; } }

        /* Sliders */
        input[type=range] {
            accent-color: #6366f1;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex flex-col relative overflow-x-hidden">

    <div class="watermark">EcrioniX Labs</div>

    <div class="max-w-[1400px] mx-auto w-full flex-grow relative z-10">
        
        <!-- Navigation -->
        <div class="flex justify-between items-start mb-2">
            <button onclick="window.history.back()" class="group flex items-center text-gray-500 hover:text-white transition-colors duration-200">
                <div class="w-8 h-8 rounded-full bg-gray-800 border border-gray-700 flex items-center justify-center group-hover:border-indigo-500 group-hover:bg-indigo-900/20 mr-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                </div>
                <span class="text-sm font-bold tracking-wide group-hover:text-indigo-400">EXIT LAB</span>
            </button>
        </div>

        <!-- Header -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-8 border-b border-gray-700 pb-4">
            <div>
                <h1 class="text-3xl font-bold text-white tech-font tracking-wide">CDC VERIFICATION <span class="text-indigo-500 text-sm align-top">LAB</span></h1>
                <p class="text-gray-400 text-sm">Clock Domain Crossing & Metastability Analysis</p>
            </div>
            <div class="mt-4 md:mt-0 flex items-center space-x-6">
                 <div class="text-right">
                    <div class="text-[10px] uppercase text-gray-500 font-bold">Calculated MTBF</div>
                    <div id="mtbf-display" class="text-green-400 font-mono text-xl font-bold">HIGH</div>
                 </div>
                 <div class="h-8 w-px bg-gray-700"></div>
                 <div class="text-right">
                    <div class="text-[10px] uppercase text-gray-500 font-bold">Failures Detected</div>
                    <div id="fail-counter" class="text-red-400 font-mono text-xl font-bold">0</div>
                 </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- LEFT COLUMN: Controls & Logic (4 cols) -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- Configuration Panel -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 shadow-lg">
                    <h2 class="text-sm font-bold text-white mb-6 flex items-center">
                        <svg class="w-4 h-4 mr-2 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                        DOMAIN CONFIGURATION
                    </h2>

                    <!-- Source Domain A -->
                    <div class="mb-6 p-4 bg-gray-900/50 rounded border border-yellow-900/30">
                        <div class="flex justify-between text-xs mb-2">
                            <span class="text-yellow-500 font-bold">SOURCE DOMAIN (A)</span>
                            <span id="disp-freq-a" class="font-mono text-gray-300">100 MHz</span>
                        </div>
                        <input type="range" id="freq-a" min="20" max="200" value="100" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                    </div>

                    <!-- Dest Domain B -->
                    <div class="mb-6 p-4 bg-gray-900/50 rounded border border-blue-900/30">
                        <div class="flex justify-between text-xs mb-2">
                            <span class="text-blue-500 font-bold">DESTINATION DOMAIN (B)</span>
                            <span id="disp-freq-b" class="font-mono text-gray-300">75 MHz</span>
                        </div>
                        <input type="range" id="freq-b" min="20" max="200" value="75" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                    </div>

                    <!-- Synchronizer Stages -->
                    <div class="mb-4">
                        <label class="text-xs font-bold text-gray-400 mb-2 block">SYNCHRONIZER STAGES</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button onclick="setStages(1)" id="btn-s1" class="btn-stage p-2 rounded text-xs font-bold border border-red-900 bg-red-900/20 text-red-400 hover:bg-red-900/40">1 STAGE (Unsafe)</button>
                            <button onclick="setStages(2)" id="btn-s2" class="btn-stage p-2 rounded text-xs font-bold border border-gray-600 bg-gray-700 text-white ring-2 ring-indigo-500">2 STAGES</button>
                            <button onclick="setStages(3)" id="btn-s3" class="btn-stage p-2 rounded text-xs font-bold border border-gray-600 bg-gray-700 text-gray-300 hover:bg-gray-600">3 STAGES</button>
                        </div>
                    </div>
                </div>

                <!-- Theory Box -->
                <div class="bg-gray-800 rounded-xl p-6 border border-gray-700 shadow-lg">
                    <h3 class="text-xs font-bold text-gray-400 mb-2 uppercase">Analysis</h3>
                    <p class="text-sm text-gray-300 leading-relaxed mb-2">
                        <span class="text-yellow-400">Setup/Hold Violation:</span> When Data changes inside the capture window of CLK_B, the FF output becomes 
                        <span class="text-red-400 font-bold">METASTABLE</span> (oscillating).
                    </p>
                    <p class="text-sm text-gray-300 leading-relaxed">
                        <span class="text-green-400">Solution:</span> A multi-stage synchronizer allows time for the metastable state to settle to a valid '0' or '1' before propagation.
                    </p>
                    <p class="text-sm text-gray-300 leading-relaxed mt-2">
                        <span class="text-indigo-400">MTBF (Mean Time Between Failures):</span> Increases exponentially with each flip-flop stage added.
                    </p>
                </div>

            </div>

            <!-- RIGHT COLUMN: Visualization (8 cols) -->
            <div class="lg:col-span-8 space-y-6">
                
                <!-- 1. Schematic Visualization -->
                <div class="bg-gray-800 rounded-xl shadow-xl border border-gray-700 p-1 relative">
                    <div class="absolute top-2 left-3 text-[10px] font-bold text-gray-500 tracking-widest">LOGIC SCHEMATIC</div>
                    <div class="bg-gray-900 h-64 w-full rounded-lg mt-6 flex items-center justify-center overflow-hidden relative">
                        <!-- SVG Diagram -->
                        <svg id="schematic-svg" width="100%" height="100%" viewBox="0 0 800 250">
                            <!-- Background Domains -->
                            <rect x="10" y="10" width="250" height="230" fill="rgba(234, 179, 8, 0.05)" rx="10" />
                            <text x="30" y="30" fill="#eab308" font-family="monospace" font-size="12">DOMAIN A (SRC)</text>

                            <rect x="270" y="10" width="520" height="230" fill="rgba(59, 130, 246, 0.05)" rx="10" />
                            <text x="290" y="30" fill="#3b82f6" font-family="monospace" font-size="12">DOMAIN B (DEST)</text>

                            <!-- Source FF -->
                            <g transform="translate(150, 100)">
                                <rect x="0" y="0" width="50" height="60" class="ff-box" />
                                <text x="25" y="35" text-anchor="middle" class="ff-text">SRC_FF</text>
                                <path d="M0,50 L10,40 L0,30" fill="none" stroke="#94a3b8" /> <!-- Clk Tri -->
                                <line x1="25" y1="60" x2="25" y2="80" stroke="#eab308" stroke-width="2"/> <!-- CLK A -->
                                <text x="25" y="95" text-anchor="middle" class="ff-text" fill="#eab308">CLK_A</text>
                                <line x1="-30" y1="15" x2="0" y2="15" stroke="#94a3b8" /> <!-- D -->
                                <line x1="50" y1="15" x2="100" y2="15" stroke="#eab308" stroke-width="2" /> <!-- Q -->
                            </g>

                            <!-- The Long Path (CDC) -->
                            <line id="cdc-wire" x1="250" y1="115" x2="350" y2="115" stroke="#ef4444" stroke-width="2" stroke-dasharray="5,5" />
                            <text x="300" y="105" text-anchor="middle" font-size="10" fill="#ef4444">ASYNC PATH</text>

                            <!-- Dest FF 1 (Sync 1) -->
                            <g transform="translate(350, 100)">
                                <rect x="0" y="0" width="50" height="60" class="ff-box" id="ff1-box"/>
                                <text x="25" y="35" text-anchor="middle" class="ff-text">SYNC_1</text>
                                <path d="M0,50 L10,40 L0,30" fill="none" stroke="#94a3b8" />
                                <line x1="25" y1="60" x2="25" y2="80" stroke="#3b82f6" stroke-width="2"/>
                                <text x="25" y="95" text-anchor="middle" class="ff-text" fill="#3b82f6">CLK_B</text>
                                
                                <line x1="50" y1="15" x2="100" y2="15" stroke="#3b82f6" stroke-width="2" id="wire-s1"/>
                            </g>

                            <!-- Dest FF 2 (Sync 2) -->
                            <g transform="translate(450, 100)" id="stage-2-grp">
                                <rect x="0" y="0" width="50" height="60" class="ff-box" id="ff2-box"/>
                                <text x="25" y="35" text-anchor="middle" class="ff-text">SYNC_2</text>
                                <path d="M0,50 L10,40 L0,30" fill="none" stroke="#94a3b8" />
                                <line x1="25" y1="60" x2="25" y2="80" stroke="#3b82f6" stroke-width="2"/>
                                <line x1="50" y1="15" x2="100" y2="15" stroke="#3b82f6" stroke-width="2" id="wire-s2"/>
                            </g>

                            <!-- Dest FF 3 (Sync 3) -->
                            <g transform="translate(550, 100)" id="stage-3-grp" opacity="0">
                                <rect x="0" y="0" width="50" height="60" class="ff-box" id="ff3-box"/>
                                <text x="25" y="35" text-anchor="middle" class="ff-text">SYNC_3</text>
                                <path d="M0,50 L10,40 L0,30" fill="none" stroke="#94a3b8" />
                                <line x1="25" y1="60" x2="25" y2="80" stroke="#3b82f6" stroke-width="2"/>
                                <line x1="50" y1="15" x2="100" y2="15" stroke="#3b82f6" stroke-width="2" id="wire-s3"/>
                            </g>

                            <!-- Output -->
                            <text x="670" y="120" font-family="monospace" font-size="14" fill="#a5f3fc" id="out-label">SAFE DATA</text>

                        </svg>
                        
                        <!-- Visual Glitch Overlay -->
                        <div id="glitch-overlay" class="absolute inset-0 bg-red-500/20 pointer-events-none hidden"></div>
                    </div>
                </div>

                <!-- 2. Waveform Viewer -->
                <div class="bg-gray-900 rounded-xl border border-gray-700 overflow-hidden">
                    <div class="bg-gray-800 px-4 py-2 border-b border-gray-700 flex justify-between items-center">
                        <span class="text-xs font-bold text-gray-300">REAL-TIME WAVEFORMS</span>
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center"><div class="w-2 h-2 bg-yellow-500 rounded-full mr-1"></div><span class="text-[10px] text-gray-400">CLK A</span></div>
                            <div class="flex items-center"><div class="w-2 h-2 bg-blue-500 rounded-full mr-1"></div><span class="text-[10px] text-gray-400">CLK B</span></div>
                            <div class="flex items-center"><div class="w-2 h-2 bg-red-500 rounded-full mr-1"></div><span class="text-[10px] text-gray-400">GLITCH</span></div>
                        </div>
                    </div>
                    <div class="p-2 relative">
                        <canvas id="waveCanvas" height="250" width="800" class="wave-screen w-full"></canvas>
                        <!-- Labels -->
                        <div class="absolute left-4 top-4 space-y-7 pointer-events-none">
                            <div class="text-[10px] font-mono text-yellow-500">CLK_A</div>
                            <div class="text-[10px] font-mono text-yellow-300">DATA_A</div>
                            <div class="text-[10px] font-mono text-blue-500">CLK_B</div>
                            <div class="text-[10px] font-mono text-red-400">ASYNC_IN</div>
                            <div class="text-[10px] font-mono text-indigo-300">SYNC_1</div>
                            <div class="text-[10px] font-mono text-green-400">SYNC_OUT</div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-12 py-6 border-t border-gray-800 text-center relative z-10 bg-gray-900/80 backdrop-blur-sm">
        <p class="text-gray-400 font-semibold mb-1">Owned & Operated by Elangovan</p>
        <p class="text-gray-600 text-sm">Â© 2026 EcrioniX Labs. All rights reserved.</p>
    </footer>

    <script>
        // --- Simulation Constants ---
        const VIOLATION_WINDOW = 4; // Arbitrary time units for setup/hold check
        const CANVAS_WIDTH = 800;
        const HISTORY_LEN = 600;

        // --- State ---
        let stages = 2;
        let freqA = 100;
        let freqB = 75;
        let failures = 0;

        // Signals (0 or 1, except metastable which is 0.5)
        let sigClkA = 0;
        let sigDataA = 0;
        let sigClkB = 0;
        let sigAsyncIn = 0; // The wire value
        let sigSync1 = 0;
        let sigSync2 = 0;
        let sigSync3 = 0;

        // Timing
        let time = 0;
        let lastClkATime = 0;
        let lastClkBTime = 0;
        let lastDataChangeTime = -999;
        
        // Signal History for Canvas
        const history = [];

        // DOM Elements
        const canvas = document.getElementById('waveCanvas');
        const ctx = canvas.getContext('2d');
        const sliderFreqA = document.getElementById('freq-a');
        const sliderFreqB = document.getElementById('freq-b');
        const dispFreqA = document.getElementById('disp-freq-a');
        const dispFreqB = document.getElementById('disp-freq-b');
        const failCounter = document.getElementById('fail-counter');
        const mtbfDisplay = document.getElementById('mtbf-display');
        const glitchOverlay = document.getElementById('glitch-overlay');
        const cdcWire = document.getElementById('cdc-wire');

        // SVG Groups
        const grpStage2 = document.getElementById('stage-2-grp');
        const grpStage3 = document.getElementById('stage-3-grp');
        const boxFF1 = document.getElementById('ff1-box');
        const boxFF2 = document.getElementById('ff2-box');

        // --- configuration ---
        function setStages(n) {
            stages = n;
            // Update UI Buttons
            [1,2,3].forEach(i => {
                const btn = document.getElementById(`btn-s${i}`);
                if(i === n) {
                    btn.classList.add('ring-2', 'ring-indigo-500', 'bg-gray-600');
                    btn.classList.remove('text-gray-300');
                    btn.classList.add('text-white');
                } else {
                    btn.classList.remove('ring-2', 'ring-indigo-500', 'bg-gray-600', 'text-white');
                    btn.classList.add('text-gray-300');
                }
            });

            // Update SVG Visibility
            if(n === 1) {
                grpStage2.style.opacity = 0;
                grpStage3.style.opacity = 0;
                document.getElementById('out-label').setAttribute('x', '420');
            } else if (n === 2) {
                grpStage2.style.opacity = 1;
                grpStage3.style.opacity = 0;
                document.getElementById('out-label').setAttribute('x', '520');
            } else {
                grpStage2.style.opacity = 1;
                grpStage3.style.opacity = 1;
                document.getElementById('out-label').setAttribute('x', '620');
            }
            updateMTBF();
        }

        function updateMTBF() {
            // Simplified MTBF concept logic for display
            // MTBF ~ e^(stages) / (fA * fB)
            const fA = parseInt(sliderFreqA.value);
            const fB = parseInt(sliderFreqB.value);
            
            let status = "HIGH";
            let color = "text-green-400";

            if (stages === 1) {
                status = "CRITICAL";
                color = "text-red-500";
            } else if (stages === 2) {
                if (Math.abs(fA - fB) < 10 || fA > 150) {
                    status = "MODERATE";
                    color = "text-yellow-400";
                } else {
                    status = "GOOD";
                    color = "text-green-400";
                }
            } else {
                status = "EXCELLENT";
                color = "text-indigo-400";
            }
            
            mtbfDisplay.innerText = status;
            mtbfDisplay.className = `font-mono text-xl font-bold ${color}`;
        }

        // --- Simulation Core ---
        function step() {
            time++;

            // Update Freqs
            freqA = parseInt(sliderFreqA.value);
            freqB = parseInt(sliderFreqB.value);
            dispFreqA.innerText = freqA + " MHz";
            dispFreqB.innerText = freqB + " MHz";
            updateMTBF();

            // Clock Periods (Inverse logic: higher slider = shorter period)
            const periodA = Math.max(5, 205 - freqA); 
            const periodB = Math.max(5, 205 - freqB);

            // 1. Generate Clocks
            let prevClkA = sigClkA;
            let prevClkB = sigClkB;

            if ((time - lastClkATime) >= periodA/2) {
                sigClkA = !sigClkA;
                lastClkATime = time;
            }
            if ((time - lastClkBTime) >= periodB/2) {
                sigClkB = !sigClkB;
                lastClkBTime = time;
            }

            // 2. Source Domain Logic (Random Data Toggle)
            if (sigClkA && !prevClkA) { // Rising Edge A
                // 10% chance to toggle data
                if (Math.random() < 0.1) {
                    sigDataA = !sigDataA;
                    lastDataChangeTime = time;
                }
            }
            
            // Wire Delay (Instant in simulation)
            sigAsyncIn = sigDataA;

            // 3. Destination Domain Logic (Sampling & Metastability)
            let isMetastableEvent = false;

            if (sigClkB && !prevClkB) { // Rising Edge B
                
                // CHECK FOR VIOLATION
                // Did data change very close to this clock edge?
                const timeDelta = Math.abs(time - lastDataChangeTime);
                
                if (timeDelta < VIOLATION_WINDOW) {
                    isMetastableEvent = true;
                    // Visual Flash
                    cdcWire.style.stroke = "#ef4444";
                    cdcWire.style.strokeWidth = "4";
                    setTimeout(() => { cdcWire.style.stroke = "#ef4444"; cdcWire.style.strokeWidth = "2"; }, 100);
                } else {
                    cdcWire.style.stroke = "#ef4444";
                }

                // Propagate Logic
                
                // Stage 3 samples Stage 2
                sigSync3 = (sigSync2 === 0.5) ? (Math.random()>0.5?1:0) : sigSync2; 

                // Stage 2 samples Stage 1
                // If Stage 1 is metastable (0.5), Stage 2 has a chance to resolve or stay bad
                if (sigSync1 === 0.5) {
                    // Small chance to propagate metastability through stage 2
                    sigSync2 = (Math.random() < 0.2) ? 0.5 : (Math.random()>0.5?1:0);
                } else {
                    sigSync2 = sigSync1;
                }

                // Stage 1 samples Async Input
                if (isMetastableEvent) {
                    sigSync1 = 0.5; // ENTER METASTABILITY
                    boxFF1.style.stroke = "#ef4444"; // Visual red border
                } else {
                    sigSync1 = sigAsyncIn ? 1 : 0;
                    boxFF1.style.stroke = "#94a3b8";
                }
            }

            // Resolve Metastability over time (Physics simulation)
            // If a signal is 0.5, it randomly decays to 0 or 1 between clocks
            if (sigSync1 === 0.5 && Math.random() < 0.05) sigSync1 = Math.random()>0.5?1:0;
            if (sigSync2 === 0.5 && Math.random() < 0.1) sigSync2 = Math.random()>0.5?1:0; // Stage 2 resolves faster

            // Check final output failure
            // If the output of our configured chain is 0.5, that's a system failure
            let outputVal = (stages === 1) ? sigSync1 : (stages === 2 ? sigSync2 : sigSync3);
            
            if (outputVal === 0.5) {
                failures++;
                failCounter.innerText = failures;
                glitchOverlay.classList.remove('hidden');
                setTimeout(() => glitchOverlay.classList.add('hidden'), 50);
            }

            // Record History
            history.push({
                clkA: sigClkA,
                dataA: sigDataA,
                clkB: sigClkB,
                async: sigAsyncIn,
                s1: sigSync1,
                out: outputVal
            });
            if(history.length > 500) history.shift();

            drawWaves();
            requestAnimationFrame(step);
        }

        // --- Drawing ---
        function drawWaves() {
            if(canvas.width !== canvas.offsetWidth) canvas.width = canvas.offsetWidth;
            const w = canvas.width;
            const h = canvas.height;
            const ctx = waveCtx;

            ctx.clearRect(0,0,w,h);

            // Draw Config
            const step = w / 500;
            const lanes = [
                { id: 'clkA', y: 30, h: 15, c: '#eab308' },
                { id: 'dataA', y: 65, h: 15, c: '#fde047' },
                { id: 'clkB', y: 110, h: 15, c: '#3b82f6' },
                { id: 'async', y: 145, h: 15, c: '#ef4444' }, // The wire
                { id: 's1', y: 180, h: 15, c: '#a5b4fc' },    // Sync Stage 1
                { id: 'out', y: 215, h: 15, c: '#4ade80' },   // Final Output
            ];

            lanes.forEach(lane => {
                ctx.strokeStyle = lane.c;
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                for(let i=0; i<history.length; i++) {
                    const val = history[i][lane.id];
                    const x = i * step;
                    
                    let yPos;
                    if (val === 0.5) {
                        // Metastable: Draw fuzzy/jittery line in middle
                        yPos = lane.y + (Math.random() * 6 - 3); 
                        ctx.lineWidth = 1; // Thinner, messy line
                    } else {
                        yPos = val ? (lane.y - lane.h) : (lane.y + lane.h);
                        ctx.lineWidth = 2;
                    }

                    if(i===0) ctx.moveTo(x, yPos);
                    else {
                        // Horizontal
                        ctx.lineTo(x, yPos);
                        // Vertical transition (if not metastable jitter)
                        if (val !== 0.5 && history[i-1][lane.id] !== 0.5 && history[i-1][lane.id] !== val) {
                             // handled by lineTo logic automatically
                             ctx.lineTo(x, yPos); 
                        }
                    }
                }
                ctx.stroke();

                // Draw Dashed Baseline
                ctx.strokeStyle = '#374151';
                ctx.lineWidth = 1;
                ctx.setLineDash([2, 4]);
                ctx.beginPath();
                ctx.moveTo(0, lane.y);
                ctx.lineTo(w, lane.y);
                ctx.stroke();
                ctx.setLineDash([]);
            });
        }

        const waveCtx = canvas.getContext('2d');
        setStages(2); // Default
        requestAnimationFrame(step);

    </script>
</body>
</html>
