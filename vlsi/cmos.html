<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXZS8C1FLY"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XXZS8C1FLY');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMOS Inverter Lab - EcrioniX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Orbitron:wght@500;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <!-- MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #020617; color: #f8fafc; overflow: hidden; }
        .tech-font { font-family: 'Orbitron', sans-serif; }
        .mono-font { font-family: 'JetBrains Mono', monospace; }

        .watermark {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 8rem; font-weight: 900; color: rgba(255, 255, 255, 0.03);
            pointer-events: none; user-select: none; z-index: 0;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px;
        }

        /* Tabs */
        .tab-btn {
            @apply px-4 py-2 text-xs font-bold rounded-lg transition-all border border-transparent text-slate-400 uppercase tracking-wider;
        }
        .tab-active {
            @apply bg-indigo-600 text-white border-indigo-500 shadow-lg shadow-indigo-500/30;
        }

        /* Simulation Canvas */
        #sim-canvas {
            background-color: #0f172a;
            border-radius: 12px;
            width: 100%; height: 100%;
        }

        /* Sliders */
        input[type=range] { accent-color: #6366f1; }

        /* Circuit Components */
        .wire { fill: none; stroke: #475569; stroke-width: 3; stroke-linecap: round; transition: stroke 0.2s; }
        .wire-active-high { stroke: #ef4444; filter: drop-shadow(0 0 4px #ef4444); } /* VDD/High */
        .wire-active-low { stroke: #3b82f6; filter: drop-shadow(0 0 4px #3b82f6); } /* GND/Low */
        
        .mos-body { fill: none; stroke: #cbd5e1; stroke-width: 2; }
        .mos-gate { fill: none; stroke: #94a3b8; stroke-width: 2; }
        .mos-bubble { fill: #0f172a; stroke: #cbd5e1; stroke-width: 2; }
        
        .mos-on .mos-gate { stroke: #facc15; filter: drop-shadow(0 0 2px #facc15); } /* Conducting */
        
        .current-arrow {
            fill: #facc15;
            display: none;
        }

        /* Theory Styles */
        .prose h1 { @apply text-3xl font-bold text-white mb-6 tech-font border-b border-slate-800 pb-2; }
        .prose h2 { @apply text-xl font-bold text-indigo-400 mt-8 mb-4 uppercase tracking-wider; }
        .prose p { @apply text-slate-400 mb-4 leading-relaxed; }
        .prose strong { @apply text-white font-semibold; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col relative">

    <div class="watermark">EcrioniX VLSI</div>

    <!-- Header -->
    <nav class="border-b border-slate-800 bg-slate-900/80 px-6 py-4 flex justify-between items-center z-20">
        <div>
            <h1 class="text-2xl font-bold text-indigo-400 tech-font uppercase">CMOS <span class="text-white">Inverter</span></h1>
            <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Digital Logic & Physics Simulation</p>
        </div>
        
        <div class="flex bg-slate-950 p-1 rounded-xl border border-slate-800">
            <button onclick="switchView('theory')" id="btn-theory" class="tab-btn tab-active">Theory</button>
            <button onclick="switchView('lab')" id="btn-lab" class="tab-btn">Experiment</button>
        </div>

        <button onclick="window.history.back()" class="group flex items-center text-slate-400 hover:text-white transition bg-slate-800/80 px-4 py-2 rounded-lg border border-slate-700 hover:border-indigo-500">
            <span class="text-xs font-bold uppercase">Exit Lab</span>
        </button>
    </nav>

    <!-- Content Area -->
    <div class="flex-grow relative overflow-hidden">
        
        <!-- THEORY VIEW -->
        <div id="view-theory" class="absolute inset-0 z-10 overflow-y-auto p-8 flex justify-center">
            <div class="max-w-4xl w-full glass-panel p-10 prose">
                <h1>The Fundamental Logic Gate</h1>
                <p>
                    The <strong>CMOS (Complementary Metal-Oxide-Semiconductor) Inverter</strong> is the most basic building block of digital integrated circuits. It performs the logical NOT operation: inputting a 0 results in a 1, and vice versa.
                </p>

                <h2>1. Structure</h2>
                <p>It consists of two transistors connected in series between the supply voltage ($V_{DD}$) and ground ($GND$):</p>
                <ul>
                    <li><strong>PMOS (Top):</strong> Connected to $V_{DD}$. It turns ON when the input is Low (0V). It acts as a "Pull-Up" network.</li>
                    <li><strong>NMOS (Bottom):</strong> Connected to $GND$. It turns ON when the input is High ($V_{DD}$). It acts as a "Pull-Down" network.</li>
                </ul>

                <h2>2. Operation Principles</h2>
                <div class="grid grid-cols-2 gap-4 my-6">
                    <div class="bg-indigo-500/10 border border-indigo-500/50 p-4 rounded-lg">
                        <h3 class="text-white font-bold mb-2">Input Low ($V_{in} = 0$)</h3>
                        <ul class="text-sm text-slate-300 list-disc list-inside">
                            <li><strong>PMOS:</strong> ON ($|V_{GS}| > |V_{tp}|$)</li>
                            <li><strong>NMOS:</strong> OFF ($V_{GS} < V_{tn}$)</li>
                            <li><strong>Result:</strong> Output pulled to $V_{DD}$ (Logic 1)</li>
                        </ul>
                    </div>
                    <div class="bg-indigo-500/10 border border-indigo-500/50 p-4 rounded-lg">
                        <h3 class="text-white font-bold mb-2">Input High ($V_{in} = V_{DD}$)</h3>
                        <ul class="text-sm text-slate-300 list-disc list-inside">
                            <li><strong>PMOS:</strong> OFF</li>
                            <li><strong>NMOS:</strong> ON</li>
                            <li><strong>Result:</strong> Output pulled to $GND$ (Logic 0)</li>
                        </ul>
                    </div>
                </div>

                <h2>3. Voltage Transfer Characteristic (VTC)</h2>
                <p>
                    The VTC curve plots $V_{out}$ vs. $V_{in}$. Ideally, it's a sharp step function. In reality, there is a transition region where both transistors are partially ON, consuming **short-circuit power**.
                </p>
                <div class="bg-indigo-500/10 border-l-4 border-indigo-500 p-4 my-4">
                    <p class="text-center text-xl text-white">\[ V_M = \frac{V_{DD} - |V_{tp}| + V_{tn} \sqrt{\beta_n / \beta_p}}{1 + \sqrt{\beta_n / \beta_p}} \]</p>
                </div>
                <p>The switching threshold ($V_M$) is where $V_{in} = V_{out}$. It is typically designed to be $V_{DD}/2$ by balancing the transistor sizes ($\beta_n \approx \beta_p$).</p>
                
                <div class="mt-8 text-center">
                    <button onclick="switchView('lab')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-8 py-3 rounded-xl font-bold transition shadow-lg shadow-indigo-500/20">Start Experiment &rarr;</button>
                </div>
            </div>
        </div>

        <!-- LAB VIEW -->
        <div id="view-lab" class="absolute inset-0 z-0 opacity-0 pointer-events-none flex p-6 gap-6">
            
            <!-- Left: Controls -->
            <div class="w-80 flex flex-col gap-4 overflow-y-auto pr-2">
                <div class="glass-panel p-6">
                    <h2 class="text-indigo-400 font-bold mb-4 uppercase text-[10px] tracking-widest">Input Control</h2>
                    
                    <div class="space-y-6">
                        <!-- Input Voltage Slider -->
                        <div>
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-slate-300">Input Voltage ($V_{in}$)</span>
                                <span id="val-vin" class="font-mono text-white font-bold">0.0 V</span>
                            </div>
                            <input type="range" id="slider-vin" min="0" max="5" step="0.1" value="0" class="w-full">
                            <div class="flex justify-between text-[9px] text-slate-500 mt-1 font-mono">
                                <span>GND (0)</span>
                                <span>VDD (1)</span>
                            </div>
                        </div>

                        <!-- Digital Snap Toggle -->
                        <div class="flex items-center justify-between bg-slate-900 p-3 rounded-lg border border-slate-700">
                             <span class="text-xs text-slate-300 font-bold">Digital Mode (0/1)</span>
                             <button onclick="toggleDigitalMode()" id="btn-digimode" class="bg-slate-700 text-slate-400 px-3 py-1 rounded text-[10px] font-bold transition hover:text-white">OFF</button>
                        </div>
                    </div>
                </div>

                <div class="glass-panel p-6">
                    <h2 class="text-indigo-400 font-bold mb-4 uppercase text-[10px] tracking-widest">Transistor Sizing (W/L)</h2>
                    
                    <div class="space-y-6">
                        <div>
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-red-400">PMOS Ratio ($\beta_p$)</span>
                                <span id="val-beta-p" class="font-mono text-white font-bold">2.0</span>
                            </div>
                            <input type="range" id="slider-beta-p" min="1" max="5" step="0.1" value="2" class="w-full">
                        </div>
                        <div>
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-blue-400">NMOS Ratio ($\beta_n$)</span>
                                <span id="val-beta-n" class="font-mono text-white font-bold">1.0</span>
                            </div>
                            <input type="range" id="slider-beta-n" min="1" max="5" step="0.1" value="1" class="w-full">
                        </div>
                        <p class="text-[9px] text-slate-500 italic">Adjusting sizes changes the switching threshold ($V_M$). PMOS is usually wider to balance mobility.</p>
                    </div>
                </div>

                <div class="glass-panel p-6 flex-grow flex flex-col">
                    <h2 class="text-emerald-400 font-bold mb-4 uppercase text-[10px] tracking-widest">Analysis</h2>
                    <div class="space-y-3">
                        <div class="bg-black/40 p-3 rounded border border-slate-800 flex justify-between items-center">
                            <span class="text-xs text-slate-400">Output ($V_{out}$)</span>
                            <span id="val-vout" class="text-emerald-400 font-bold mono-font">5.0 V</span>
                        </div>
                        <div class="bg-black/40 p-3 rounded border border-slate-800 flex justify-between items-center">
                            <span class="text-xs text-slate-400">Region</span>
                            <span id="val-region" class="text-yellow-400 font-bold mono-font text-[10px] text-right">P:LIN, N:CUT</span>
                        </div>
                        <div class="bg-black/40 p-3 rounded border border-slate-800 flex justify-between items-center">
                            <span class="text-xs text-slate-400">Short Circuit I</span>
                            <span id="val-idd" class="text-blue-400 font-bold mono-font">0.00 mA</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Canvas Area -->
            <div class="flex-grow flex flex-col gap-6">
                <!-- Experiment View -->
                <div class="glass-panel p-1 relative flex-grow overflow-hidden flex items-center justify-center bg-slate-900/50">
                     <svg id="circuit-svg" width="500" height="400" viewBox="0 0 500 400" class="drop-shadow-2xl">
                         <!-- Power Rails -->
                         <line x1="200" y1="50" x2="300" y2="50" class="wire wire-active-high" /> <!-- VDD -->
                         <text x="310" y="55" fill="#ef4444" font-size="12" font-weight="bold">VDD (5V)</text>
                         
                         <line x1="200" y1="350" x2="300" y2="350" class="wire wire-active-low" /> <!-- GND -->
                         <text x="310" y="355" fill="#3b82f6" font-size="12" font-weight="bold">GND (0V)</text>

                         <!-- PMOS (Top) -->
                         <g id="pmos" transform="translate(250, 100)">
                             <path d="M-20,0 H0 M-20,40 H0 M-20,20 H0" class="mos-body" /> <!-- Source/Drain/Body connections -->
                             <line x1="0" y1="0" x2="0" y2="40" class="mos-body" /> <!-- Channel Back -->
                             <line x1="10" y1="0" x2="10" y2="40" class="mos-gate" /> <!-- Gate -->
                             <circle cx="15" cy="20" r="4" class="mos-bubble" /> <!-- P-Bubble -->
                             <line x1="19" y1="20" x2="40" y2="20" class="wire" id="wire-gate-p" /> <!-- Gate Input -->
                             
                             <line x1="-10" y1="0" x2="-10" y2="-50" class="wire" id="wire-source-p" /> <!-- To VDD -->
                             <line x1="-10" y1="40" x2="-10" y2="100" class="wire" id="wire-drain-p" /> <!-- To Output -->
                             
                             <text x="-45" y="25" fill="#ef4444" font-size="10">PMOS</text>
                         </g>

                         <!-- NMOS (Bottom) -->
                         <g id="nmos" transform="translate(250, 260)">
                             <path d="M-20,0 H0 M-20,40 H0 M-20,20 H0" class="mos-body" />
                             <line x1="0" y1="0" x2="0" y2="40" class="mos-body" />
                             <line x1="10" y1="0" x2="10" y2="40" class="mos-gate" />
                             <!-- No Bubble -->
                             <line x1="10" y1="20" x2="40" y2="20" class="wire" id="wire-gate-n" />
                             
                             <line x1="-10" y1="0" x2="-10" y2="-60" class="wire" id="wire-drain-n" /> <!-- To Output -->
                             <line x1="-10" y1="40" x2="-10" y2="90" class="wire" id="wire-source-n" /> <!-- To GND -->
                             
                             <text x="-45" y="25" fill="#3b82f6" font-size="10">NMOS</text>
                         </g>

                         <!-- Input Wiring -->
                         <line x1="50" y1="200" x2="290" y2="200" class="wire" id="wire-in-main" />
                         <line x1="290" y1="200" x2="290" y2="120" class="wire" id="wire-in-up" />
                         <line x1="290" y1="200" x2="290" y2="280" class="wire" id="wire-in-down" />
                         <circle cx="50" cy="200" r="5" fill="#fbbf24" />
                         <text x="40" y="185" fill="#fbbf24" font-size="12" font-weight="bold">Vin</text>

                         <!-- Output Wiring -->
                         <line x1="240" y1="200" x2="450" y2="200" class="wire" id="wire-out" />
                         <circle cx="240" cy="200" r="4" fill="#94a3b8" /> <!-- Junction -->
                         <text x="460" y="205" fill="#4ade80" font-size="12" font-weight="bold">Vout</text>
                         
                         <!-- Output Indicator (Bulb) -->
                         <g transform="translate(420, 180)">
                            <circle cx="30" cy="20" r="10" fill="#334155" stroke="#475569" id="bulb-body" />
                            <path d="M30,20 L30,40" stroke="#475569" />
                         </g>

                         <!-- Current Arrows -->
                         <path id="arrow-p" d="M240,60 V180" stroke="#facc15" stroke-width="4" marker-end="url(#arrow)" class="current-arrow" />
                         <path id="arrow-n" d="M240,220 V340" stroke="#facc15" stroke-width="4" marker-end="url(#arrow)" class="current-arrow" />
                         
                         <defs>
                            <marker id="arrow" markerWidth="10" markerHeight="10" refX="5" refY="5" orient="auto">
                                <path d="M0,0 L10,5 L0,10" fill="#facc15" />
                            </marker>
                        </defs>

                     </svg>
                </div>

                <!-- VTC Graph -->
                <div class="glass-panel p-4 h-64 flex flex-col">
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Voltage Transfer Characteristic (VTC)</h2>
                    <div class="w-full h-full bg-black/20 rounded relative">
                        <canvas id="vtc-canvas"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- Constants ---
        const VDD = 5.0;
        const Vtn = 1.0; // Threshold NMOS
        const Vtp = -1.0; // Threshold PMOS
        
        // --- State ---
        let vin = 0;
        let vout = 5;
        let betaN = 1.0;
        let betaP = 2.0;
        
        // --- DOM ---
        const slVin = document.getElementById('slider-vin');
        const slBetaP = document.getElementById('slider-beta-p');
        const slBetaN = document.getElementById('slider-beta-n');
        
        // Visualization Elements
        const wireInMain = document.getElementById('wire-in-main');
        const wireInUp = document.getElementById('wire-in-up');
        const wireInDown = document.getElementById('wire-in-down');
        const wireOut = document.getElementById('wire-out');
        const wireSourceP = document.getElementById('wire-source-p');
        const wireDrainP = document.getElementById('wire-drain-p');
        const wireSourceN = document.getElementById('wire-source-n');
        const wireDrainN = document.getElementById('wire-drain-n');
        const bulb = document.getElementById('bulb-body');
        
        const arrowP = document.getElementById('arrow-p');
        const arrowN = document.getElementById('arrow-n');
        
        const pmosGate = document.querySelector('#pmos .mos-gate');
        const nmosGate = document.querySelector('#nmos .mos-gate');

        // --- Chart ---
        const vtcCanvas = document.getElementById('vtc-canvas');
        const ctx = vtcCanvas.getContext('2d');
        let vtcData = [];
        let currentPoint = {x:0, y:5};

        // --- Initialization ---
        function resize() {
            vtcCanvas.width = vtcCanvas.parentElement.clientWidth;
            vtcCanvas.height = vtcCanvas.parentElement.clientHeight;
            updateVTCData();
            drawGraph();
        }
        window.addEventListener('resize', resize);
        
        // --- View Switching ---
        function switchView(v) {
            const theory = document.getElementById('view-theory');
            const lab = document.getElementById('view-lab');
            const btnT = document.getElementById('btn-theory');
            const btnL = document.getElementById('btn-lab');

            if (v === 'theory') {
                theory.classList.remove('opacity-0', 'pointer-events-none'); theory.classList.add('z-10');
                lab.classList.add('opacity-0', 'pointer-events-none'); lab.classList.remove('z-10');
                btnT.classList.add('tab-active'); btnL.classList.remove('tab-active');
            } else {
                lab.classList.remove('opacity-0', 'pointer-events-none'); lab.classList.add('z-10');
                theory.classList.add('opacity-0', 'pointer-events-none'); theory.classList.remove('z-10');
                btnL.classList.add('tab-active'); btnT.classList.remove('tab-active');
                resize();
            }
        }
        
        // --- Physics Logic (Simplified CMOS Model) ---
        function calculateVout(vin_val) {
            // Simplified approximation for visualization
            // Real model involves solving Id_n = Id_p equations in 5 regions
            
            // Region 1: Vin < Vtn (NMOS Off, PMOS Lin) -> Vout = VDD
            if (vin_val < Vtn) return VDD;
            
            // Region 5: Vin > VDD + Vtp (PMOS Off, NMOS Lin) -> Vout = 0
            if (vin_val > VDD + Vtp) return 0;
            
            // Transition Region (Steep drop)
            // Ideally solve equations, here we use a logistic sigmoid approximation shifted by Vm
            // Vm approx = VDD * ( sqrt(Bn/Bp) ) / (1 + sqrt(Bn/Bp)) ? No, formula is complex.
            // Vm approx VDD/2 if betaN = betaP.
            // Adjust center based on beta ratio
            
            const r = Math.sqrt(betaN / betaP);
            const Vm = (VDD - Math.abs(Vtp) + Vtn * r) / (1 + r);
            
            // Steepness
            const k = 15; 
            
            const v = VDD / (1 + Math.exp(k * (vin_val - Vm)));
            return v;
        }
        
        function getRegion(vin_val) {
            if (vin_val < Vtn) return "P:LIN, N:CUT"; // Input Low
            if (vin_val > VDD + Vtp) return "P:CUT, N:LIN"; // Input High
            // Around Vm
            const r = Math.sqrt(betaN / betaP);
            const Vm = (VDD - Math.abs(Vtp) + Vtn * r) / (1 + r);
            if (Math.abs(vin_val - Vm) < 0.2) return "BOTH SAT (Switching)";
            if (vin_val < Vm) return "P:LIN, N:SAT";
            return "P:SAT, N:LIN";
        }
        
        function calculateCurrent(vin_val, vout_val) {
             // Dynamic/Short circuit current peaks at switching
             if (vin_val < Vtn || vin_val > VDD + Vtp) return 0;
             
             // Simple triangular approximation peaking at Vm
             const r = Math.sqrt(betaN / betaP);
             const Vm = (VDD - Math.abs(Vtp) + Vtn * r) / (1 + r);
             const dist = 1 - Math.abs(vin_val - Vm) / (VDD/2);
             return Math.max(0, dist * 50 * Math.min(betaN, betaP)); // uA scaling
        }

        function updateSimulation() {
            vin = parseFloat(slVin.value);
            betaP = parseFloat(slBetaP.value);
            betaN = parseFloat(slBetaN.value);
            
            vout = calculateVout(vin);
            const region = getRegion(vin);
            const idd = calculateCurrent(vin, vout);
            
            // Update UI Text
            document.getElementById('val-vin').innerText = vin.toFixed(2) + " V";
            document.getElementById('val-vout').innerText = vout.toFixed(2) + " V";
            document.getElementById('val-beta-p').innerText = betaP.toFixed(1);
            document.getElementById('val-beta-n').innerText = betaN.toFixed(1);
            document.getElementById('val-region').innerText = region;
            document.getElementById('val-idd').innerText = idd.toFixed(2) + " ÂµA";
            
            // Update Visuals
            updateCircuitVisuals();
            
            // Update Graph Point
            currentPoint = { x: vin, y: vout };
            drawGraph();
        }
        
        function updateCircuitVisuals() {
            const highThresh = 3.5;
            const lowThresh = 1.5;
            
            // Input Wires Color
            let inColor = "stroke-slate-500";
            if (vin > highThresh) inColor = "wire-active-high"; // Red
            else if (vin < lowThresh) inColor = "wire-active-low"; // Blue
            else inColor = "stroke-yellow-400"; // Transition
            
            // Output Wires Color
            let outColor = "stroke-slate-500";
            if (vout > highThresh) outColor = "wire-active-high";
            else if (vout < lowThresh) outColor = "wire-active-low";
            else outColor = "stroke-yellow-400";
            
            // Apply Classes
            const setClass = (el, c) => { el.setAttribute('class', `wire ${c}`); };
            
            // Input path
            setClass(wireInMain, inColor === 'stroke-slate-500' ? '' : (inColor === 'stroke-yellow-400' ? 'wire-active' : inColor));
            setClass(wireInUp, inColor === 'stroke-slate-500' ? '' : (inColor === 'stroke-yellow-400' ? 'wire-active' : inColor));
            setClass(wireInDown, inColor === 'stroke-slate-500' ? '' : (inColor === 'stroke-yellow-400' ? 'wire-active' : inColor));
            
            // Output path
            const outCls = outColor === 'stroke-slate-500' ? '' : (outColor === 'stroke-yellow-400' ? 'wire-active' : outColor);
            setClass(wireOut, outCls);
            setClass(wireDrainP, outCls); // Top half of out
            setClass(wireDrainN, outCls); // Bot half of out
            
            // Transistor State (Gate visual)
            // PMOS ON if Vin is Low
            if (vin < VDD + Vtp + 0.5) pmosGate.style.stroke = "#facc15"; // ON color
            else pmosGate.style.stroke = "#94a3b8"; // OFF
            
            // NMOS ON if Vin is High
            if (vin > Vtn - 0.5) nmosGate.style.stroke = "#facc15";
            else nmosGate.style.stroke = "#94a3b8";
            
            // Source connections
            setClass(wireSourceP, "wire-active-high"); // Always VDD
            setClass(wireSourceN, "wire-active-low");  // Always GND
            
            // Current Flow Arrows
            if (vout > highThresh) {
                // Pulling Up
                arrowP.style.display = "block";
                arrowN.style.display = "none";
                bulb.style.fill = "#ef4444"; // High Red
                bulb.style.filter = "drop-shadow(0 0 8px #ef4444)";
            } else if (vout < lowThresh) {
                // Pulling Down
                arrowP.style.display = "none";
                arrowN.style.display = "block";
                bulb.style.fill = "#334155"; // Off
                bulb.style.filter = "none";
            } else {
                // Transition
                arrowP.style.display = "none";
                arrowN.style.display = "none";
                bulb.style.fill = "#fbbf24"; // Yellow dim
                bulb.style.filter = "drop-shadow(0 0 4px #fbbf24)";
            }
        }
        
        function updateVTCData() {
            vtcData = [];
            for(let v = 0; v <= 5; v += 0.05) {
                vtcData.push({x: v, y: calculateVout(v)});
            }
            drawGraph();
        }
        
        function drawGraph() {
            const w = vtcCanvas.width;
            const h = vtcCanvas.height;
            ctx.clearRect(0,0,w,h);
            
            // Grid / Axes
            ctx.strokeStyle = '#334155';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(40, h-30); ctx.lineTo(w, h-30); // X
            ctx.moveTo(40, h-30); ctx.lineTo(40, 10); // Y
            ctx.stroke();
            
            // Text
            ctx.fillStyle = '#64748b';
            ctx.font = '10px monospace';
            ctx.fillText("Vin (0-5V)", w-60, h-10);
            ctx.fillText("Vout", 10, 20);
            
            // Plot VTC Curve
            ctx.strokeStyle = '#4ade80'; // Green Curve
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            // Scales
            const sx = (w - 50) / 5;
            const sy = (h - 40) / 5;
            
            vtcData.forEach((pt, i) => {
                const x = 40 + pt.x * sx;
                const y = (h - 30) - pt.y * sy;
                if (i===0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
            
            // Draw Current Operating Point
            const px = 40 + currentPoint.x * sx;
            const py = (h - 30) - currentPoint.y * sy;
            
            ctx.fillStyle = '#fbbf24';
            ctx.beginPath();
            ctx.arc(px, py, 5, 0, Math.PI*2);
            ctx.fill();
            
            // Draw Threshold Line (Vm)
            // Identify Vm where Vin approx Vout
            const Vm = vtcData.find(p => Math.abs(p.x - p.y) < 0.1)?.x || 2.5;
            const vmx = 40 + Vm * sx;
            ctx.strokeStyle = '#6366f1';
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(vmx, 10);
            ctx.lineTo(vmx, h-30);
            ctx.stroke();
            ctx.setLineDash([]);
            ctx.fillStyle = '#6366f1';
            ctx.fillText(`Vm=${Vm.toFixed(2)}`, vmx + 5, 20);
        }

        // Logic Controls
        let digitalMode = false;
        function toggleDigitalMode() {
            digitalMode = !digitalMode;
            const btn = document.getElementById('btn-digimode');
            const slider = document.getElementById('slider-vin');
            
            if (digitalMode) {
                btn.innerText = "ON";
                btn.className = "bg-green-600 text-white px-3 py-1 rounded text-[10px] font-bold transition shadow";
                slider.step = "5"; // Snap to 0 or 5
            } else {
                btn.innerText = "OFF";
                btn.className = "bg-slate-700 text-slate-400 px-3 py-1 rounded text-[10px] font-bold transition hover:text-white";
                slider.step = "0.1";
            }
        }
        
        // Listeners for Beta changes to redraw curve
        slBetaP.addEventListener('input', () => { updateVTCData(); updateSimulation(); });
        slBetaN.addEventListener('input', () => { updateVTCData(); updateSimulation(); });
        slVin.addEventListener('input', updateSimulation);

        // Init
        resize();
        updateVTCData();
        updateSimulation();

    </script>
</body>
</html>
