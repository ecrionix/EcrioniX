<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXZS8C1FLY"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XXZS8C1FLY');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIFO Depth Calculation Lab - EcrioniX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Orbitron:wght@500;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <!-- MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #020617; color: #f8fafc; }
        .tech-font { font-family: 'Orbitron', sans-serif; }
        .mono-font { font-family: 'JetBrains Mono', monospace; }

        .watermark {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 8rem; font-weight: 900; color: rgba(99, 102, 241, 0.03);
            pointer-events: none; user-select: none; z-index: 0;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px;
        }

        /* Tabs */
        .tab-btn {
            @apply px-4 py-2 text-xs font-bold rounded-lg transition-all border border-transparent text-slate-400 uppercase tracking-wider;
        }
        .tab-active {
            @apply bg-indigo-600 text-white border-indigo-500 shadow-lg shadow-indigo-500/30;
        }

        /* FIFO Visuals */
        .fifo-cell {
            transition: all 0.2s;
            border: 1px solid #334155;
            background: #0f172a;
            display: flex; align-items: center; justify-content: center;
            font-family: 'JetBrains Mono'; font-size: 10px; color: #64748b;
        }
        .fifo-cell-active {
            background: #3b82f6; border-color: #60a5fa; color: white; box-shadow: 0 0 5px #3b82f6;
        }
        .fifo-cell-overflow {
            background: #ef4444; border-color: #f87171; color: white; box-shadow: 0 0 10px #ef4444; animation: flash-overflow 0.5s;
        }
        @keyframes flash-overflow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* CDC Visuals */
        .domain-box {
            border: 1px dashed;
            border-radius: 12px;
            padding: 10px;
            position: relative;
        }
        .domain-wr { border-color: #ef4444; background: rgba(239, 68, 68, 0.05); }
        .domain-rd { border-color: #3b82f6; background: rgba(59, 130, 246, 0.05); }
        
        .sync-ff {
            width: 40px; height: 50px;
            background: #1e293b; border: 2px solid #94a3b8;
            display: flex; align-items: center; justify-content: center;
            font-family: monospace; font-size: 10px; color: #cbd5e1;
            position: relative;
        }
        .sync-ff::after {
            content: ''; position: absolute; bottom: 0; left: -5px;
            width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-bottom: 5px solid #94a3b8;
        }

        .ptr-val { font-family: 'JetBrains Mono'; font-weight: bold; font-size: 12px; }

        input[type=range] { accent-color: #6366f1; }

        /* Theory Styles */
        .prose h1 { @apply text-3xl font-bold text-white mb-6 tech-font border-b border-slate-800 pb-2; }
        .prose h2 { @apply text-xl font-bold text-indigo-400 mt-8 mb-4 uppercase tracking-wider; }
        .prose p { @apply text-slate-400 mb-4 leading-relaxed; }
        .prose strong { @apply text-white font-semibold; }
        .prose ul { @apply list-disc list-inside space-y-2 text-slate-400 mb-4; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col relative">

    <div class="watermark">EcrioniX Design</div>

    <!-- Header -->
    <nav class="border-b border-slate-800 bg-slate-900/80 px-6 py-4 flex justify-between items-center z-20">
        <div>
            <h1 class="text-2xl font-bold text-indigo-400 tech-font uppercase">FIFO <span class="text-white">DEPTH</span></h1>
            <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Queue Sizing & Flow Control</p>
        </div>
        
        <div class="flex bg-slate-950 p-1 rounded-xl border border-slate-800">
            <button onclick="switchView('theory')" id="btn-theory" class="tab-btn tab-active">Theory Guide</button>
            <button onclick="switchView('lab')" id="btn-lab" class="tab-btn">Simulation Lab</button>
        </div>

        <button onclick="window.history.back()" class="group flex items-center text-slate-400 hover:text-white transition bg-slate-800/80 px-4 py-2 rounded-lg border border-slate-700 hover:border-indigo-500">
            <span class="text-xs font-bold uppercase">Exit Lab</span>
        </button>
    </nav>

    <!-- Content -->
    <div class="flex-grow relative overflow-hidden">

        <!-- THEORY VIEW -->
        <div id="view-theory" class="absolute inset-0 z-10 overflow-y-auto p-8 flex justify-center">
            <div class="max-w-4xl w-full glass-panel p-10 prose">
                <h1>FIFO Depth Calculation</h1>
                <p>
                    A **First-In-First-Out (FIFO)** buffer is used to safely transfer data between two modules operating at different speeds or clock domains. The critical design parameter is the **Depth**: how many slots are needed to prevent data loss (overflow) during a "burst" of writes when the reader is slower.
                </p>

                <h2>1. The Core Problem: Burst vs. Average</h2>
                <p>
                    In steady state, the average Read rate must equal the average Write rate, or the FIFO will eventually overflow or underflow. However, data often arrives in **Bursts**. The FIFO must be deep enough to store the excess data that accumulates during the burst while the reader catches up.
                </p>

                <h2>2. Synchronous FIFO (Same Clock)</h2>
                <p>
                    Even with the same clock, if the Writer sends data every cycle for a burst ($B$) but the Reader can only read every 2nd or 4th cycle (due to backpressure or protocol), a FIFO is needed.
                </p>
                <div class="bg-indigo-500/10 border-l-4 border-indigo-500 p-4 my-4">
                    <p class="text-white font-bold">Formula:</p>
                    <p class="text-center text-xl text-white my-2">\[ Depth = B - \left( B \times \frac{f_{rd}}{f_{wr}} \right) \]</p>
                    <p class="text-xs text-slate-400">Where $B$ is Burst Size, $f_{wr}$ is write freq, $f_{rd}$ is read freq.</p>
                </div>

                <h2>3. Asynchronous FIFO (Clock Domain Crossing)</h2>
                <p>
                    When crossing clock domains, we use <strong>Gray Code Pointers</strong> to pass write/read addresses across domains safely.
                </p>
                <ul>
                    <li><strong>Synchronization Latency:</strong> Pointers passed through a 2-flip-flop synchronizer take 2-3 clock cycles to reach the other domain.</li>
                    <li><strong>Conservative Flags:</strong> Because of this delay, the "Full" flag is generated based on a delayed Read Pointer. The FIFO might actually have space when it says Full, which is safe (no overflow), but reduces efficiency.</li>
                    <li><strong>Depth Required:</strong> Similar to synchronous, but must account for the synchronization delay (Latency).</li>
                </ul>

                <div class="mt-8 text-center">
                    <button onclick="switchView('lab')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-8 py-3 rounded-xl font-bold transition shadow-lg shadow-indigo-500/20">Launch Experiment &rarr;</button>
                </div>
            </div>
        </div>

        <!-- LAB VIEW -->
        <div id="view-lab" class="absolute inset-0 z-0 opacity-0 pointer-events-none flex p-6 gap-6">
            
            <!-- Left: Controls -->
            <div class="w-80 flex flex-col gap-4 overflow-y-auto pr-2">
                <div class="glass-panel p-6">
                    <h2 class="text-indigo-400 font-bold mb-4 uppercase text-[10px] tracking-widest">Traffic Generation</h2>
                    
                    <div class="space-y-6">
                        <!-- Write Clock -->
                        <div>
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-slate-300">Write Freq ($f_{wr}$)</span>
                                <span id="val-fwr" class="font-mono text-white font-bold">100 MHz</span>
                            </div>
                            <input type="range" id="slider-fwr" min="10" max="200" step="10" value="100" class="w-full">
                        </div>

                        <!-- Read Clock -->
                        <div>
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-slate-300">Read Freq ($f_{rd}$)</span>
                                <span id="val-frd" class="font-mono text-white font-bold">40 MHz</span>
                            </div>
                            <input type="range" id="slider-frd" min="10" max="200" step="10" value="40" class="w-full">
                        </div>

                         <!-- Burst Size -->
                        <div>
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-slate-300">Burst Size ($B$)</span>
                                <span id="val-burst" class="font-mono text-yellow-400 font-bold">20</span>
                            </div>
                            <input type="range" id="slider-burst" min="5" max="50" step="1" value="20" class="w-full">
                        </div>
                        
                         <!-- FIFO Depth Config -->
                        <div>
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-slate-300">FIFO Depth</span>
                                <span id="val-depth" class="font-mono text-blue-400 font-bold">16</span>
                            </div>
                            <input type="range" id="slider-depth" min="4" max="64" step="4" value="16" class="w-full">
                        </div>

                        <button onclick="startBurst()" id="btn-burst" class="w-full py-4 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl shadow-lg transition active:scale-95 border-b-4 border-emerald-800 active:border-b-0 active:translate-y-1">
                            TRIGGER BURST
                        </button>
                    </div>
                </div>

                <!-- Analysis -->
                <div class="glass-panel p-6 flex-grow">
                    <h2 class="text-slate-400 font-bold mb-4 uppercase text-[10px] tracking-widest">Theoretical Requirement</h2>
                    <div class="space-y-3">
                        <div class="bg-black/40 p-3 rounded border border-slate-800 flex justify-between items-center">
                            <span class="text-xs text-slate-400">Min Depth Formula</span>
                            <span id="calc-formula" class="text-indigo-300 font-bold mono-font text-xs">--</span>
                        </div>
                        <div class="bg-black/40 p-3 rounded border border-slate-800 flex justify-between items-center">
                            <span class="text-xs text-slate-400">Calculated Depth</span>
                            <span id="calc-depth" class="text-emerald-400 font-bold mono-font text-xl">12</span>
                        </div>
                        <div id="status-box" class="p-3 rounded border border-red-900/50 bg-red-900/20 text-center text-xs font-bold text-red-400 hidden">
                            THEORETICAL RISK: DEPTH TOO SMALL
                        </div>
                         <div id="overflow-box" class="p-3 rounded border border-red-600 bg-red-900 text-center text-sm font-bold text-white hidden animate-pulse">
                            ðŸš¨ DATA LOST: OVERFLOW!
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Visualization -->
            <div class="flex-grow flex flex-col gap-6">
                
                <!-- Visual FIFO Toggle -->
                <div class="flex justify-end gap-2">
                    <button onclick="toggleVisual('grid')" id="btn-vis-grid" class="px-3 py-1 bg-indigo-600 text-white text-[10px] font-bold rounded">BUFFER GRID</button>
                    <button onclick="toggleVisual('cdc')" id="btn-vis-cdc" class="px-3 py-1 bg-slate-800 text-slate-400 text-[10px] font-bold rounded hover:text-white">CDC SCHEMATIC</button>
                </div>

                <!-- Visual 1: Buffer Grid -->
                <div id="view-vis-grid" class="glass-panel p-6 relative flex-grow overflow-hidden flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Buffer Status</h2>
                        <div class="flex gap-4 text-[10px] font-mono">
                            <span class="text-slate-500">Fill Level: <span id="lbl-fill" class="text-white">0</span></span>
                            <span class="text-slate-500">Status: <span id="lbl-status" class="text-green-400">EMPTY</span></span>
                        </div>
                    </div>
                    
                    <div class="flex-grow flex items-center justify-center bg-slate-900/50 rounded-xl border border-slate-800 p-8 relative">
                        <!-- Input Pipe -->
                        <div class="absolute left-0 top-1/2 -translate-y-1/2 w-20 h-4 bg-slate-700"></div>
                        <div id="wr-arrow" class="absolute left-4 top-1/2 -translate-y-1/2 text-emerald-400 font-bold text-xs opacity-0">WRITE &rarr;</div>
                        
                        <!-- FIFO Grid -->
                        <div id="fifo-grid" class="grid grid-cols-8 gap-1 p-2 bg-slate-800 rounded border-2 border-slate-600"></div>
                        
                        <!-- Output Pipe -->
                        <div class="absolute right-0 top-1/2 -translate-y-1/2 w-20 h-4 bg-slate-700"></div>
                        <div id="rd-arrow" class="absolute right-4 top-1/2 -translate-y-1/2 text-blue-400 font-bold text-xs opacity-0">READ &rarr;</div>
                    </div>
                </div>

                <!-- Visual 2: CDC Schematic -->
                <div id="view-vis-cdc" class="glass-panel p-6 relative flex-grow overflow-hidden flex flex-col hidden">
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">CDC Pointer Synchronization</h2>
                    <div class="flex-grow bg-[#0f172a] rounded-xl border border-slate-800 relative flex justify-around items-center p-4">
                        
                        <!-- Write Domain -->
                        <div class="domain-box domain-wr w-1/3 h-full flex flex-col items-center">
                            <div class="text-[10px] text-red-400 font-bold mb-2">WRITE DOMAIN (clk_wr)</div>
                            
                            <div class="mb-4 text-center">
                                <div class="text-[9px] text-slate-500">W_PTR (Bin)</div>
                                <div id="cdc-wbin" class="ptr-val text-red-400">0000</div>
                            </div>
                            
                            <div class="mb-8 text-center bg-slate-900 px-2 py-1 rounded">
                                <div class="text-[9px] text-slate-500">W_PTR (Gray)</div>
                                <div id="cdc-wgray" class="ptr-val text-white">0000</div>
                            </div>

                            <!-- Sync Chain for R_PTR -->
                            <div class="flex gap-2 items-center">
                                <div class="sync-ff" id="ff-w1">SYNC 1</div>
                                <div class="w-4 h-0.5 bg-slate-600"></div>
                                <div class="sync-ff" id="ff-w2">SYNC 2</div>
                            </div>
                            <div class="text-[9px] text-slate-500 mt-2">Syncd Read Ptr</div>
                            
                            <div class="mt-auto p-2 border border-red-500/30 rounded w-full text-center">
                                <div class="text-[9px] text-red-400">FULL FLAG</div>
                                <div id="cdc-full" class="font-bold text-slate-600">0</div>
                            </div>
                        </div>

                        <!-- Crossing Wires -->
                        <div class="flex flex-col h-full justify-center gap-12 w-1/4">
                             <!-- W -> R -->
                             <div class="relative h-1 bg-gradient-to-r from-red-500 to-blue-500 rounded">
                                 <div id="anim-w2r" class="absolute -top-1 w-3 h-3 bg-white rounded-full shadow opacity-0"></div>
                             </div>
                             <!-- R -> W -->
                             <div class="relative h-1 bg-gradient-to-l from-blue-500 to-red-500 rounded">
                                 <div id="anim-r2w" class="absolute -top-1 w-3 h-3 bg-white rounded-full shadow opacity-0"></div>
                             </div>
                        </div>

                        <!-- Read Domain -->
                        <div class="domain-box domain-rd w-1/3 h-full flex flex-col items-center">
                            <div class="text-[10px] text-blue-400 font-bold mb-2">READ DOMAIN (clk_rd)</div>

                            <div class="mb-4 text-center">
                                <div class="text-[9px] text-slate-500">R_PTR (Bin)</div>
                                <div id="cdc-rbin" class="ptr-val text-blue-400">0000</div>
                            </div>
                            
                            <div class="mb-8 text-center bg-slate-900 px-2 py-1 rounded">
                                <div class="text-[9px] text-slate-500">R_PTR (Gray)</div>
                                <div id="cdc-rgray" class="ptr-val text-white">0000</div>
                            </div>

                            <!-- Sync Chain for W_PTR -->
                            <div class="flex gap-2 items-center">
                                <div class="sync-ff" id="ff-r1">SYNC 1</div>
                                <div class="w-4 h-0.5 bg-slate-600"></div>
                                <div class="sync-ff" id="ff-r2">SYNC 2</div>
                            </div>
                            <div class="text-[9px] text-slate-500 mt-2">Syncd Write Ptr</div>

                            <div class="mt-auto p-2 border border-blue-500/30 rounded w-full text-center">
                                <div class="text-[9px] text-blue-400">EMPTY FLAG</div>
                                <div id="cdc-empty" class="font-bold text-green-400">1</div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Fill Level Graph -->
                <div class="glass-panel p-4 h-64 flex flex-col">
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Fill Level vs Time</h2>
                    <div class="w-full h-full bg-black/20 rounded relative">
                        <canvas id="wave-canvas"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- State ---
        let fWr = 100;
        let fRd = 40;
        let burstSize = 20;
        let fifoDepth = 16;
        
        let currentFill = 0;
        let packetsWritten = 0;
        let time = 0;
        let is_bursting = false;
        
        let overflowOccurred = false;
        
        // Pointers for CDC
        let wPtr = 0;
        let rPtr = 0;
        let wPtrGray = 0;
        let rPtrGray = 0;
        
        // Synchronizer queues (modeling 2 cycle delay)
        // Wr Domain sees Rd Ptr delayed
        let syncRdQ = [0, 0]; 
        // Rd Domain sees Wr Ptr delayed
        let syncWrQ = [0, 0]; 
        
        // Simulation steps
        let writeAccumulator = 0;
        let readAccumulator = 0;

        const history = [];
        const MAX_HISTORY = 200;

        // DOM
        const sFwr = document.getElementById('slider-fwr');
        const sFrd = document.getElementById('slider-frd');
        const sBurst = document.getElementById('slider-burst');
        const sDepth = document.getElementById('slider-depth');
        
        const fifoGrid = document.getElementById('fifo-grid');
        const lblFill = document.getElementById('lbl-fill');
        const lblStatus = document.getElementById('lbl-status');
        const statusBox = document.getElementById('status-box');
        const overflowBox = document.getElementById('overflow-box');
        
        const wrArrow = document.getElementById('wr-arrow');
        const rdArrow = document.getElementById('rd-arrow');

        const canvas = document.getElementById('wave-canvas');
        const ctx = canvas.getContext('2d');

        // --- Logic ---
        function switchView(v) {
            const theory = document.getElementById('view-theory');
            const lab = document.getElementById('view-lab');
            const btnT = document.getElementById('btn-theory');
            const btnL = document.getElementById('btn-lab');

            if (v === 'theory') {
                theory.classList.remove('opacity-0', 'pointer-events-none'); theory.classList.add('z-10');
                lab.classList.add('opacity-0', 'pointer-events-none'); lab.classList.remove('z-10');
                btnT.classList.add('tab-active'); btnL.classList.remove('tab-active');
            } else {
                lab.classList.remove('opacity-0', 'pointer-events-none'); lab.classList.add('z-10');
                theory.classList.add('opacity-0', 'pointer-events-none'); theory.classList.remove('z-10');
                btnL.classList.add('tab-active'); btnT.classList.remove('tab-active');
                initGrid();
                resize();
            }
        }

        function toggleVisual(type) {
            const grid = document.getElementById('view-vis-grid');
            const cdc = document.getElementById('view-vis-cdc');
            const btnG = document.getElementById('btn-vis-grid');
            const btnC = document.getElementById('btn-vis-cdc');
            
            if (type === 'grid') {
                grid.classList.remove('hidden'); cdc.classList.add('hidden');
                btnG.className = "px-3 py-1 bg-indigo-600 text-white text-[10px] font-bold rounded";
                btnC.className = "px-3 py-1 bg-slate-800 text-slate-400 text-[10px] font-bold rounded hover:text-white";
            } else {
                cdc.classList.remove('hidden'); grid.classList.add('hidden');
                btnC.className = "px-3 py-1 bg-indigo-600 text-white text-[10px] font-bold rounded";
                btnG.className = "px-3 py-1 bg-slate-800 text-slate-400 text-[10px] font-bold rounded hover:text-white";
            }
        }

        // Listeners
        sFwr.addEventListener('input', updateParams);
        sFrd.addEventListener('input', updateParams);
        sBurst.addEventListener('input', updateParams);
        sDepth.addEventListener('input', () => { 
            fifoDepth = parseInt(sDepth.value);
            document.getElementById('val-depth').innerText = fifoDepth;
            initGrid();
            updateParams();
        });

        function updateParams() {
            fWr = parseInt(sFwr.value);
            fRd = parseInt(sFrd.value);
            burstSize = parseInt(sBurst.value);
            
            document.getElementById('val-fwr').innerText = fWr + " MHz";
            document.getElementById('val-frd').innerText = fRd + " MHz";
            document.getElementById('val-burst').innerText = burstSize;
            
            let reqDepth = 0;
            if (fRd >= fWr) {
                reqDepth = 1; 
            } else {
                reqDepth = Math.ceil(burstSize * (1 - (fRd/fWr)));
            }
            
            document.getElementById('calc-depth').innerText = reqDepth;
            document.getElementById('calc-formula').innerText = `${burstSize} * (1 - ${fRd}/${fWr})`;
            
            if (reqDepth > fifoDepth) {
                statusBox.classList.remove('hidden');
                statusBox.innerText = `RISK: Need ${reqDepth} slots, have ${fifoDepth}`;
            } else {
                statusBox.classList.add('hidden');
            }
        }

        function initGrid() {
            fifoGrid.innerHTML = '';
            const cols = Math.ceil(Math.sqrt(fifoDepth));
            fifoGrid.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
            
            for(let i=0; i<fifoDepth; i++) {
                const div = document.createElement('div');
                div.className = "fifo-cell w-6 h-6 rounded";
                div.id = `cell-${i}`;
                fifoGrid.appendChild(div);
            }
            currentFill = 0;
            wPtr = 0; rPtr = 0;
            syncRdQ = [0,0]; syncWrQ = [0,0];
            
            overflowOccurred = false;
            overflowBox.classList.add('hidden');
            updateVisuals(false, false, false);
        }

        function startBurst() {
            if (is_bursting) return;
            is_bursting = true;
            packetsWritten = 0;
            writeAccumulator = 0;
            overflowOccurred = false;
            overflowBox.classList.add('hidden');
        }

        // --- Helpers for CDC ---
        function toBinary(n) { return n.toString(2).padStart(4, '0'); }
        function toGray(n) { return toBinary(n ^ (n >> 1)); }

        // --- Simulation Loop ---
        function step() {
            time++;
            
            let wrote = false;
            let read = false;
            let overflowFrame = false;
            
            // WRITE DOMAIN
            writeAccumulator += fWr / 60; 
            if (writeAccumulator >= 1) {
                const writes = Math.floor(writeAccumulator);
                writeAccumulator -= writes;
                
                // Synchronize Read Pointer to Write Domain
                // Shift in current Gray Read Ptr
                syncRdQ.push(rPtr ^ (rPtr >> 1)); 
                if(syncRdQ.length > 2) syncRdQ.shift(); 
                
                for(let i=0; i<writes; i++) {
                    // Update Pointers logic (Full Flag Check would happen here using syncRdQ[0])
                    if (is_bursting && packetsWritten < burstSize) {
                        if (currentFill < fifoDepth) {
                            currentFill++;
                            wPtr = (wPtr + 1) % (fifoDepth * 2); // Use extra bit for full/empty check
                            wrote = true;
                        } else {
                            overflowFrame = true;
                            overflowOccurred = true;
                        }
                        packetsWritten++;
                    }
                }
                if (packetsWritten >= burstSize) is_bursting = false;
            }

            // READ DOMAIN
            readAccumulator += fRd / 60;
            if (readAccumulator >= 1) {
                const reads = Math.floor(readAccumulator);
                readAccumulator -= reads;
                
                // Synchronize Write Pointer to Read Domain
                syncWrQ.push(wPtr ^ (wPtr >> 1));
                if(syncWrQ.length > 2) syncWrQ.shift();

                for(let i=0; i<reads; i++) {
                    if (currentFill > 0) {
                        currentFill--;
                        rPtr = (rPtr + 1) % (fifoDepth * 2);
                        read = true;
                    }
                }
            }

            updateVisuals(wrote, read, overflowFrame);
            updateCDCVisuals();
            
            history.push(currentFill);
            if (history.length > MAX_HISTORY) history.shift();
            drawGraph();

            requestAnimationFrame(step);
        }

        function updateCDCVisuals() {
            // Write Domain UI
            document.getElementById('cdc-wbin').innerText = toBinary(wPtr);
            document.getElementById('cdc-wgray').innerText = toGray(wPtr);
            
            // Read Domain UI
            document.getElementById('cdc-rbin').innerText = toBinary(rPtr);
            document.getElementById('cdc-rgray').innerText = toGray(rPtr);

            // Flags
            const isEmpty = (rPtr === wPtr); // Simplified
            const isFull = currentFill >= fifoDepth;

            const elEmpty = document.getElementById('cdc-empty');
            elEmpty.innerText = isEmpty ? "1" : "0";
            elEmpty.className = isEmpty ? "font-bold text-green-400" : "font-bold text-slate-600";

            const elFull = document.getElementById('cdc-full');
            elFull.innerText = isFull ? "1" : "0";
            elFull.className = isFull ? "font-bold text-red-500" : "font-bold text-slate-600";

            // Anim
            const w2r = document.getElementById('anim-w2r');
            w2r.style.opacity = Math.random(); 
            w2r.style.left = (time % 100) + "%";

            const r2w = document.getElementById('anim-r2w');
            r2w.style.opacity = Math.random(); 
            r2w.style.right = (time % 100) + "%";
        }

        function updateVisuals(wrote, read, overflowFrame) {
            lblFill.innerText = `${currentFill} / ${fifoDepth}`;
            
            if (overflowOccurred) {
                 lblStatus.innerText = "OVERFLOW!";
                 lblStatus.className = "text-red-500 font-bold animate-pulse";
                 overflowBox.classList.remove('hidden');
            } else if (currentFill === 0) {
                lblStatus.innerText = "EMPTY";
                lblStatus.className = "text-slate-500 font-bold";
            } else if (currentFill === fifoDepth) {
                lblStatus.innerText = "FULL";
                lblStatus.className = "text-yellow-400 font-bold";
            } else {
                lblStatus.innerText = "ACTIVE";
                lblStatus.className = "text-blue-400 font-bold";
            }
            
            // Grid
            for(let i=0; i<fifoDepth; i++) {
                const cell = document.getElementById(`cell-${i}`);
                if(!cell) continue;
                cell.className = "fifo-cell w-6 h-6 rounded"; 
                if (i < currentFill) cell.classList.add('fifo-cell-active');
                if (overflowFrame && i === fifoDepth - 1) cell.classList.add('fifo-cell-overflow');
            }
            
            wrArrow.style.opacity = wrote ? 1 : 0;
            rdArrow.style.opacity = read ? 1 : 0;
        }

        function drawGraph() {
            if(canvas.width !== canvas.parentElement.clientWidth) {
                canvas.width = canvas.parentElement.clientWidth;
                canvas.height = canvas.parentElement.clientHeight;
            }
            const w = canvas.width;
            const h = canvas.height;
            
            ctx.clearRect(0,0,w,h);

            const reqDepth = parseInt(document.getElementById('calc-depth').innerText);
            const safeY = h - (reqDepth / fifoDepth) * h;
            
            ctx.strokeStyle = '#475569';
            ctx.setLineDash([5,5]);
            ctx.beginPath();
            ctx.moveTo(0, safeY); ctx.lineTo(w, safeY);
            ctx.stroke();
            ctx.setLineDash([]);

            ctx.beginPath();
            ctx.strokeStyle = overflowOccurred ? '#ef4444' : '#60a5fa';
            ctx.lineWidth = 2;
            const step = w / MAX_HISTORY;
            
            for(let i=0; i<history.length; i++) {
                const x = i * step;
                const fillRatio = history[i] / fifoDepth;
                const y = h - (fillRatio * h);
                if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            }
            ctx.stroke();
            
            ctx.lineTo(w, h);
            ctx.lineTo(0, h);
            ctx.fillStyle = overflowOccurred ? 'rgba(239, 68, 68, 0.2)' : 'rgba(96, 165, 250, 0.1)';
            ctx.fill();
        }
        
        function resize() {
            drawGraph();
        }
        window.addEventListener('resize', resize);

        // Init
        updateParams();
        initGrid();
        requestAnimationFrame(step);

    </script>
</body>
</html>
