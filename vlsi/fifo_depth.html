<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXZS8C1FLY"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XXZS8C1FLY');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIFO Depth Calculation Lab - EcrioniX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Orbitron:wght@500;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <!-- MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        /* Mobile: Allow scroll, Desktop: Fixed */
        body { font-family: 'Outfit', sans-serif; background-color: #020617; color: #f8fafc; }
        @media (min-width: 1024px) { body { overflow: hidden; } }
        
        .tech-font { font-family: 'Orbitron', sans-serif; }
        .mono-font { font-family: 'JetBrains Mono', monospace; }

        .watermark {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 8rem; font-weight: 900; color: rgba(99, 102, 241, 0.03);
            pointer-events: none; user-select: none; z-index: 0;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px;
        }

        /* Tabs */
        .tab-btn {
            @apply px-3 py-2 text-[10px] md:text-xs font-bold rounded-lg transition-all border border-transparent text-slate-400 uppercase tracking-wider;
        }
        .tab-active {
            @apply bg-indigo-600 text-white border-indigo-500 shadow-lg shadow-indigo-500/30;
        }

        /* FIFO Visuals */
        .fifo-cell {
            transition: all 0.2s;
            border: 1px solid #334155;
            background: #0f172a;
            display: flex; align-items: center; justify-content: center;
            font-family: 'JetBrains Mono'; font-size: 10px; color: #64748b;
        }
        .fifo-cell-active {
            background: #3b82f6; border-color: #60a5fa; color: white; box-shadow: 0 0 5px #3b82f6;
        }
        .fifo-cell-read {
            animation: flash-read 0.2s;
        }
        @keyframes flash-read {
            0% { background: #4ade80; }
            100% { background: #0f172a; }
        }

        input[type=range] { accent-color: #6366f1; }

        /* Theory Styles */
        .prose h1 { @apply text-2xl md:text-3xl font-bold text-white mb-6 tech-font border-b border-slate-800 pb-2; }
        .prose h2 { @apply text-lg md:text-xl font-bold text-indigo-400 mt-8 mb-4 uppercase tracking-wider; }
        .prose p { @apply text-slate-400 mb-4 leading-relaxed text-sm md:text-base; }
        .prose strong { @apply text-white font-semibold; }
        .prose ul { @apply list-disc list-inside space-y-2 text-slate-400 mb-4; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col relative">

    <div class="watermark">EcrioniX Design</div>

    <!-- Header -->
    <nav class="border-b border-slate-800 bg-slate-900/80 px-4 md:px-6 py-3 md:py-4 flex justify-between items-center z-50 sticky top-0 backdrop-blur-md">
        <div>
            <h1 class="text-xl md:text-2xl font-bold text-indigo-400 tech-font uppercase">FIFO <span class="text-white">DEPTH</span></h1>
            <p class="text-[9px] md:text-[10px] text-slate-500 uppercase tracking-widest font-bold hidden md:block">Queue Sizing & Flow Control</p>
        </div>
        
        <div class="flex bg-slate-950 p-1 rounded-xl border border-slate-800">
            <button onclick="switchView('theory')" id="btn-theory" class="tab-btn tab-active">Theory</button>
            <button onclick="switchView('lab')" id="btn-lab" class="tab-btn">Lab</button>
        </div>

        <button onclick="window.history.back()" class="group flex items-center text-slate-400 hover:text-white transition bg-slate-800/80 px-3 py-2 rounded-lg border border-slate-700 hover:border-indigo-500 ml-2">
            <span class="text-xs font-bold uppercase hidden md:inline">Exit Lab</span>
            <span class="text-xs font-bold uppercase md:hidden">Exit</span>
        </button>
    </nav>

    <!-- Content -->
    <div class="flex-grow relative overflow-y-auto lg:overflow-hidden">

        <!-- THEORY VIEW -->
        <div id="view-theory" class="absolute inset-0 z-10 overflow-y-auto p-4 md:p-8 flex justify-center">
            <div class="max-w-4xl w-full glass-panel p-6 md:p-10 prose mb-10">
                <h1>FIFO Depth Calculation</h1>
                <p>
                    A **First-In-First-Out (FIFO)** buffer is used to safely transfer data between two modules operating at different speeds or clock domains. The critical design parameter is the **Depth**: how many slots are needed to prevent data loss (overflow) during a "burst" of writes when the reader is slower.
                </p>

                <h2>1. The Core Problem: Burst vs. Average</h2>
                <p>
                    In steady state, the average Read rate must equal the average Write rate, or the FIFO will eventually overflow or underflow. However, data often arrives in **Bursts**. The FIFO must be deep enough to store the excess data that accumulates during the burst while the reader catches up.
                </p>

                <h2>2. Synchronous FIFO (Same Clock)</h2>
                <p>
                    Even with the same clock, if the Writer sends data every cycle for a burst ($B$) but the Reader can only read every 2nd or 4th cycle (due to backpressure or protocol), a FIFO is needed.
                </p>
                <div class="bg-indigo-500/10 border-l-4 border-indigo-500 p-4 my-4">
                    <p class="text-white font-bold">Formula:</p>
                    <p class="text-center text-lg md:text-xl text-white my-2">\[ Depth = B - \left( B \times \frac{f_{rd}}{f_{wr}} \right) \]</p>
                    <p class="text-xs text-slate-400">Where $B$ is Burst Size, $f_{wr}$ is write freq, $f_{rd}$ is read freq.</p>
                </div>

                <h2>3. Asynchronous FIFO (Clock Domain Crossing)</h2>
                <p>
                    When crossing clock domains (e.g., 100MHz CPU to 50MHz Peripheral), we calculate based on the time it takes to write the burst vs. the time it takes to read during that same period.
                </p>
                <ul>
                    <li><strong>Worst Case Scenario:</strong> The writer sends a maximum burst ($B$) as fast as possible (Back-to-back cycles).</li>
                    <li>The reader reads continuously but at its own slower pace.</li>
                    <li><strong>Depth Required</strong> = (Data Written) - (Data Read during the burst time).</li>
                </ul>

                <div class="mt-8 text-center">
                    <button onclick="switchView('lab')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-8 py-3 rounded-xl font-bold transition shadow-lg shadow-indigo-500/20">Launch Experiment &rarr;</button>
                </div>
            </div>
        </div>

        <!-- LAB VIEW -->
        <div id="view-lab" class="absolute inset-0 z-0 opacity-0 pointer-events-none flex flex-col lg:flex-row p-4 lg:p-6 gap-6 overflow-y-auto lg:overflow-hidden">
            
            <!-- Left: Controls -->
            <div class="w-full lg:w-80 flex flex-col gap-4 flex-shrink-0">
                <div class="glass-panel p-6">
                    <h2 class="text-indigo-400 font-bold mb-4 uppercase text-[10px] tracking-widest">Traffic Generation</h2>
                    
                    <div class="space-y-6">
                        <!-- Write Clock -->
                        <div>
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-slate-300">Write Freq ($f_{wr}$)</span>
                                <span id="val-fwr" class="font-mono text-white font-bold">100 MHz</span>
                            </div>
                            <input type="range" id="slider-fwr" min="10" max="200" step="10" value="100" class="w-full">
                        </div>

                        <!-- Read Clock -->
                        <div>
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-slate-300">Read Freq ($f_{rd}$)</span>
                                <span id="val-frd" class="font-mono text-white font-bold">40 MHz</span>
                            </div>
                            <input type="range" id="slider-frd" min="10" max="200" step="10" value="40" class="w-full">
                        </div>

                         <!-- Burst Size -->
                        <div>
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-slate-300">Burst Size ($B$)</span>
                                <span id="val-burst" class="font-mono text-yellow-400 font-bold">20</span>
                            </div>
                            <input type="range" id="slider-burst" min="5" max="50" step="1" value="20" class="w-full">
                        </div>
                        
                         <!-- FIFO Depth Config -->
                        <div>
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-slate-300">FIFO Depth</span>
                                <span id="val-depth" class="font-mono text-blue-400 font-bold">16</span>
                            </div>
                            <input type="range" id="slider-depth" min="4" max="64" step="4" value="16" class="w-full">
                        </div>

                        <button onclick="startBurst()" id="btn-burst" class="w-full py-4 bg-emerald-600 hover:bg-emerald-500 text-white font-bold rounded-xl shadow-lg transition active:scale-95 border-b-4 border-emerald-800 active:border-b-0 active:translate-y-1 text-sm">
                            TRIGGER BURST
                        </button>
                    </div>
                </div>

                <!-- Analysis -->
                <div class="glass-panel p-6 flex-grow">
                    <h2 class="text-slate-400 font-bold mb-4 uppercase text-[10px] tracking-widest">Theoretical Requirement</h2>
                    <div class="space-y-3">
                        <div class="bg-black/40 p-3 rounded border border-slate-800 flex justify-between items-center">
                            <span class="text-xs text-slate-400">Min Depth Formula</span>
                            <span id="calc-formula" class="text-indigo-300 font-bold mono-font text-xs">--</span>
                        </div>
                        <div class="bg-black/40 p-3 rounded border border-slate-800 flex justify-between items-center">
                            <span class="text-xs text-slate-400">Calculated Depth</span>
                            <span id="calc-depth" class="text-emerald-400 font-bold mono-font text-xl">12</span>
                        </div>
                        <div id="status-box" class="p-3 rounded border border-red-900/50 bg-red-900/20 text-center text-xs font-bold text-red-400 hidden">
                            OVERFLOW RISK DETECTED
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Visualization -->
            <div class="flex-grow flex flex-col gap-6 min-h-[500px] lg:min-h-0">
                
                <!-- Visual FIFO -->
                <div class="glass-panel p-6 relative flex-grow overflow-hidden flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Buffer Status</h2>
                        <div class="flex gap-4 text-[10px] font-mono">
                            <span class="text-slate-500">Fill Level: <span id="lbl-fill" class="text-white">0</span></span>
                            <span class="text-slate-500">Status: <span id="lbl-status" class="text-green-400">EMPTY</span></span>
                        </div>
                    </div>
                    
                    <div class="flex-grow flex items-center justify-center bg-slate-900/50 rounded-xl border border-slate-800 p-8 relative">
                        <!-- Input Pipe -->
                        <div class="absolute left-0 top-1/2 -translate-y-1/2 w-10 md:w-20 h-4 bg-slate-700"></div>
                        <div id="wr-arrow" class="absolute left-2 md:left-4 top-1/2 -translate-y-1/2 text-emerald-400 font-bold text-[10px] md:text-xs opacity-0 whitespace-nowrap">WRITE &rarr;</div>
                        
                        <!-- FIFO Grid -->
                        <div id="fifo-grid" class="grid grid-cols-8 gap-1 p-2 bg-slate-800 rounded border-2 border-slate-600 transition-all duration-300">
                            <!-- Cells injected by JS -->
                        </div>
                        
                        <!-- Output Pipe -->
                        <div class="absolute right-0 top-1/2 -translate-y-1/2 w-10 md:w-20 h-4 bg-slate-700"></div>
                        <div id="rd-arrow" class="absolute right-2 md:right-4 top-1/2 -translate-y-1/2 text-blue-400 font-bold text-[10px] md:text-xs opacity-0 whitespace-nowrap">READ &rarr;</div>
                    </div>
                </div>

                <!-- Fill Level Graph -->
                <div class="glass-panel p-4 h-64 flex flex-col">
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Fill Level vs Time</h2>
                    <div class="w-full h-full bg-black/20 rounded relative">
                        <canvas id="wave-canvas"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- State ---
        let fWr = 100;
        let fRd = 40;
        let burstSize = 20;
        let fifoDepth = 16;
        
        let currentFill = 0;
        let packetsWritten = 0;
        let time = 0;
        let is_bursting = false; 
        
        // Simulation steps
        let writeAccumulator = 0;
        let readAccumulator = 0;

        const history = [];
        const MAX_HISTORY = 200;

        // DOM
        const sFwr = document.getElementById('slider-fwr');
        const sFrd = document.getElementById('slider-frd');
        const sBurst = document.getElementById('slider-burst');
        const sDepth = document.getElementById('slider-depth');
        
        const fifoGrid = document.getElementById('fifo-grid');
        const lblFill = document.getElementById('lbl-fill');
        const lblStatus = document.getElementById('lbl-status');
        const statusBox = document.getElementById('status-box');
        
        const wrArrow = document.getElementById('wr-arrow');
        const rdArrow = document.getElementById('rd-arrow');

        const canvas = document.getElementById('wave-canvas');
        const ctx = canvas.getContext('2d');

        // --- Logic ---
        function switchView(v) {
            const theory = document.getElementById('view-theory');
            const lab = document.getElementById('view-lab');
            const btnT = document.getElementById('btn-theory');
            const btnL = document.getElementById('btn-lab');

            if (v === 'theory') {
                theory.classList.remove('opacity-0', 'pointer-events-none'); theory.classList.add('z-10');
                lab.classList.add('opacity-0', 'pointer-events-none'); lab.classList.remove('z-10');
                btnT.classList.add('tab-active'); btnL.classList.remove('tab-active');
            } else {
                lab.classList.remove('opacity-0', 'pointer-events-none'); lab.classList.add('z-10');
                theory.classList.add('opacity-0', 'pointer-events-none'); theory.classList.remove('z-10');
                btnL.classList.add('tab-active'); btnT.classList.remove('tab-active');
                initGrid();
                resize();
            }
        }

        // Listeners
        sFwr.addEventListener('input', updateParams);
        sFrd.addEventListener('input', updateParams);
        sBurst.addEventListener('input', updateParams);
        sDepth.addEventListener('input', () => { 
            fifoDepth = parseInt(sDepth.value);
            document.getElementById('val-depth').innerText = fifoDepth;
            initGrid();
            updateParams();
        });

        function updateParams() {
            fWr = parseInt(sFwr.value);
            fRd = parseInt(sFrd.value);
            burstSize = parseInt(sBurst.value);
            
            document.getElementById('val-fwr').innerText = fWr + " MHz";
            document.getElementById('val-frd').innerText = fRd + " MHz";
            document.getElementById('val-burst').innerText = burstSize;
            
            // Calc Theory
            // Depth = B - (B * f_rd/f_wr)
            let reqDepth = 0;
            if (fRd >= fWr) {
                reqDepth = 1; // Minimal
            } else {
                reqDepth = Math.ceil(burstSize * (1 - (fRd/fWr)));
            }
            
            document.getElementById('calc-depth').innerText = reqDepth;
            document.getElementById('calc-formula').innerText = `${burstSize} * (1 - ${fRd}/${fWr})`;
            
            // Risk Warning
            if (reqDepth > fifoDepth) {
                statusBox.classList.remove('hidden');
                statusBox.innerText = `RISK: Need ${reqDepth} slots, have ${fifoDepth}`;
            } else {
                statusBox.classList.add('hidden');
            }
        }

        function initGrid() {
            fifoGrid.innerHTML = '';
            // Adjust grid columns based on depth to keep square-ish
            const cols = Math.ceil(Math.sqrt(fifoDepth));
            fifoGrid.style.gridTemplateColumns = `repeat(${cols}, minmax(0, 1fr))`;
            
            for(let i=0; i<fifoDepth; i++) {
                const div = document.createElement('div');
                div.className = "fifo-cell w-6 h-6 rounded";
                div.id = `cell-${i}`;
                fifoGrid.appendChild(div);
            }
            currentFill = 0;
            updateVisuals();
        }

        function startBurst() {
            if (is_bursting) return;
            is_bursting = true;
            packetsWritten = 0;
            writeAccumulator = 0;
        }

        // --- Simulation Loop ---
        
        function step() {
            time++;
            
            // Write Logic
            let wrote = false;
            if (is_bursting && packetsWritten < burstSize) {
                writeAccumulator += fWr / 60; 
                if (writeAccumulator >= 1) {
                    const writes = Math.floor(writeAccumulator);
                    writeAccumulator -= writes;
                    
                    for(let i=0; i<writes; i++) {
                        if (packetsWritten < burstSize) {
                            if (currentFill < fifoDepth) {
                                currentFill++;
                                wrote = true;
                            } else {
                                // Overflow!
                                lblStatus.innerText = "OVERFLOW!";
                                lblStatus.className = "text-red-500 font-bold animate-pulse";
                            }
                            packetsWritten++;
                        }
                    }
                }
                if (packetsWritten >= burstSize) is_bursting = false;
            }

            // Read Logic
            let read = false;
            if (currentFill > 0) {
                readAccumulator += fRd / 60;
                if (readAccumulator >= 1) {
                    const reads = Math.floor(readAccumulator);
                    readAccumulator -= reads;
                    
                    for(let i=0; i<reads; i++) {
                        if (currentFill > 0) {
                            currentFill--;
                            read = true;
                        }
                    }
                }
            } else {
                readAccumulator = 0;
            }

            // Visuals
            updateVisuals(wrote, read);
            
            // Graph
            history.push(currentFill);
            if (history.length > MAX_HISTORY) history.shift();
            drawGraph();

            requestAnimationFrame(step);
        }

        function updateVisuals(wrote, read) {
            lblFill.innerText = `${currentFill} / ${fifoDepth}`;
            
            if (currentFill === 0) {
                lblStatus.innerText = "EMPTY";
                lblStatus.className = "text-slate-500 font-bold";
            } else if (currentFill === fifoDepth) {
                lblStatus.innerText = "FULL";
                lblStatus.className = "text-yellow-400 font-bold";
            } else {
                lblStatus.innerText = "ACTIVE";
                lblStatus.className = "text-blue-400 font-bold";
            }
            
            // Grid
            for(let i=0; i<fifoDepth; i++) {
                const cell = document.getElementById(`cell-${i}`);
                if(!cell) continue;
                if (i < currentFill) {
                    cell.className = "fifo-cell fifo-cell-active w-6 h-6 rounded";
                } else {
                    cell.className = "fifo-cell w-6 h-6 rounded";
                }
            }
            
            // Arrows
            wrArrow.style.opacity = wrote ? 1 : 0;
            rdArrow.style.opacity = read ? 1 : 0;
        }

        function drawGraph() {
            if(!canvas || !canvas.parentElement) return;
            
            if(canvas.width !== canvas.parentElement.clientWidth) {
                canvas.width = canvas.parentElement.clientWidth;
                canvas.height = canvas.parentElement.clientHeight;
            }
            const w = canvas.width;
            const h = canvas.height;
            
            ctx.clearRect(0,0,w,h);

            // Safe Zone
            const reqDepth = parseInt(document.getElementById('calc-depth').innerText);
            const safeY = h - (reqDepth / fifoDepth) * h;
            
            ctx.strokeStyle = '#475569';
            ctx.setLineDash([5,5]);
            ctx.beginPath();
            ctx.moveTo(0, safeY); ctx.lineTo(w, safeY);
            ctx.stroke();
            ctx.setLineDash([]);

            // Fill Trace
            ctx.beginPath();
            ctx.strokeStyle = '#60a5fa';
            ctx.lineWidth = 2;
            const step = w / MAX_HISTORY;
            
            for(let i=0; i<history.length; i++) {
                const x = i * step;
                const fillRatio = history[i] / fifoDepth;
                const y = h - (fillRatio * h);
                if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
            }
            ctx.stroke();
            
            // Fill
            ctx.lineTo(w, h);
            ctx.lineTo(0, h);
            ctx.fillStyle = 'rgba(96, 165, 250, 0.1)';
            ctx.fill();
        }
        
        function resize() {
            drawGraph();
        }
        window.addEventListener('resize', resize);

        // Init
        updateParams();
        initGrid();
        requestAnimationFrame(step);

    </script>
</body>
</html>
