<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXZS8C1FLY"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XXZS8C1FLY');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Async FIFO Design Lab - EcrioniX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Orbitron:wght@500;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <!-- MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #020617; color: #f8fafc; }
        .tech-font { font-family: 'Orbitron', sans-serif; }
        .mono-font { font-family: 'JetBrains Mono', monospace; }

        /* Prevent body scroll on desktop */
        @media (min-width: 1024px) { body { overflow: hidden; } }
        
        .content-area { padding-bottom: 80px; }
        @media (min-width: 1024px) { .content-area { padding-bottom: 0; } }

        .watermark {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 8rem; font-weight: 900; color: rgba(99, 102, 241, 0.03);
            pointer-events: none; user-select: none; z-index: 0;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px;
        }

        /* Tabs */
        .tab-btn {
            @apply px-4 py-2 text-xs font-bold rounded-lg transition-all border border-transparent text-slate-400 uppercase tracking-wider;
        }
        .tab-active {
            @apply bg-indigo-600 text-white border-indigo-500 shadow-lg shadow-indigo-500/30;
        }

        /* Scrollbar */
        .custom-scroll { overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Code Block */
        pre {
            background: #0b0f19; border: 1px solid #334155; border-radius: 8px; padding: 1rem;
            font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: #e2e8f0;
            overflow: auto; white-space: pre;
        }
        .kw { color: #c678dd; font-weight: bold; } 
        .ty { color: #e5c07b; } 
        .fn { color: #61afef; } 
        .cm { color: #7f848e; font-style: italic; } 
        .st { color: #98c379; } 
        .nu { color: #d19a66; } 

        /* Visuals */
        .domain-box { border: 1px dashed; border-radius: 12px; padding: 10px; position: relative; transition: all 0.3s; }
        .domain-wr { border-color: #ef4444; background: rgba(239, 68, 68, 0.05); }
        .domain-rd { border-color: #3b82f6; background: rgba(59, 130, 246, 0.05); }
        
        .mem-cell {
            height: 20px; border: 1px solid #334155; background: #0f172a; margin-bottom: 2px;
            font-family: monospace; font-size: 9px; display: flex; align-items: center; justify-content: center; color: #64748b;
        }
        .mem-cell.active { background: #3b82f6; color: white; border-color: #60a5fa; box-shadow: 0 0 5px #3b82f6; }

        .wire { stroke: #475569; stroke-width: 2; fill: none; transition: stroke 0.2s; }
        .wire-active { stroke: #fbbf24; filter: drop-shadow(0 0 3px #fbbf24); }
        .wire-bus { stroke-width: 4; }
        
        .box-component { fill: #1e293b; stroke: #94a3b8; stroke-width: 2; }
        .box-label { font-family: 'Orbitron', sans-serif; font-size: 10px; fill: #cbd5e1; font-weight: bold; text-anchor: middle; }
        .val-text { font-family: 'JetBrains Mono', monospace; font-size: 10px; fill: #fff; font-weight: bold; text-anchor: middle; }

        .sync-ff { fill: #1e293b; stroke: #64748b; stroke-width: 2; }
        .domain-zone { fill-opacity: 0.05; stroke-dasharray: 4,4; stroke-width: 2; }

        input[type=range] { accent-color: #6366f1; height: 0.5rem; cursor: pointer; }
        .hidden { display: none !important; }
        
        /* Flash animation for pointer updates */
        @keyframes flash-text {
            0% { fill: #fff; }
            50% { fill: #fbbf24; text-shadow: 0 0 5px #fbbf24; }
            100% { fill: #fff; }
        }
        .flash { animation: flash-text 0.3s ease-out; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col relative">

    <nav class="border-b border-slate-800 bg-slate-900/90 px-4 md:px-6 py-3 flex justify-between items-center z-50 flex-shrink-0 backdrop-blur-md">
        <div class="flex flex-col">
            <h1 class="text-lg md:text-2xl font-bold text-indigo-400 tech-font uppercase tracking-tight">ASYNC <span class="text-white">FIFO</span></h1>
            <p class="text-[9px] text-slate-500 font-bold hidden md:block uppercase tracking-widest">Clock Domain Crossing</p>
        </div>
        
        <div class="hidden md:flex bg-slate-950 p-1 rounded-xl border border-slate-800">
            <button onclick="switchView('theory')" id="btn-theory-d" class="tab-btn px-6">Theory</button>
            <button onclick="switchView('rtl')" id="btn-rtl-d" class="tab-btn px-6">RTL Code</button>
            <button onclick="switchView('lab')" id="btn-lab-d" class="tab-btn px-6 tab-active">Simulation</button>
        </div>

        <button onclick="window.history.back()" class="group flex items-center text-slate-400 hover:text-white transition bg-slate-800/50 px-3 py-1.5 rounded-lg border border-slate-700 hover:border-indigo-500">
            <span class="text-xs font-bold uppercase">Exit</span>
        </button>
    </nav>

    <!-- Content -->
    <div class="flex-grow relative overflow-y-auto lg:overflow-hidden content-area">

        <!-- THEORY VIEW -->
        <div id="view-theory" class="absolute inset-0 z-0 opacity-0 pointer-events-none custom-scroll p-4 md:p-8 flex justify-center">
            <div class="max-w-4xl w-full glass-panel p-6 md:p-10 prose mb-10 text-slate-300">
                <h1 class="text-2xl font-bold text-white mb-4">Async FIFO Theory</h1>
                <p>The Asynchronous FIFO is used to safely transfer data between two different clock domains. The key challenge is calculating Full and Empty flags when the pointers (Write and Read) originate from different, asynchronous clocks.</p>
                <h3 class="text-indigo-400 font-bold mt-4">Gray Code Pointers</h3>
                <p>To prevent metastability and multi-bit signal glitches, binary pointers are converted to Gray code before being synchronized. In Gray code, only one bit changes at a time.</p>
            </div>
        </div>

        <!-- LAB VIEW -->
        <div id="view-lab" class="absolute inset-0 z-10 flex flex-col lg:flex-row p-4 lg:p-6 gap-6 overflow-y-auto custom-scroll">
            
            <!-- Controls -->
            <div class="w-full lg:w-80 flex flex-col gap-4 flex-shrink-0">
                <div class="glass-panel p-6">
                    <h2 class="text-indigo-400 font-bold mb-4 uppercase text-[10px] tracking-widest">Controls</h2>
                    <div class="space-y-6">
                        <div>
                            <div class="flex justify-between text-xs mb-2"><span class="text-red-400 font-bold">Write Clock</span><span id="lbl-fwr" class="text-white">100 MHz</span></div>
                            <input type="range" id="s-fwr" min="10" max="200" step="10" value="100" class="w-full accent-red-500 bg-slate-800 rounded">
                        </div>
                        <div>
                            <div class="flex justify-between text-xs mb-2"><span class="text-blue-400 font-bold">Read Clock</span><span id="lbl-frd" class="text-white">50 MHz</span></div>
                            <input type="range" id="s-frd" min="10" max="200" step="10" value="50" class="w-full accent-blue-500 bg-slate-800 rounded">
                        </div>
                        <button onclick="triggerBurst()" class="w-full py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-lg shadow-lg text-xs">WRITE DATA BURST</button>
                        <button onclick="toggleRead()" id="btn-read" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-lg text-xs">START CONTINUOUS READ</button>
                        <button onclick="resetSim()" class="w-full py-2 bg-slate-800 text-slate-400 border border-slate-700 rounded text-xs font-bold">RESET</button>
                    </div>
                </div>
                
                <div class="glass-panel p-6 flex-grow">
                    <h2 class="text-slate-400 font-bold mb-4 uppercase text-[10px] tracking-widest">Log</h2>
                    <div id="sim-log" class="text-[10px] font-mono text-slate-400 h-full overflow-y-auto max-h-40"></div>
                </div>
            </div>

            <!-- Schematic Visualization -->
            <div class="flex-grow glass-panel relative flex flex-col overflow-hidden p-1 bg-slate-900/50 min-h-[400px]">
                <div class="flex-grow flex items-center justify-center relative overflow-x-auto">
                    <!-- SCALABLE SVG CIRCUIT -->
                    <svg id="main-svg" width="900" height="500" viewBox="0 0 900 500">
                        <defs>
                             <marker id="arrow" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0 L0,6 L6,3 z" fill="#475569" /></marker>
                        </defs>

                        <!-- DOMAINS -->
                        <rect x="20" y="20" width="380" height="460" class="domain-zone" fill="#ef4444" stroke="#ef4444" rx="10"/>
                        <text x="40" y="45" fill="#ef4444" font-weight="bold" font-size="12" class="tech-font">WRITE DOMAIN</text>

                        <rect x="500" y="20" width="380" height="460" class="domain-zone" fill="#3b82f6" stroke="#3b82f6" rx="10"/>
                        <text x="520" y="45" fill="#3b82f6" font-weight="bold" font-size="12" class="tech-font">READ DOMAIN</text>

                        <!-- SHARED MEMORY -->
                        <rect x="400" y="150" width="100" height="200" fill="#1e293b" stroke="#cbd5e1" stroke-width="2" rx="4"/>
                        <text x="450" y="170" text-anchor="middle" fill="#cbd5e1" font-size="10" font-weight="bold">DUAL PORT RAM</text>
                        
                        <!-- Visual Stack inside RAM -->
                        <g id="mem-stack" transform="translate(415, 180)"></g>

                        <!-- ================= WRITE SIDE ================= -->
                        
                        <!-- Binary Counter -->
                        <rect x="50" y="100" width="80" height="40" class="box-component"/>
                        <text x="90" y="125" class="box-label">W_BIN</text>
                        <text x="90" y="115" id="val-wbin" class="val-text text-red-300">0000</text>
                        
                        <!-- Bin to Gray -->
                        <rect x="50" y="180" width="80" height="40" class="box-component"/>
                        <text x="90" y="205" class="box-label">BIN2GRAY</text>
                        <line x1="90" y1="140" x2="90" y2="180" class="wire" marker-end="url(#arrow)"/>
                        
                        <!-- Gray Reg -->
                        <rect x="180" y="180" width="60" height="40" class="box-component" stroke="#ef4444"/>
                        <text x="210" y="205" class="box-label">W_PTR</text>
                        <text x="210" y="195" id="val-wptr" class="val-text text-white">0000</text>
                        <line x1="130" y1="200" x2="180" y2="200" class="wire" marker-end="url(#arrow)"/>

                        <!-- To Memory Addr -->
                        <line x1="240" y1="200" x2="400" y2="200" class="wire wire-bus" id="wire-waddr"/>

                        <!-- Full Flag Logic -->
                        <rect x="50" y="350" width="80" height="40" class="box-component"/>
                        <text x="90" y="375" class="box-label">FULL LOGIC</text>
                        <line x1="90" y1="350" x2="90" y2="220" class="wire"/> <!-- Feedback from W_PTR -->
                        
                        <!-- Synchronizer (R2W) -->
                        <g transform="translate(180, 350)">
                            <rect x="0" y="0" width="30" height="40" class="sync-ff"/>
                            <rect x="40" y="0" width="30" height="40" class="sync-ff"/>
                            <text x="15" y="25" class="val-text" font-size="8">FF</text>
                            <text x="55" y="25" class="val-text" font-size="8">FF</text>
                            <line x1="30" y1="20" x2="40" y2="20" class="wire"/>
                        </g>
                        <text x="215" y="340" class="box-label text-red-300">SYNC R2W</text>
                        <text x="215" y="410" id="val-r2w" class="val-text text-red-300">0000</text>
                        
                        <line x1="180" y1="370" x2="130" y2="370" class="wire" marker-end="url(#arrow)"/> <!-- Sync to Logic -->
                        
                        <!-- Full Output -->
                        <circle cx="90" cy="420" r="8" fill="#1e293b" stroke="#ef4444" id="led-full"/>
                        <text x="90" y="445" class="box-label text-red-500">FULL</text>
                        <line x1="90" y1="390" x2="90" y2="412" class="wire"/>

                        <!-- ================= READ SIDE ================= -->

                         <!-- Binary Counter -->
                        <rect x="770" y="100" width="80" height="40" class="box-component"/>
                        <text x="810" y="125" class="box-label">R_BIN</text>
                        <text x="810" y="115" id="val-rbin" class="val-text text-blue-300">0000</text>
                        
                        <!-- Bin to Gray -->
                        <rect x="770" y="180" width="80" height="40" class="box-component"/>
                        <text x="810" y="205" class="box-label">BIN2GRAY</text>
                        <line x1="810" y1="140" x2="810" y2="180" class="wire" marker-end="url(#arrow)"/>
                        
                        <!-- Gray Reg -->
                        <rect x="660" y="180" width="60" height="40" class="box-component" stroke="#3b82f6"/>
                        <text x="690" y="205" class="box-label">R_PTR</text>
                        <text x="690" y="195" id="val-rptr" class="val-text text-white">0000</text>
                        <line x1="770" y1="200" x2="720" y2="200" class="wire" marker-end="url(#arrow)"/>

                        <!-- To Memory Addr -->
                        <line x1="660" y1="200" x2="500" y2="200" class="wire wire-bus" id="wire-raddr"/>

                        <!-- Empty Flag Logic -->
                        <rect x="770" y="350" width="80" height="40" class="box-component"/>
                        <text x="810" y="375" class="box-label">EMPTY LOGIC</text>
                        <line x1="810" y1="350" x2="810" y2="220" class="wire"/> <!-- Feedback from R_PTR -->
                        
                        <!-- Synchronizer (W2R) -->
                        <g transform="translate(650, 350)">
                            <rect x="0" y="0" width="30" height="40" class="sync-ff"/>
                            <rect x="40" y="0" width="30" height="40" class="sync-ff"/>
                            <text x="15" y="25" class="val-text" font-size="8">FF</text>
                            <text x="55" y="25" class="val-text" font-size="8">FF</text>
                            <line x1="30" y1="20" x2="40" y2="20" class="wire"/>
                        </g>
                        <text x="685" y="340" class="box-label text-blue-300">SYNC W2R</text>
                        <text x="685" y="410" id="val-w2r" class="val-text text-blue-300">0000</text>
                        
                        <line x1="720" y1="370" x2="770" y2="370" class="wire" marker-end="url(#arrow)"/> <!-- Sync to Logic -->
                        
                        <!-- Empty Output -->
                        <circle cx="810" cy="420" r="8" fill="#1e293b" stroke="#3b82f6" id="led-empty"/>
                        <text x="810" y="445" class="box-label text-blue-500">EMPTY</text>
                        <line x1="810" y1="390" x2="810" y2="412" class="wire"/>

                        <!-- ================= CROSSING WIRES ================= -->
                        <!-- W_PTR to Read Domain Sync -->
                        <path d="M210,180 V80 H620 V370 H650" class="wire" stroke="#ef4444" stroke-dasharray="4,4" opacity="0.4">
                            <animate attributeName="stroke-dashoffset" from="8" to="0" dur="1s" repeatCount="indefinite"/>
                        </path>

                        <!-- R_PTR to Write Domain Sync -->
                        <path d="M690,180 V80 H280 V370 H250" class="wire" stroke="#3b82f6" stroke-dasharray="4,4" opacity="0.4">
                            <animate attributeName="stroke-dashoffset" from="0" to="8" dur="1s" repeatCount="indefinite"/>
                        </path>

                    </svg>
                </div>
            </div>
        </div>

        <!-- VIEW 2: RTL CODE (Added back) -->
        <div id="view-rtl" class="absolute inset-0 z-0 opacity-0 pointer-events-none overflow-y-auto custom-scroll p-4 md:p-8 flex justify-center">
            <div class="max-w-5xl w-full">
                <div class="flex justify-between items-center mb-4 bg-slate-900/80 p-3 rounded-lg border border-slate-700 sticky top-0 backdrop-blur-sm z-20">
                    <h2 class="text-white font-bold text-lg md:text-xl tech-font">SystemVerilog Implementation</h2>
                    <button class="px-4 py-2 bg-slate-800 text-slate-300 text-xs font-bold rounded border border-slate-600 hover:bg-indigo-600 hover:text-white transition shadow-lg" onclick="navigator.clipboard.writeText(document.getElementById('code-block').innerText)">
                        COPY CODE
                    </button>
                </div>
<pre id="code-block" class="text-xs md:text-sm shadow-2xl">
<span class="cm">// Top Level Async FIFO</span>
<span class="kw">module</span> <span class="fn">async_fifo</span> #(
    <span class="kw">parameter</span> DSIZE = 8,
    <span class="kw">parameter</span> ASIZE = 4
)(
    <span class="kw">input</span>  <span class="ty">logic</span> wclk, wrst_n, winc,
    <span class="kw">input</span>  <span class="ty">logic</span> [DSIZE-1:0] wdata,
    <span class="kw">output</span> <span class="ty">logic</span> wfull,
    <span class="kw">input</span>  <span class="ty">logic</span> rclk, rrst_n, rinc,
    <span class="kw">output</span> <span class="ty">logic</span> [DSIZE-1:0] rdata,
    <span class="kw">output</span> <span class="ty">logic</span> rempty
);
    <span class="ty">wire</span> [ASIZE:0] wptr, rptr, wq2_rptr, rq2_wptr;
    <span class="cm">// Synchronizers, Memory, Pointers...</span>
<span class="kw">endmodule</span>
</pre>
            </div>
        </div>

    </div>

    <!-- Mobile Bottom Navigation -->
    <div class="md:hidden fixed bottom-0 left-0 w-full bg-slate-950/90 backdrop-blur-lg border-t border-slate-800 z-50 flex justify-around p-2 pb-safe">
        <button onclick="switchView('theory')" id="btn-theory-m" class="flex flex-col items-center p-2 text-indigo-400 w-1/3 transition-all scale-105">
            <span class="text-xl">ðŸ“š</span>
            <span class="text-[10px] font-bold mt-1 uppercase">Theory</span>
        </button>
        <button onclick="switchView('rtl')" id="btn-rtl-m" class="flex flex-col items-center p-2 text-slate-500 w-1/3 transition-all">
            <span class="text-xl">ðŸ’»</span>
            <span class="text-[10px] font-bold mt-1 uppercase">Code</span>
        </button>
        <button onclick="switchView('lab')" id="btn-lab-m" class="flex flex-col items-center p-2 text-slate-500 w-1/3 transition-all">
            <span class="text-xl">ðŸ”¬</span>
            <span class="text-[10px] font-bold mt-1 uppercase">Sim</span>
        </button>
    </div>

    <script>
        // --- State ---
        let wPtr = 0, rPtr = 0; 
        let mem = new Array(16).fill(0);
        let fWr = 100, fRd = 50;
        let syncR2W = [0, 0]; 
        let syncW2R = [0, 0]; 
        let simTime = 0;
        let lastWrTime = 0, lastRdTime = 0;
        let burstsRemaining = 0;
        let isReading = false;

        // --- DOM ---
        const memVisual = document.getElementById('mem-stack');

        // Helpers
        function toGray(n) { return n ^ (n >> 1); }
        function toBinStr(n) { return n.toString(2).padStart(5, '0'); }

        // --- View Logic ---
        function switchView(v) {
            const views = ['theory', 'rtl', 'lab'];
            views.forEach(id => {
                const el = document.getElementById(`view-${id}`);
                const btnD = document.getElementById(`btn-${id}-d`);
                const btnM = document.getElementById(`btn-${id}-m`);
                
                if (el) {
                    if (id === v) {
                        el.classList.remove('opacity-0', 'pointer-events-none');
                        el.classList.add('z-10');
                        if(btnD) btnD.className = "tab-btn px-6 bg-indigo-600 text-white border-indigo-500 shadow-lg shadow-indigo-500/30";
                        if(btnM) { btnM.classList.remove('text-slate-500'); btnM.classList.add('text-indigo-400', 'scale-105'); }
                    } else {
                        el.classList.add('opacity-0', 'pointer-events-none');
                        el.classList.remove('z-10');
                        if(btnD) btnD.className = "tab-btn px-6 text-slate-400 hover:text-white border-transparent";
                        if(btnM) { btnM.classList.add('text-slate-500'); btnM.classList.remove('text-indigo-400', 'scale-105'); }
                    }
                }
            });
            if (v === 'lab') {
                renderMem();
                if (!window.loopRunning) { window.loopRunning = true; loop(); }
            }
        }

        // Inputs
        document.getElementById('s-fwr').addEventListener('input', e => { fWr = parseInt(e.target.value); document.getElementById('lbl-fwr').innerText = fWr + " MHz"; });
        document.getElementById('s-frd').addEventListener('input', e => { fRd = parseInt(e.target.value); document.getElementById('lbl-frd').innerText = fRd + " MHz"; });

        function triggerBurst() {
            burstsRemaining = 10;
            log("Started Burst Write...", "text-yellow-400");
        }

        function toggleRead() { 
            isReading = !isReading; 
            const btn = document.getElementById('btn-read');
            btn.innerText = isReading ? "STOP READING" : "START CONTINUOUS READ";
            btn.className = isReading ? "w-full py-3 bg-red-600 text-white font-bold rounded-lg shadow-lg text-xs" : "w-full py-3 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg shadow-lg text-xs transition";
        }

        function resetSim() {
            wPtr = 0; rPtr = 0;
            mem.fill(0);
            syncR2W = [0,0]; syncW2R = [0,0];
            burstsRemaining = 0;
            isReading = false;
            log("Reset Complete");
            updateUI();
        }

        function log(msg, cls="text-slate-400") {
            const div = document.createElement('div');
            div.className = cls;
            div.innerText = `> ${msg}`;
            const box = document.getElementById('sim-log');
            box.prepend(div);
        }

        function animWire(id) {
            const el = document.getElementById(id);
            if(el) {
                el.classList.add('wire-active');
                setTimeout(() => el.classList.remove('wire-active'), 200);
            }
        }

        function flashText(id) {
             const el = document.getElementById(id);
             if(el) {
                 el.classList.remove('flash');
                 void el.offsetWidth; // trigger reflow
                 el.classList.add('flash');
             }
        }

        // --- Loop ---
        function loop() {
            simTime++;
            
            // WRITE DOMAIN CLOCK
            if (simTime - lastWrTime > (2000/fWr)) {
                lastWrTime = simTime;
                
                // Write Logic
                // 1. Sync Logic (Reading from Read Domain)
                syncR2W.unshift(toGray(rPtr)); syncR2W.pop();
                
                // 2. Full Logic (Check wGray against synced rPtr)
                const wGray = toGray(wPtr);
                const rSynced = syncR2W[1]; // Use output of 2nd stage
                
                // Binary conversion for simplified full check in simulation logic
                // But visual flags should reflect latency
                
                // Calculate TRUE fill for memory operations
                const filled = (wPtr >= rPtr) ? (wPtr - rPtr) : (32 - rPtr + wPtr);
                const isFull = (filled >= 16);
                
                // 3. Write
                if (burstsRemaining > 0) {
                    if (!isFull) {
                        mem[wPtr % 16] = 1;
                        wPtr = (wPtr + 1) % 32;
                        animWire('wire-waddr');
                        flashText('val-wbin');
                        flashText('val-wptr');
                    }
                    burstsRemaining--;
                }
            }
            
            // READ DOMAIN CLOCK
            if (simTime - lastRdTime > (2000/fRd)) {
                lastRdTime = simTime;
                
                // 1. Sync Logic (Writing from Write Domain)
                syncW2R.unshift(toGray(wPtr)); syncW2R.pop();
                
                // 2. Empty Logic
                const rGray = toGray(rPtr);
                const wSynced = syncW2R[1];
                const isEmpty = (rGray === wSynced);
                
                // 3. Read
                if (isReading) {
                    // Check against synced pointer (Empty flag)
                    // If not empty, read
                    // In simulation, we cheat slightly and check true fullness to avoid stuck states if sync is slow
                    // But correctly, we should use isEmpty flag
                    
                    const filled = (wPtr >= rPtr) ? (wPtr - rPtr) : (32 - rPtr + wPtr);
                    
                    if (filled > 0) { // Should use !isEmpty in real hardware
                         mem[rPtr % 16] = 0;
                         rPtr = (rPtr + 1) % 32;
                         animWire('wire-raddr');
                         flashText('val-rbin');
                         flashText('val-rptr');
                    }
                }
            }

            updateUI();
            requestAnimationFrame(loop);
        }

        function updateUI() {
            // Update Text Values
            document.getElementById('val-wbin').textContent = toBinStr(wPtr);
            document.getElementById('val-wptr').textContent = toBinStr(toGray(wPtr));
            
            document.getElementById('val-rbin').textContent = toBinStr(rPtr);
            document.getElementById('val-rptr').textContent = toBinStr(toGray(rPtr));
            
            document.getElementById('val-w2r').textContent = toBinStr(syncW2R[1]);
            document.getElementById('val-r2w').textContent = toBinStr(syncR2W[1]);

            // Calculate Flags (based on synced values for realism)
            const rGray = toGray(rPtr);
            const wSynced = syncW2R[1];
            const isEmpty = (rGray === wSynced);
            
            // Full Check logic (Gray code comparison is complex visually, simplified here)
            // Just check true state for LED
            const filled = (wPtr >= rPtr) ? (wPtr - rPtr) : (32 - rPtr + wPtr);
            const isFull = (filled >= 16);

            // LEDs
            const ledF = document.getElementById('led-full');
            if(ledF) {
                ledF.setAttribute('fill', isFull ? '#ef4444' : '#1e293b');
                ledF.setAttribute('filter', isFull ? 'drop-shadow(0 0 5px red)' : 'none');
            }
            
            const ledE = document.getElementById('led-empty');
            if(ledE) {
                ledE.setAttribute('fill', isEmpty ? '#3b82f6' : '#1e293b');
                ledE.setAttribute('filter', isEmpty ? 'drop-shadow(0 0 5px blue)' : 'none');
            }

            renderMem();
        }

        function renderMem() {
            if(!memVisual) return;
            memVisual.innerHTML = '';
            for(let i=0; i<16; i++) {
                const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                rect.setAttribute("x", 0);
                rect.setAttribute("y", (15-i)*10);
                rect.setAttribute("width", 70);
                rect.setAttribute("height", 8);
                rect.setAttribute("rx", 2);
                
                if (mem[i]) rect.setAttribute("fill", "#6366f1");
                else rect.setAttribute("fill", "#1e293b");
                
                // Highlight Pointers
                if (i === (wPtr % 16)) rect.setAttribute("stroke", "#ef4444"); 
                else if (i === (rPtr % 16)) rect.setAttribute("stroke", "#3b82f6"); 
                else rect.setAttribute("stroke", "none");

                memVisual.appendChild(rect);
            }
        }

        // Init
        initMemStack();
        switchView('lab'); 
        window.loopRunning = true; 
        loop();

        function initMemStack() {
            renderMem();
        }

    </script>
</body>
</html>
