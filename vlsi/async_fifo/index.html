<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXZS8C1FLY"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XXZS8C1FLY');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Async FIFO Design Lab - EcrioniX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Orbitron:wght@500;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <!-- MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #020617; color: #f8fafc; }
        .tech-font { font-family: 'Orbitron', sans-serif; }
        .mono-font { font-family: 'JetBrains Mono', monospace; }

        /* Prevent body scroll on desktop */
        @media (min-width: 1024px) { body { overflow: hidden; } }
        
        /* Mobile padding for bottom nav */
        .content-area { padding-bottom: 80px; }
        @media (min-width: 1024px) { .content-area { padding-bottom: 0; } }

        .watermark {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 8rem; font-weight: 900; color: rgba(99, 102, 241, 0.03);
            pointer-events: none; user-select: none; z-index: 0;
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px;
        }

        /* Tabs */
        .tab-btn {
            @apply px-4 py-2 text-xs font-bold rounded-lg transition-all border border-transparent text-slate-400 uppercase tracking-wider;
        }
        .tab-active {
            @apply bg-indigo-600 text-white border-indigo-500 shadow-lg shadow-indigo-500/30;
        }

        /* Scrollbar */
        .custom-scroll { overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Code Block */
        pre {
            background: #0b0f19; border: 1px solid #334155; border-radius: 8px; padding: 1rem;
            font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: #e2e8f0;
            overflow: auto; white-space: pre;
        }
        .kw { color: #c678dd; font-weight: bold; } /* Keyword */
        .ty { color: #e5c07b; } /* Type */
        .fn { color: #61afef; } /* Function/Module */
        .cm { color: #7f848e; font-style: italic; } /* Comment */
        .st { color: #98c379; } /* String */
        .nu { color: #d19a66; } /* Number */

        /* Visuals */
        .domain-box { border: 1px dashed; border-radius: 12px; padding: 10px; position: relative; transition: all 0.3s; }
        .domain-wr { border-color: #ef4444; background: rgba(239, 68, 68, 0.05); }
        .domain-rd { border-color: #3b82f6; background: rgba(59, 130, 246, 0.05); }
        
        .mem-cell {
            height: 20px; border: 1px solid #334155; background: #0f172a; margin-bottom: 2px;
            font-family: monospace; font-size: 9px; display: flex; align-items: center; justify-content: center; color: #64748b;
        }
        .mem-cell.active { background: #3b82f6; color: white; border-color: #60a5fa; box-shadow: 0 0 5px #3b82f6; }

        .wire { stroke: #475569; stroke-width: 2; fill: none; transition: stroke 0.2s; }
        .wire-active { stroke: #fbbf24; filter: drop-shadow(0 0 3px #fbbf24); }

        .sync-ff {
            width: 30px; height: 30px; border: 2px solid #64748b; background: #1e293b;
            display: flex; align-items: center; justify-content: center; font-size: 8px; color: #cbd5e1;
            position: relative;
        }
        @media (min-width: 768px) {
            .sync-ff { width: 40px; height: 50px; font-size: 10px; }
        }
        .sync-ff::after {
            content: ''; position: absolute; bottom: 0; left: -4px;
            width: 0; height: 0; border-left: 4px solid transparent; border-right: 4px solid transparent; border-bottom: 4px solid #94a3b8;
        }

        .ptr-val { font-family: 'JetBrains Mono'; font-weight: bold; font-size: 12px; }

        input[type=range] { accent-color: #6366f1; height: 0.5rem; cursor: pointer; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col relative">

    <div class="watermark">EcrioniX Logic</div>

    <!-- Header -->
    <nav class="border-b border-slate-800 bg-slate-900/90 px-4 md:px-6 py-3 flex justify-between items-center z-50 flex-shrink-0 backdrop-blur-md">
        <div class="flex flex-col">
            <h1 class="text-lg md:text-2xl font-bold text-indigo-400 tech-font uppercase tracking-tight">ASYNC <span class="text-white">FIFO</span></h1>
            <p class="text-[9px] text-slate-500 font-bold hidden md:block uppercase tracking-widest">Clock Domain Crossing</p>
        </div>
        
        <!-- Desktop Tabs (Visible on MD and larger) -->
        <div class="hidden md:flex bg-slate-950 p-1 rounded-xl border border-slate-800">
            <button onclick="switchView('theory')" id="btn-theory-d" class="tab-btn px-6 bg-indigo-600 text-white border-indigo-500 shadow-lg shadow-indigo-500/30">Theory</button>
            <button onclick="switchView('rtl')" id="btn-rtl-d" class="tab-btn px-6 text-slate-400 hover:text-white border-transparent">RTL Code</button>
            <button onclick="switchView('lab')" id="btn-lab-d" class="tab-btn px-6 text-slate-400 hover:text-white border-transparent">Simulation</button>
        </div>

        <button onclick="window.history.back()" class="group flex items-center text-slate-400 hover:text-white transition bg-slate-800/50 px-3 py-1.5 rounded-lg border border-slate-700 hover:border-indigo-500">
            <svg class="w-4 h-4 md:mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            <span class="text-xs font-bold uppercase hidden md:inline">Exit</span>
        </button>
    </nav>

    <!-- Content Area -->
    <div class="flex-grow relative overflow-y-auto lg:overflow-hidden content-area">

        <!-- TAB 1: THEORY -->
        <div id="view-theory" class="absolute inset-0 z-10 overflow-y-auto custom-scroll p-4 md:p-8 flex justify-center">
            <div class="max-w-4xl w-full glass-panel p-6 md:p-10 prose mb-10 text-slate-300 leading-relaxed">
                <h1 class="text-2xl md:text-3xl font-bold text-white mb-6 tech-font border-b border-slate-800 pb-2">The Asynchronous FIFO</h1>
                
                <h2 class="text-lg md:text-xl font-bold text-indigo-400 mt-8 mb-4 uppercase">1. Introduction to CDC</h2>
                <p class="text-sm md:text-base">
                    In modern System-on-Chips (SoCs), different functional blocks often operate at different frequencies. Transferring data between these <strong>asynchronous clock domains</strong> requires special care to avoid data loss and metastability. The Asynchronous FIFO is the standard solution.
                </p>

                <h2 class="text-lg md:text-xl font-bold text-indigo-400 mt-8 mb-4 uppercase">2. The Multi-Bit Pointer Problem</h2>
                <p class="text-sm md:text-base">
                    Passing a binary counter directly between domains is dangerous. If a pointer changes from `0111` (7) to `1000` (8), all bits toggle. Due to skew, the receiver might sample an intermediate state like `1111`, causing fatal errors.
                </p>

                <h2 class="text-lg md:text-xl font-bold text-indigo-400 mt-8 mb-4 uppercase">3. The Gray Code Solution</h2>
                <p class="text-sm md:text-base">
                    Async FIFOs use <strong>Gray Code Pointers</strong>. In Gray code, only **one bit changes** between counts (e.g., 7=`0100` -> 8=`1100`). This ensures that if sampling happens during a transition, the result is either the old value or the new oneâ€”never a random invalid state.
                </p>

                <h2 class="text-lg md:text-xl font-bold text-indigo-400 mt-8 mb-4 uppercase">4. Pessimistic Flags</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 my-4">
                    <div class="bg-slate-900 p-4 rounded border border-slate-700">
                        <strong class="text-green-400 block mb-2 text-sm">Empty Logic (Read Domain)</strong>
                        <p class="text-xs">Compares actual Read Ptr with <strong>Synced</strong> Write Ptr. Since the Write Ptr is delayed by synchronizers, the FIFO might report "Empty" even if data just arrived. This is safe.</p>
                    </div>
                    <div class="bg-slate-900 p-4 rounded border border-slate-700">
                        <strong class="text-red-400 block mb-2 text-sm">Full Logic (Write Domain)</strong>
                        <p class="text-xs">Compares actual Write Ptr with <strong>Synced</strong> Read Ptr. The FIFO might report "Full" even if space just opened up. This prevents overflow.</p>
                    </div>
                </div>

                <div class="mt-8 flex flex-col md:flex-row gap-4 justify-center">
                    <button onclick="switchView('rtl')" class="bg-slate-800 hover:bg-slate-700 border border-slate-600 text-white px-8 py-3 rounded-xl font-bold transition shadow-lg text-sm">View RTL Code</button>
                    <button onclick="switchView('lab')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-8 py-3 rounded-xl font-bold transition shadow-lg shadow-indigo-500/20 text-sm">Launch Simulation &rarr;</button>
                </div>
            </div>
        </div>

        <!-- VIEW 2: RTL CODE -->
        <div id="view-rtl" class="absolute inset-0 z-0 opacity-0 pointer-events-none overflow-y-auto custom-scroll p-4 md:p-8 flex justify-center">
            <div class="max-w-5xl w-full">
                <div class="flex justify-between items-center mb-4 bg-slate-900/80 p-3 rounded-lg border border-slate-700 sticky top-0 backdrop-blur-sm z-20">
                    <h2 class="text-white font-bold text-lg md:text-xl tech-font">SystemVerilog Implementation</h2>
                    <button class="px-4 py-2 bg-slate-800 text-slate-300 text-xs font-bold rounded border border-slate-600 hover:bg-indigo-600 hover:text-white transition shadow-lg" onclick="navigator.clipboard.writeText(document.getElementById('code-block').innerText)">
                        COPY CODE
                    </button>
                </div>
                
<pre id="code-block" class="text-xs md:text-sm shadow-2xl">
<span class="cm">// Top Level Async FIFO</span>
<span class="kw">module</span> <span class="fn">async_fifo</span> #(
    <span class="kw">parameter</span> DSIZE = 8,
    <span class="kw">parameter</span> ASIZE = 4
)(
    <span class="kw">input</span>  <span class="ty">logic</span> wclk, wrst_n, winc,
    <span class="kw">input</span>  <span class="ty">logic</span> [DSIZE-1:0] wdata,
    <span class="kw">output</span> <span class="ty">logic</span> wfull,
    <span class="kw">input</span>  <span class="ty">logic</span> rclk, rrst_n, rinc,
    <span class="kw">output</span> <span class="ty">logic</span> [DSIZE-1:0] rdata,
    <span class="kw">output</span> <span class="ty">logic</span> rempty
);
    <span class="ty">wire</span> [ASIZE:0] wptr, rptr, wq2_rptr, rq2_wptr;

    <span class="cm">// Synchronizers</span>
    <span class="fn">sync_r2w</span> sync_r2w (.wclk(wclk), .wrst_n(wrst_n), .rptr(rptr), .wq2_rptr(wq2_rptr));
    <span class="fn">sync_w2r</span> sync_w2r (.rclk(rclk), .rrst_n(rrst_n), .wptr(wptr), .rq2_wptr(rq2_wptr));

    <span class="cm">// Memory</span>
    <span class="fn">fifo_mem</span> #(DSIZE, ASIZE) fifomem (.*);

    <span class="cm">// Read Domain Logic</span>
    <span class="fn">rptr_empty</span> #(ASIZE) rptr_empty (.*);

    <span class="cm">// Write Domain Logic</span>
    <span class="fn">wptr_full</span> #(ASIZE) wptr_full (.*);

<span class="kw">endmodule</span>

<span class="cm">// FIFO Memory Buffer</span>
<span class="kw">module</span> <span class="fn">fifo_mem</span> #(
    <span class="kw">parameter</span> DSIZE = 8,
    <span class="kw">parameter</span> ASIZE = 4
)(
    <span class="kw">input</span>  <span class="ty">logic</span> wclk, wclken,
    <span class="kw">input</span>  <span class="ty">logic</span> [ASIZE-1:0] waddr,
    <span class="kw">input</span>  <span class="ty">logic</span> [DSIZE-1:0] wdata,
    <span class="kw">input</span>  <span class="ty">logic</span> rclk,
    <span class="kw">input</span>  <span class="ty">logic</span> [ASIZE-1:0] raddr,
    <span class="kw">output</span> <span class="ty">logic</span> [DSIZE-1:0] rdata
);
    <span class="kw">localparam</span> DEPTH = 1 << ASIZE;
    <span class="ty">logic</span> [DSIZE-1:0] mem [0:DEPTH-1];

    <span class="kw">always_ff</span> @(<span class="kw">posedge</span> wclk)
        <span class="kw">if</span> (wclken) mem[waddr] <= wdata;

    <span class="kw">assign</span> rdata = mem[raddr];
<span class="kw">endmodule</span>

<span class="cm">// Read Pointer & Empty Generation</span>
<span class="kw">module</span> <span class="fn">rptr_empty</span> #(
    <span class="kw">parameter</span> ASIZE = 4
)(
    <span class="kw">input</span>  <span class="ty">logic</span> rclk, rrst_n, rinc,
    <span class="kw">input</span>  <span class="ty">logic</span> [ASIZE:0] rq2_wptr,
    <span class="kw">output</span> <span class="ty">logic</span> rempty,
    <span class="kw">output</span> <span class="ty">logic</span> [ASIZE-1:0] raddr,
    <span class="kw">output</span> <span class="ty">logic</span> [ASIZE:0] rptr
);
    <span class="ty">reg</span> [ASIZE:0] rbin;
    <span class="ty">wire</span> [ASIZE:0] rgraynext, rbinnext;

    <span class="kw">always_ff</span> @(<span class="kw">posedge</span> rclk <span class="kw">or negedge</span> rrst_n)
        <span class="kw">if</span> (!rrst_n) {rbin, rptr} <= 0;
        <span class="kw">else</span>         {rbin, rptr} <= {rbinnext, rgraynext};

    <span class="kw">assign</span> raddr = rbin[ASIZE-1:0];
    <span class="kw">assign</span> rbinnext = rbin + (rinc & ~rempty);
    <span class="kw">assign</span> rgraynext = (rbinnext >> 1) ^ rbinnext; <span class="cm">// Binary to Gray</span>

    <span class="cm">// Empty Check: Read Ptr == Synced Write Ptr</span>
    <span class="kw">assign</span> rempty = (rgraynext == rq2_wptr);
<span class="kw">endmodule</span>

<span class="cm">// Write Pointer & Full Generation</span>
<span class="kw">module</span> <span class="fn">wptr_full</span> #(
    <span class="kw">parameter</span> ASIZE = 4
)(
    <span class="kw">input</span>  <span class="ty">logic</span> wclk, wrst_n, winc,
    <span class="kw">input</span>  <span class="ty">logic</span> [ASIZE:0] wq2_rptr,
    <span class="kw">output</span> <span class="ty">logic</span> wfull,
    <span class="kw">output</span> <span class="ty">logic</span> [ASIZE-1:0] waddr,
    <span class="kw">output</span> <span class="ty">logic</span> [ASIZE:0] wptr
);
    <span class="ty">reg</span> [ASIZE:0] wbin;
    <span class="ty">wire</span> [ASIZE:0] wgraynext, wbinnext;

    <span class="kw">always_ff</span> @(<span class="kw">posedge</span> wclk <span class="kw">or negedge</span> wrst_n)
        <span class="kw">if</span> (!wrst_n) {wbin, wptr} <= 0;
        <span class="kw">else</span>         {wbin, wptr} <= {wbinnext, wgraynext};

    <span class="kw">assign</span> waddr = wbin[ASIZE-1:0];
    <span class="kw">assign</span> wbinnext = wbin + (winc & ~wfull);
    <span class="kw">assign</span> wgraynext = (wbinnext >> 1) ^ wbinnext;

    <span class="cm">// Full Check: MSBs different, LSBs same</span>
    <span class="kw">assign</span> wfull = (wgraynext == {~wq2_rptr[ASIZE:ASIZE-1], wq2_rptr[ASIZE-2:0]});
<span class="kw">endmodule</span>
</pre>
            </div>
        </div>

        <!-- VIEW 3: LAB -->
        <div id="view-lab" class="absolute inset-0 z-0 opacity-0 pointer-events-none flex flex-col lg:flex-row p-4 lg:p-6 gap-6 overflow-y-auto custom-scroll">
            
            <!-- Left: Controls -->
            <div class="w-full lg:w-80 flex flex-col gap-4 flex-shrink-0">
                <div class="glass-panel p-6">
                    <h2 class="text-indigo-400 font-bold mb-4 uppercase text-[10px] tracking-widest">Traffic Gen</h2>
                    
                    <div class="space-y-6">
                        <!-- Write Clock -->
                        <div>
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-red-400 font-bold">Write Freq ($f_{wr}$)</span>
                                <span id="val-fwr" class="font-mono text-white font-bold">100 MHz</span>
                            </div>
                            <input type="range" id="s-fwr" min="10" max="200" step="10" value="100" class="w-full accent-red-500 cursor-pointer h-1 bg-slate-700 rounded mb-4">
                            <button onclick="doWrite()" id="btn-wr" class="w-full py-2 bg-red-600 hover:bg-red-500 text-white rounded text-xs font-bold transition">PUSH DATA</button>
                        </div>

                        <!-- Read Clock -->
                        <div>
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-blue-400 font-bold">Read Freq ($f_{rd}$)</span>
                                <span id="val-frd" class="font-mono text-white font-bold">50 MHz</span>
                            </div>
                            <input type="range" id="s-frd" min="10" max="200" step="10" value="50" class="w-full accent-blue-500 cursor-pointer h-1 bg-slate-700 rounded mb-4">
                            <button onclick="doRead()" id="btn-rd" class="w-full py-2 bg-blue-600 hover:bg-blue-500 text-white rounded text-xs font-bold transition">POP DATA</button>
                        </div>

                        <button onclick="resetSim()" class="w-full py-2 bg-slate-800 text-slate-400 border border-slate-700 rounded text-xs font-bold hover:text-white">RESET</button>
                    </div>
                </div>

                <!-- Status -->
                <div class="glass-panel p-6 flex-grow">
                    <h2 class="text-emerald-400 font-bold mb-4 uppercase text-[10px] tracking-widest">Status</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="text-center p-2 bg-slate-900/50 rounded">
                            <div class="text-[10px] text-red-400 font-bold">FULL FLAG</div>
                            <div id="flag-full" class="w-3 h-3 rounded-full bg-slate-700 mx-auto mt-2 transition-all"></div>
                        </div>
                        <div class="text-center p-2 bg-slate-900/50 rounded">
                            <div class="text-[10px] text-blue-400 font-bold">EMPTY FLAG</div>
                            <div id="flag-empty" class="w-3 h-3 rounded-full bg-green-500 shadow-[0_0_10px_#4ade80] mx-auto mt-2 transition-all"></div>
                        </div>
                    </div>
                    <div class="text-[10px] font-mono text-slate-400 bg-black/40 p-2 rounded h-32 overflow-y-auto" id="sim-log">
                        > Simulation Ready...
                    </div>
                </div>
            </div>

            <!-- Right: Visualization -->
            <div class="flex-grow glass-panel relative flex flex-col overflow-hidden p-1 bg-slate-900/50 min-h-[400px]">
                <div class="absolute top-4 left-4 z-10 px-3 py-1 bg-black/60 rounded text-[10px] text-slate-400 border border-slate-700 font-bold uppercase tracking-widest">
                    CDC Visualizer
                </div>

                <div class="flex-grow flex items-center justify-center relative overflow-x-auto">
                    <!-- SVG Scaled for responsiveness -->
                    <div class="min-w-[600px] w-full h-full flex items-center justify-center">
                        <svg id="main-svg" width="800" height="500" viewBox="0 0 800 500">
                            <defs>
                                 <marker id="arrow" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0 L0,6 L6,3 z" fill="#475569" /></marker>
                            </defs>

                            <!-- Write Domain -->
                            <rect x="50" y="50" width="250" height="400" rx="10" fill="rgba(239, 68, 68, 0.05)" stroke="#ef4444" stroke-dasharray="5,5" />
                            <text x="60" y="70" fill="#ef4444" font-family="monospace" font-weight="bold" font-size="12">WRITE DOMAIN</text>
                            
                            <!-- Read Domain -->
                            <rect x="500" y="50" width="250" height="400" rx="10" fill="rgba(59, 130, 246, 0.05)" stroke="#3b82f6" stroke-dasharray="5,5" />
                            <text x="510" y="70" fill="#3b82f6" font-family="monospace" font-weight="bold" font-size="12">READ DOMAIN</text>

                            <!-- MEMORY -->
                            <rect x="330" y="100" width="140" height="300" rx="4" fill="#0f172a" stroke="#64748b" stroke-width="2" />
                            <text x="400" y="120" text-anchor="middle" fill="#cbd5e1" font-size="10">FIFO RAM (16x8)</text>
                            <g id="mem-stack" transform="translate(350, 140)"></g>

                            <!-- Pointers -->
                            <text x="175" y="150" text-anchor="middle" fill="#ef4444" font-size="10">W_PTR (Gray)</text>
                            <text x="175" y="170" text-anchor="middle" fill="white" font-family="monospace" font-size="14" id="val-wptr">00000</text>
                            
                            <text x="625" y="150" text-anchor="middle" fill="#3b82f6" font-size="10">R_PTR (Gray)</text>
                            <text x="625" y="170" text-anchor="middle" fill="white" font-family="monospace" font-size="14" id="val-rptr">00000</text>

                            <!-- Synchronizers -->
                            <g transform="translate(100, 300)">
                                <text x="75" y="-10" text-anchor="middle" fill="#64748b" font-size="10">SYNC R2W</text>
                                <rect x="0" y="0" width="50" height="40" fill="#1e293b" stroke="#64748b" />
                                <rect x="60" y="0" width="50" height="40" fill="#1e293b" stroke="#64748b" />
                                <text x="130" y="25" fill="#ef4444" font-size="10" font-family="monospace" id="val-r2w">00000</text>
                            </g>

                            <g transform="translate(550, 300)">
                                <text x="75" y="-10" text-anchor="middle" fill="#64748b" font-size="10">SYNC W2R</text>
                                <rect x="40" y="0" width="50" height="40" fill="#1e293b" stroke="#64748b" />
                                <rect x="100" y="0" width="50" height="40" fill="#1e293b" stroke="#64748b" />
                                <text x="-35" y="25" fill="#3b82f6" font-size="10" font-family="monospace" id="val-w2r">00000</text>
                            </g>

                            <!-- Crossing Wires -->
                            <path d="M210,165 H330 V90 H590 V290" class="wire" stroke="#ef4444" opacity="0.5" stroke-dasharray="2,2" />
                            <path d="M590,165 H470 V90 H210 V290" class="wire" stroke="#3b82f6" opacity="0.5" stroke-dasharray="2,2" />

                            <line x1="200" y1="200" x2="330" y2="200" class="wire" id="wire-wr" stroke="#ef4444" opacity="0.2" stroke-width="4"/>
                            <line x1="470" y1="200" x2="600" y2="200" class="wire" id="wire-rd" stroke="#3b82f6" opacity="0.2" stroke-width="4"/>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Mobile Bottom Navigation -->
    <div class="md:hidden fixed bottom-0 left-0 w-full bg-slate-950/90 backdrop-blur-lg border-t border-slate-800 z-50 flex justify-around p-2 pb-safe">
        <button onclick="switchView('theory')" id="btn-theory-m" class="flex flex-col items-center p-2 text-indigo-400 w-1/3 transition-all scale-105">
            <span class="text-xl">ðŸ“š</span>
            <span class="text-[10px] font-bold mt-1 uppercase">Theory</span>
        </button>
        <button onclick="switchView('rtl')" id="btn-rtl-m" class="flex flex-col items-center p-2 text-slate-500 w-1/3 transition-all">
            <span class="text-xl">ðŸ’»</span>
            <span class="text-[10px] font-bold mt-1 uppercase">Code</span>
        </button>
        <button onclick="switchView('lab')" id="btn-lab-m" class="flex flex-col items-center p-2 text-slate-500 w-1/3 transition-all">
            <span class="text-xl">ðŸ”¬</span>
            <span class="text-[10px] font-bold mt-1 uppercase">Sim</span>
        </button>
    </div>

    <script>
        // --- State ---
        let wPtr = 0, rPtr = 0; 
        let mem = new Array(16).fill(0);
        let fWr = 100, fRd = 50;
        let syncR2W = [0, 0]; 
        let syncW2R = [0, 0]; 
        let simTime = 0;
        let lastWrTime = 0, lastRdTime = 0;

        // --- DOM ---
        const memVisual = document.getElementById('mem-stack');

        // Helpers
        function toGray(n) { return n ^ (n >> 1); }
        function toBinStr(n) { return n.toString(2).padStart(5, '0'); }

        // --- View Logic ---
        function switchView(v) {
            const views = ['theory', 'rtl', 'lab'];
            views.forEach(id => {
                const el = document.getElementById(`view-${id}`);
                const btnD = document.getElementById(`btn-${id}-d`);
                const btnM = document.getElementById(`btn-${id}-m`);
                
                if (id === v) {
                    el.classList.remove('opacity-0', 'pointer-events-none');
                    el.classList.add('z-10');
                    if(btnD) btnD.className = "tab-btn px-6 bg-indigo-600 text-white border-indigo-500 shadow-lg shadow-indigo-500/30";
                    if(btnM) { btnM.classList.remove('text-slate-500'); btnM.classList.add('text-indigo-400', 'scale-105'); }
                } else {
                    el.classList.add('opacity-0', 'pointer-events-none');
                    el.classList.remove('z-10');
                    if(btnD) btnD.className = "tab-btn px-6 text-slate-400 hover:text-white border-transparent";
                    if(btnM) { btnM.classList.add('text-slate-500'); btnM.classList.remove('text-indigo-400', 'scale-105'); }
                }
            });
            if (v === 'lab') {
                renderMem();
                if (!window.loopRunning) { window.loopRunning = true; loop(); }
            }
        }

        // Inputs
        document.getElementById('s-fwr').addEventListener('input', e => { fWr = parseInt(e.target.value); document.getElementById('val-fwr').innerText = fWr + " MHz"; });
        document.getElementById('s-frd').addEventListener('input', e => { fRd = parseInt(e.target.value); document.getElementById('val-frd').innerText = fRd + " MHz"; });

        function doWrite() {
            // Write Logic using True Fill for reliability, but conceptual check against synced pointer
            const filled = (wPtr >= rPtr) ? (wPtr - rPtr) : (32 - rPtr + wPtr);
            if (filled < 16) {
                mem[wPtr % 16] = 1; 
                wPtr = (wPtr + 1) % 32;
                log("Write Data: OK", "text-green-400");
                animWire('wire-wr');
            } else {
                log("Write Ignored: FIFO FULL", "text-red-400");
            }
        }

        function doRead() {
            const filled = (wPtr >= rPtr) ? (wPtr - rPtr) : (32 - rPtr + wPtr);
            if (filled > 0) {
                mem[rPtr % 16] = 0; 
                rPtr = (rPtr + 1) % 32;
                log("Read Data: OK", "text-blue-400");
                animWire('wire-rd');
            } else {
                log("Read Ignored: FIFO EMPTY", "text-slate-500");
            }
        }
        
        function log(msg, cls="text-slate-400") {
            const div = document.createElement('div');
            div.className = cls;
            div.innerText = `> ${msg}`;
            const box = document.getElementById('sim-log');
            box.prepend(div);
        }

        function animWire(id) {
            const el = document.getElementById(id);
            el.style.opacity = 1;
            setTimeout(() => el.style.opacity = 0.2, 200);
        }

        function resetSim() {
            wPtr = 0; rPtr = 0;
            mem.fill(0);
            syncR2W = [0,0]; syncW2R = [0,0];
            log("Reset Complete");
            renderMem();
        }

        function initMem() {
            renderMem();
        }

        // --- Loop ---
        function loop() {
            simTime++;
            
            if (simTime - lastWrTime > (1000/fWr)) {
                lastWrTime = simTime;
                syncW2R.unshift(toGray(wPtr)); syncW2R.pop(); 
            }
            
            if (simTime - lastRdTime > (1000/fRd)) {
                lastRdTime = simTime;
                syncR2W.unshift(toGray(rPtr)); syncR2W.pop(); 
            }

            updateUI();
            requestAnimationFrame(loop);
        }

        function updateUI() {
            document.getElementById('val-wptr').innerText = toBinStr(toGray(wPtr));
            document.getElementById('val-rptr').innerText = toBinStr(toGray(rPtr));
            // Index 0 represents the output of the 2-stage synchronizer (most delayed)
            document.getElementById('val-w2r').innerText = toBinStr(syncW2R[0]); 
            document.getElementById('val-r2w').innerText = toBinStr(syncR2W[0]);

            const rGray = toGray(rPtr);
            const wSynced = syncW2R[0];
            const empty = (rGray === wSynced);
            
            const filled = (wPtr >= rPtr) ? (wPtr - rPtr) : (32 - rPtr + wPtr);
            const full = (filled >= 16);

            const ledE = document.getElementById('flag-empty');
            const ledF = document.getElementById('flag-full');
            
            ledE.className = empty ? "w-3 h-3 rounded-full bg-green-500 shadow-[0_0_8px_#4ade80] mt-1 mx-auto" : "w-3 h-3 rounded-full bg-slate-800 mt-1 mx-auto";
            ledF.className = full ? "w-3 h-3 rounded-full bg-red-500 shadow-[0_0_8px_#ef4444] mt-1 mx-auto" : "w-3 h-3 rounded-full bg-slate-800 mt-1 mx-auto";

            renderMem();
        }

        function renderMem() {
            memVisual.innerHTML = '';
            for(let i=0; i<16; i++) {
                const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                rect.setAttribute("x", 0);
                rect.setAttribute("y", (15-i)*15 + 10);
                rect.setAttribute("width", 100);
                rect.setAttribute("height", 12);
                rect.setAttribute("rx", 2);
                
                if (mem[i]) rect.setAttribute("fill", "#6366f1");
                else rect.setAttribute("fill", "#1e293b");
                
                if (i === (wPtr % 16)) rect.setAttribute("stroke", "#ef4444"); 
                else if (i === (rPtr % 16)) rect.setAttribute("stroke", "#3b82f6"); 
                else rect.setAttribute("stroke", "none");

                memVisual.appendChild(rect);
            }
        }

        // Init
        initMem();
        switchView('theory');

    </script>
</body>
</html>
