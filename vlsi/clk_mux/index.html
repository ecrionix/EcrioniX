<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXZS8C1FLY"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XXZS8C1FLY');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glitch-Free Clock Mux - EcrioniX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Orbitron:wght@500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; overflow: hidden; }
        .tech-font { font-family: 'Orbitron', sans-serif; }
        .code-font { font-family: 'JetBrains Mono', monospace; }
        
        .watermark {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 8rem; font-weight: 900;
            color: rgba(99, 102, 241, 0.03);
            pointer-events: none; user-select: none; z-index: 0;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
        }

        /* Component Styling */
        .ff-box { fill: #1e293b; stroke: #94a3b8; stroke-width: 2; transition: all 0.3s; }
        .ff-active { stroke: #facc15; fill: #422006; }
        .comp-text { font-family: 'Orbitron', sans-serif; fill: #cbd5e1; font-size: 10px; }
        
        /* Wires */
        .wire { fill: none; stroke: #334155; stroke-width: 2.5; transition: stroke 0.1s; stroke-linecap: round; stroke-linejoin: round; }
        .wire-active { stroke: #facc15; filter: drop-shadow(0 0 3px #facc15); opacity: 1; }
        .wire-clk-a { stroke: #ef4444; opacity: 0.6; }
        .wire-clk-b { stroke: #3b82f6; opacity: 0.6; }
        .wire-feedback { stroke-dasharray: 6,4; stroke-width: 1.5; }

        /* Waveform Styles */
        .wave-canvas {
            background-color: #111827;
            border-left: 2px solid #374151;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .switch-btn {
            @apply px-6 py-4 rounded-xl font-bold transition-all border-b-4 active:border-b-0 active:translate-y-1;
        }
        .btn-sel-a { @apply bg-red-600 border-red-800 text-white; }
        .btn-sel-b { @apply bg-blue-600 border-blue-800 text-white; }
        
        .gate-shape { fill: #1e293b; stroke: #94a3b8; stroke-width: 2; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex flex-col relative overflow-x-hidden">

    <div class="watermark">EcrioniX Labs</div>

    <div class="max-w-[1400px] mx-auto w-full flex-grow relative z-10">
        
        <!-- Header -->
        <nav class="flex flex-col md:flex-row justify-between items-center mb-8 border-b border-gray-700 pb-4">
            <div>
                <h1 class="text-3xl font-bold text-white tech-font tracking-wide">CLOCK <span class="text-indigo-500">SWITCHER</span></h1>
                <p class="text-gray-400 text-sm italic">Glitch-Free Mutual Exclusion RTL Architecture</p>
            </div>
            
            <div class="mt-4 md:mt-0 flex items-center gap-4">
                <div class="bg-gray-800 px-6 py-2 rounded border border-gray-600 text-center">
                    <div class="text-[10px] text-gray-500 uppercase font-bold tracking-widest">Active Sink</div>
                    <div id="active-domain" class="text-red-400 font-mono font-bold">CLK_A</div>
                </div>
                <button onclick="window.history.back()" class="group flex items-center text-slate-400 hover:text-white transition bg-slate-800/80 px-4 py-2 rounded-lg border border-slate-700 hover:border-indigo-500">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    <span class="text-xs font-bold uppercase tracking-wider">Exit Lab</span>
                </button>
            </div>
        </nav>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Side: Controls -->
            <div class="lg:col-span-4 space-y-6">
                <div class="glass-panel rounded-2xl p-6 shadow-2xl">
                    <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-6">User Interface</h2>
                    
                    <div class="space-y-6">
                        <div>
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-slate-300 font-bold tracking-tight uppercase">Mux Selection</span>
                                <span id="val-sel" class="font-mono text-indigo-400 font-bold">0 (A)</span>
                            </div>
                            <button id="btn-switch" onclick="toggleSelect()" class="switch-btn btn-sel-a w-full">
                                SWITCH TO CLK_B
                            </button>
                        </div>

                        <div class="pt-4 border-t border-slate-700">
                             <button onclick="resetLab()" class="w-full py-2 bg-slate-800 text-slate-400 text-[10px] font-bold rounded-lg border border-slate-700">RESET SIMULATION</button>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-6">
                    <h3 class="text-xs font-bold text-indigo-400 mb-3 uppercase tracking-wider">How Glitch-Free Muxing Works</h3>
                    <div class="text-[11px] text-slate-400 space-y-4 leading-relaxed">
                        <p>
                            A simple Mux creates glitches if the select changes while clocks are high. This design uses a <strong class="text-white">Mutual Exclusion Handshake</strong>.
                        </p>
                        <p>
                            1. When switching, the active path (e.g. A) must first see the change and <strong class="text-red-400">disable itself</strong> on the next falling edge.
                        </p>
                        <p>
                            2. The second path (B) waits for A's enable to go low (via feedback) before it <strong class="text-blue-400">activates itself</strong> on its own falling edge.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Main: Visualization -->
            <div class="lg:col-span-8 space-y-6">
                
                <!-- CLEAN SCHEMATIC -->
                <div class="glass-panel rounded-2xl p-1 relative overflow-hidden h-[480px]">
                    <div class="absolute top-3 left-4 text-[10px] font-bold text-slate-600 tracking-widest uppercase">Internal RTL Connections</div>
                    
                    <div class="w-full h-full flex items-center justify-center p-4">
                        <svg id="schematic" width="100%" height="100%" viewBox="0 0 900 450">
                            <!-- Inputs labels -->
                            <text x="30" y="80" class="comp-text" fill="#ef4444" font-size="14">CLK_A</text>
                            <text x="30" y="380" class="comp-text" fill="#3b82f6" font-size="14">CLK_B</text>
                            <text x="30" y="230" class="comp-text" fill="#818cf8" font-size="14">SELECT</text>

                            <!-- TOP PATH (CLK A) -->
                            <!-- Start: Select Split to Top -->
                            <path d="M100,225 V110 H150" class="wire" id="wire-sel-a" />
                            <circle cx="155" cy="110" r="4" fill="none" stroke="#94a3b8" stroke-width="2" /> <!-- Inverter Bubble -->

                            <!-- Input AND Path A -->
                            <g transform="translate(180, 90)">
                                <path d="M0,0 h25 a20,20 0 0,1 0,40 h-25 z" class="gate-shape" id="gate-in-a"/>
                                <text x="6" y="24" class="comp-text" font-size="8">AND</text>
                            </g>

                            <!-- Sync A (Falling Edge) -->
                            <g transform="translate(260, 80)">
                                <rect id="ff-a1" width="50" height="60" class="ff-box" />
                                <rect id="ff-a2" x="70" width="50" height="60" class="ff-box" />
                                <path d="M0,50 L5,45 L10,50" fill="none" stroke="#94a3b8" /> <!-- Fall mark -->
                                <path d="M70,50 L75,45 L80,50" fill="none" stroke="#94a3b8" />
                                <text x="25" y="35" text-anchor="middle" class="comp-text" font-size="8">S1</text>
                                <text x="95" y="35" text-anchor="middle" class="comp-text" font-size="8">S2</text>
                            </g>

                            <!-- Output Gate A -->
                            <g transform="translate(420, 80)">
                                <path d="M0,0 h25 a20,20 0 0,1 0,40 h-25 z" class="gate-shape" id="gate-out-a" transform="translate(10, 30)"/>
                                <text x="16" y="54" class="comp-text" font-size="8">AND</text>
                            </g>
                            <line x1="380" y1="110" x2="430" y2="110" class="wire" id="wire-en-a" />
                            <text x="390" y="100" class="comp-text" font-size="9">EN_A</text>

                            <!-- BOTTOM PATH (CLK B) -->
                            <path d="M100,225 V340 H180" class="wire" id="wire-sel-b" />

                            <!-- Input AND Path B -->
                            <g transform="translate(180, 320)">
                                <path d="M0,0 h25 a20,20 0 0,1 0,40 h-25 z" class="gate-shape" id="gate-in-b"/>
                            </g>

                            <!-- Sync B -->
                            <g transform="translate(260, 310)">
                                <rect id="ff-b1" width="50" height="60" class="ff-box" />
                                <rect id="ff-b2" x="70" width="50" height="60" class="ff-box" />
                                <path d="M0,50 L5,45 L10,50" fill="none" stroke="#94a3b8" />
                                <path d="M70,50 L75,45 L80,50" fill="none" stroke="#94a3b8" />
                                <text x="25" y="35" text-anchor="middle" class="comp-text" font-size="8">S1</text>
                                <text x="95" y="35" text-anchor="middle" class="comp-text" font-size="8">S2</text>
                            </g>

                            <!-- Output Gate B -->
                            <g transform="translate(420, 310)">
                                <path d="M0,0 h25 a20,20 0 0,1 0,40 h-25 z" class="gate-shape" id="gate-out-b" transform="translate(10, -30)"/>
                            </g>
                            <line x1="380" y1="340" x2="430" y2="340" class="wire" id="wire-en-b" />
                            <text x="390" y="360" class="comp-text" font-size="9">EN_B</text>

                            <!-- CLOCK DISTRIBUTION -->
                            <!-- Clk A routing -->
                            <path d="M100,80 H430" class="wire wire-clk-a" />
                            <line x1="285" y1="80" x2="285" y2="140" class="wire wire-clk-a" id="w-clk-a1"/>
                            <line x1="355" y1="80" x2="355" y2="140" class="wire wire-clk-a" id="w-clk-a2"/>

                            <!-- Clk B routing -->
                            <path d="M100,380 H430" class="wire wire-clk-b" />
                            <line x1="285" y1="380" x2="285" y2="320" class="wire wire-clk-b" id="w-clk-b1"/>
                            <line x1="355" y1="380" x2="355" y2="320" class="wire wire-clk-b" id="w-clk-b2"/>

                            <!-- CROSS-FEEDBACK HANDSHAKE (The Logic Heart) -->
                            <!-- Feed EN_A (x=380, y=110) back to AND Gate B -->
                            <path d="M400,110 V180 H140 V330 H180" class="wire wire-feedback" id="wire-fb-a" />
                            <circle cx="176" cy="330" r="4" fill="none" stroke="#94a3b8" stroke-width="1.5" /> <!-- Inv -->

                            <!-- Feed EN_B (x=380, y=340) back to AND Gate A -->
                            <path d="M400,340 V270 H140 V120 H180" class="wire wire-feedback" id="wire-fb-b" />
                            <circle cx="176" cy="120" r="4" fill="none" stroke="#94a3b8" stroke-width="1.5" />

                            <!-- FINAL OR GATE & GCLK -->
                            <g transform="translate(580, 205)">
                                <path d="M0,0 Q30,20 0,40 L10,40 Q50,20 10,0 Z" class="gate-shape" stroke="#facc15" stroke-width="2.5" />
                                <text x="12" y="24" class="comp-text" font-size="9" fill="#facc15">OR</text>
                                <line x1="45" y1="20" x2="150" y2="20" class="wire" id="wire-final" />
                                <text x="160" y="25" class="comp-text" fill="#facc15" font-size="18">GCLK</text>
                            </g>

                            <!-- Output routing to OR -->
                            <path d="M475,110 H540 V215 H580" class="wire" id="w-pre-or-a" />
                            <path d="M475,340 H540 V235 H580" class="wire" id="w-pre-or-b" />

                        </svg>
                    </div>
                </div>

                <!-- Timing View -->
                <div class="bg-gray-900 rounded-xl border border-slate-800 overflow-hidden shadow-2xl">
                    <div class="bg-slate-800 px-4 py-2 flex justify-between items-center border-b border-slate-700">
                        <span class="text-xs font-bold text-slate-300 uppercase tracking-widest">Timing Analysis</span>
                        <div class="flex gap-4 text-[10px] font-mono">
                            <span class="text-red-400">CLK_A</span>
                            <span class="text-blue-400">CLK_B</span>
                            <span class="text-yellow-400">GCLK</span>
                        </div>
                    </div>
                    <div class="p-2 relative min-h-[250px]">
                        <canvas id="waveCanvas" height="250" width="800" class="wave-canvas w-full"></canvas>
                        
                        <!-- Track Labels -->
                        <div class="absolute left-2 top-0 h-full pointer-events-none text-[9px] font-mono font-bold opacity-40">
                            <div class="absolute text-red-400" style="top: 35px">CLK_A</div>
                            <div class="absolute text-blue-400" style="top: 75px">CLK_B</div>
                            <div class="absolute text-indigo-400" style="top: 115px">SELECT</div>
                            <div class="absolute text-red-300" style="top: 155px">EN_A</div>
                            <div class="absolute text-blue-300" style="top: 195px">EN_B</div>
                            <div class="absolute text-yellow-500" style="top: 235px">GCLK</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Simulation State ---
        let clkA = 0;
        let clkB = 0;
        let sel = 0;
        
        // Internal Synchronization Stages (Negative-edge)
        let pathA = [0, 0]; 
        let pathB = [0, 0];
        
        let simTime = 0;
        const history = [];
        const MAX_HISTORY = 400;

        // DOM - Cached elements
        let canvas, ctx, btnSwitch, valSel, activeDomainDisp;
        
        // Schematics Elements Cache
        let elFFA1, elFFA2, elFFB1, elFFB2;
        let wSelMain, wSelA, wSelB, wEnA, wEnB, wGclk, wFbA, wFbB, wOutA, wOutB, wFinal;
        let wClkA, wClkB;
        let wAS1, wAS2, wBS1, wBS2, wPreOrA, wPreOrB;

        window.onload = function() {
            canvas = document.getElementById('waveCanvas');
            ctx = canvas.getContext('2d');
            btnSwitch = document.getElementById('btn-switch');
            valSel = document.getElementById('val-sel');
            activeDomainDisp = document.getElementById('active-domain');
            
            // Cache Schematic elements
            elFFA1 = document.getElementById('ff-a1');
            elFFA2 = document.getElementById('ff-a2');
            elFFB1 = document.getElementById('ff-b1');
            elFFB2 = document.getElementById('ff-b2');

            wSelMain = document.getElementById('wire-sel-main');
            wSelA = document.getElementById('wire-sel-a');
            wSelB = document.getElementById('wire-sel-b');
            wEnA = document.getElementById('wire-en-a');
            wEnB = document.getElementById('wire-en-b');
            wFbA = document.getElementById('wire-fb-a');
            wFbB = document.getElementById('wire-fb-b');
            wPreOrA = document.getElementById('w-pre-or-a');
            wPreOrB = document.getElementById('w-pre-or-b');
            wFinal = document.getElementById('wire-final');
            
            wClkA = document.getElementsByClassName('wire-clk-a');
            wClkB = document.getElementsByClassName('wire-clk-b');
            
            // Initialize state
            resetLab();
            requestAnimationFrame(step);
        };

        function toggleSelect() {
            sel = sel ? 0 : 1;
            if(valSel) valSel.innerText = sel ? "1 (B)" : "0 (A)";
            if(btnSwitch) {
                btnSwitch.innerText = sel ? "SWITCH TO CLK_A" : "SWITCH TO CLK_B";
                btnSwitch.className = sel ? "switch-btn btn-sel-b w-full" : "switch-btn btn-sel-a w-full";
            }
        }

        function resetLab() {
            simTime = 0;
            history.length = 0;
            // Initialize with A active
            pathA = [1, 1]; 
            pathB = [0, 0];
            sel = 0;
            
            if(valSel) valSel.innerText = "0 (A)";
            if(btnSwitch) {
                btnSwitch.innerText = "SWITCH TO CLK_B";
                btnSwitch.className = "switch-btn btn-sel-a w-full";
            }
            if(ctx && canvas) ctx.clearRect(0,0,canvas.width, canvas.height);
        }

        function step() {
            simTime++;

            const prevClkA = clkA;
            const prevClkB = clkB;
            
            // Generate asynchronous clocks
            clkA = Math.floor(simTime / 8) % 2; 
            clkB = Math.floor(simTime / 22) % 2; 

            // GLITCH-FREE HANDSHAKE LOGIC
            // Trigger logic on the falling edge of source clocks
            if (prevClkA === 1 && clkA === 0) {
                pathA[0] = (!sel && !pathB[1]) ? 1 : 0;
                pathA[1] = pathA[0];
            }

            if (prevClkB === 1 && clkB === 0) {
                pathB[0] = (sel && !pathA[1]) ? 1 : 0;
                pathB[1] = pathB[0];
            }

            // Gated Clock logic (AND-OR)
            const gclk = (clkA && pathA[1]) || (clkB && pathB[1]);

            if(activeDomainDisp) updateVisuals(gclk);

            history.push({ clkA, clkB, sel, enA: pathA[1], enB: pathB[1], gclk });
            if (history.length > MAX_HISTORY) history.shift();

            drawWaveforms();
            requestAnimationFrame(step);
        }

        function updateVisuals(gclk) {
            // Status Badge
            if (pathA[1]) {
                activeDomainDisp.innerText = "CLK_A";
                activeDomainDisp.className = "text-red-400 font-mono font-bold tracking-widest";
            } else if (pathB[1]) {
                activeDomainDisp.innerText = "CLK_B";
                activeDomainDisp.className = "text-blue-400 font-mono font-bold tracking-widest";
            } else {
                activeDomainDisp.innerText = "HANDOVER";
                activeDomainDisp.className = "text-yellow-500 font-mono font-bold tracking-widest animate-pulse";
            }

            const valEnA = document.getElementById('val-en-a');
            const valEnB = document.getElementById('val-en-b');
            if(valEnA) valEnA.innerText = pathA[1];
            if(valEnB) valEnB.innerText = pathB[1];

            // Wires Helper
            const setWire = (el, val) => { if(el) el.setAttribute('class', `wire ${val ? 'wire-active' : 'wire-low'}`); };
            
            // Set Wires
            if(wClkA) Array.from(wClkA).forEach(el => el.setAttribute('class', `wire wire-clk-a ${clkA ? 'wire-active' : ''}`));
            if(wClkB) Array.from(wClkB).forEach(el => el.setAttribute('class', `wire wire-clk-b ${clkB ? 'wire-active' : ''}`));

            setWire(wSelMain, sel);
            setWire(wSelA, !sel);
            setWire(wSelB, sel);
            setWire(wEnA, pathA[1]);
            setWire(wEnB, pathB[1]);
            setWire(wFinal, gclk);
            setWire(wPreOrA, clkA && pathA[1]);
            setWire(wPreOrB, clkB && pathB[1]);
            
            // Feedback wires
            if(wFbA) wFbA.setAttribute('class', `wire wire-feedback ${pathA[1] ? 'wire-active' : 'wire-low'}`);
            if(wFbB) wFbB.setAttribute('class', `wire wire-feedback ${pathB[1] ? 'wire-active' : 'wire-low'}`);

            // FF Active States
            if(elFFA1) elFFA1.setAttribute('class', `ff-box ${pathA[0] ? 'ff-active' : ''}`);
            if(elFFA2) elFFA2.setAttribute('class', `ff-box ${pathA[1] ? 'ff-active' : ''}`);
            if(elFFB1) elFFB1.setAttribute('class', `ff-box ${pathB[0] ? 'ff-active' : ''}`);
            if(elFFB2) elFFB2.setAttribute('class', `ff-box ${pathB[1] ? 'ff-active' : ''}`);
        }

        function drawWaveforms() {
            if(!canvas || !ctx) return;
            if(canvas.width !== canvas.offsetWidth) canvas.width = canvas.offsetWidth;
            const w = canvas.width;
            const h = canvas.height;
            const stepWidth = w / MAX_HISTORY;

            ctx.clearRect(0,0,w,h);

            const lanes = [
                { id: 'clkA', y: 35, c: '#f87171' },
                { id: 'clkB', y: 75, c: '#60a5fa' },
                { id: 'sel', y: 115, c: '#818cf8' },
                { id: 'enA', y: 155, c: '#fca5a5' },
                { id: 'enB', y: 195, c: '#93c5fd' },
                { id: 'gclk', y: 235, c: '#facc15' }
            ];

            lanes.forEach(lane => {
                ctx.strokeStyle = lane.c;
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                for(let i=0; i<history.length; i++) {
                    const val = history[i][lane.id];
                    const x = i * stepWidth;
                    const y = val ? lane.y - 12 : lane.y + 12;

                    if(i===0) ctx.moveTo(x, y);
                    else {
                        if (history[i-1][lane.id] !== val) ctx.lineTo(x, val ? lane.y+12 : lane.y-12);
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();

                ctx.strokeStyle = 'rgba(255,255,255,0.03)';
                ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(0, lane.y); ctx.lineTo(w, lane.y); ctx.stroke();
            });
        }

    </script>
</body>
</html>
