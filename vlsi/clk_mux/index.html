<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XXZS8C1FLY"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XXZS8C1FLY');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glitch-Free Clock Mux - EcrioniX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Orbitron:wght@500;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; overflow: hidden; }
        .tech-font { font-family: 'Orbitron', sans-serif; }
        .mono-font { font-family: 'JetBrains Mono', monospace; }

        .watermark {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 8rem; font-weight: 900;
            color: rgba(99, 102, 241, 0.03);
            pointer-events: none; user-select: none; z-index: 0;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
        }

        /* Component Styling */
        .ff-box { fill: #1e293b; stroke: #94a3b8; stroke-width: 2; transition: all 0.1s; }
        .ff-active { stroke: #fbbf24; fill: #422006; }
        .comp-text { font-family: 'Orbitron', sans-serif; fill: #cbd5e1; font-size: 10px; }
        
        /* Wires */
        .wire { fill: none; stroke: #475569; stroke-width: 2.5; transition: stroke 0.1s; stroke-linecap: round; stroke-linejoin: round; }
        .wire-active { stroke: #fbbf24; filter: drop-shadow(0 0 3px #fbbf24); opacity: 1; }
        .wire-low { stroke: #334155; opacity: 0.5; }
        
        /* Specific signal colors for clarity base state */
        .wire-clk-a { stroke: #ef4444; opacity: 0.4; }
        .wire-clk-b { stroke: #3b82f6; opacity: 0.4; }
        .wire-sel { stroke: #818cf8; opacity: 0.4; }

        .wire-clk-active { stroke: #ef4444 !important; opacity: 1 !important; filter: drop-shadow(0 0 2px #ef4444); stroke-width: 3; }
        .wire-clk-b-active { stroke: #3b82f6 !important; opacity: 1 !important; filter: drop-shadow(0 0 2px #3b82f6); stroke-width: 3; }

        /* Waveform Styles */
        .wave-canvas {
            background-color: #111827;
            border-left: 2px solid #374151;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.02) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .switch-btn {
            @apply px-6 py-4 rounded-xl font-bold transition-all border-b-4 active:border-b-0 active:translate-y-1;
        }
        .btn-sel-a { @apply bg-red-600 border-red-800 text-white; }
        .btn-sel-b { @apply bg-blue-600 border-blue-800 text-white; }
        
        .gate-shape { fill: #1e293b; stroke: #94a3b8; stroke-width: 2; }
    </style>
</head>
<body class="p-4 md:p-8 h-screen flex flex-col relative overflow-hidden">

    <div class="watermark">EcrioniX Labs</div>

    <div class="max-w-[1400px] mx-auto w-full flex-grow relative z-10">
        
        <!-- Header -->
        <nav class="flex flex-col md:flex-row justify-between items-center mb-8 border-b border-gray-700 pb-4">
            <div>
                <h1 class="text-3xl font-bold text-white tech-font tracking-wide">CLOCK <span class="text-indigo-500">MUX</span></h1>
                <p class="text-gray-400 text-sm italic">Glitch-Free Mutual Exclusion RTL Architecture</p>
            </div>
            
            <div class="mt-4 md:mt-0 flex items-center gap-4">
                <div class="bg-gray-800 px-6 py-2 rounded border border-gray-600 text-center">
                    <div class="text-[10px] text-gray-500 uppercase font-bold tracking-widest">Active Sink</div>
                    <div id="active-domain" class="text-red-400 font-mono font-bold">CLK_A</div>
                </div>
                <button onclick="window.history.back()" class="group flex items-center text-slate-400 hover:text-white transition bg-slate-800/80 px-4 py-2 rounded-lg border border-slate-700 hover:border-indigo-500">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    <span class="text-xs font-bold uppercase tracking-wider">Exit Lab</span>
                </button>
            </div>
        </nav>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Side: Controls -->
            <div class="lg:col-span-4 space-y-6">
                <div class="glass-panel rounded-2xl p-6 shadow-2xl">
                    <h2 class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-6">User Interface</h2>
                    
                    <div class="space-y-6">
                        <div>
                            <div class="flex justify-between text-xs mb-2">
                                <span class="text-slate-300 font-bold tracking-tight uppercase">Mux Selection</span>
                                <span id="val-sel" class="font-mono text-indigo-400 font-bold">0 (A)</span>
                            </div>
                            <button id="btn-switch" onclick="toggleSelect()" class="switch-btn btn-sel-a w-full">
                                SWITCH TO CLK_B
                            </button>
                        </div>

                        <div class="pt-4 border-t border-slate-700">
                             <button onclick="resetLab()" class="w-full py-2 bg-slate-800 text-slate-400 text-[10px] font-bold rounded-lg border border-slate-700">RESET SIMULATION</button>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-900/50 border border-slate-800 rounded-2xl p-6">
                    <h3 class="text-xs font-bold text-indigo-400 mb-3 uppercase tracking-wider">How Glitch-Free Muxing Works</h3>
                    <div class="text-[11px] text-slate-400 space-y-4 leading-relaxed">
                        <p>
                            A simple Mux creates glitches if the select changes while clocks are high. This design uses a <strong class="text-white">Mutual Exclusion Handshake</strong>.
                        </p>
                        <p>
                            1. When switching, the active path (e.g. A) must first see the change and <strong class="text-red-400">disable itself</strong> on the next falling edge.
                        </p>
                        <p>
                            2. The second path (B) waits for A's enable to go low (via feedback) before it <strong class="text-blue-400">activates itself</strong> on its own falling edge.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Main: Visualization -->
            <div class="lg:col-span-8 space-y-6">
                
                <!-- CLEAN SCHEMATIC -->
                <div class="glass-panel rounded-2xl p-1 relative overflow-hidden h-[480px]">
                    <div class="absolute top-3 left-4 text-[10px] font-bold text-slate-600 tracking-widest uppercase">Internal RTL Connections</div>
                    
                    <div class="w-full h-full flex items-center justify-center p-4">
                        <svg id="schematic" width="100%" height="100%" viewBox="0 0 900 450">
                            <!-- DEFINITIONS -->
                            <defs>
                                <g id="gate-and">
                                    <path d="M0,0 V40 H20 A20,20 0 0,0 20,0 H0 Z" class="gate-shape" />
                                </g>
                                <g id="gate-or">
                                    <path d="M0,0 Q15,20 0,40 L10,40 Q50,20 10,0 Z" class="gate-shape" />
                                </g>
                                <g id="ff-negedge">
                                    <rect x="0" y="0" width="40" height="60" class="ff-box" rx="2" />
                                    <text x="5" y="15" class="gate-text" font-size="8">D</text>
                                    <text x="28" y="15" class="gate-text" font-size="8">Q</text>
                                    <path d="M0,50 L5,45 L5,55 Z" fill="#94a3b8" /> <!-- Bubble handled by circle in instance -->
                                    <circle cx="-2" cy="50" r="2" fill="#1e293b" stroke="#94a3b8" />
                                </g>
                            </defs>

                            <!-- LABELS -->
                            <text x="20" y="120" class="comp-text" fill="#ef4444" font-size="14" font-weight="bold">CLK_A</text>
                            <text x="20" y="320" class="comp-text" fill="#3b82f6" font-size="14" font-weight="bold">CLK_B</text>
                            <text x="20" y="220" class="comp-text" fill="#818cf8" font-size="14" font-weight="bold">SEL</text>

                            <!-- ================= TOP RAIL (A) ================= -->
                            <!-- Logic A: AND -> FF1 -> FF2 -> AND(Out) -->
                            
                            <!-- Input AND A (x=150, y=100) -->
                            <g transform="translate(150, 100)">
                                <use href="#gate-and" id="gate-in-a" />
                                <circle cx="0" cy="30" r="3" fill="#1e293b" stroke="#94a3b8" /> <!-- Invert Input 2 (Feedback) -->
                                <circle cx="0" cy="10" r="3" fill="#1e293b" stroke="#94a3b8" /> <!-- Invert Input 1 (Select) -->
                            </g>

                            <!-- FF A1 (x=220, y=90) -->
                            <g transform="translate(220, 90)" id="ff-a1"><use href="#ff-negedge" /></g>
                            <!-- FF A2 (x=300, y=90) -->
                            <g transform="translate(300, 90)" id="ff-a2"><use href="#ff-negedge" /></g>

                            <!-- Output AND A (x=400, y=100) -->
                            <g transform="translate(400, 100)">
                                <use href="#gate-and" id="gate-out-a" />
                            </g>

                            <!-- Wiring A -->
                            <line id="w-a-logic" x1="190" y1="120" x2="220" y2="120" class="wire" /> <!-- AND to FF1 D -->
                            <line id="w-a-s1" x1="260" y1="105" x2="300" y2="105" class="wire" /> <!-- FF1 Q to FF2 D -->
                            <line id="w-a-en" x1="340" y1="105" x2="400" y2="110" class="wire" /> <!-- FF2 Q to Out AND -->
                            <line id="w-a-out" x1="440" y1="120" x2="520" y2="120" class="wire" /> <!-- To OR -->

                            <!-- Clock A Line -->
                            <path id="w-clk-a" d="M80,120 H120 V80 H220 V140 H200 M220,80 H300 V140 H280 M300,80 H400 V130 H380" class="wire wire-clk-a" fill="none" />


                            <!-- ================= BOTTOM RAIL (B) ================= -->
                            <!-- Logic B: AND -> FF1 -> FF2 -> AND(Out) -->

                            <!-- Input AND B (x=150, y=300) -->
                            <g transform="translate(150, 300)">
                                <use href="#gate-and" id="gate-in-b" />
                                <circle cx="0" cy="30" r="3" fill="#1e293b" stroke="#94a3b8" /> <!-- Invert Input 2 (Feedback) -->
                            </g>

                            <!-- FF B1 (x=220, y=290) -->
                            <g transform="translate(220, 290)" id="ff-b1"><use href="#ff-negedge" /></g>
                            <!-- FF B2 (x=300, y=290) -->
                            <g transform="translate(300, 290)" id="ff-b2"><use href="#ff-negedge" /></g>

                            <!-- Output AND B (x=400, y=300) -->
                            <g transform="translate(400, 300)">
                                <use href="#gate-and" id="gate-out-b" />
                            </g>

                            <!-- Wiring B -->
                            <line id="w-b-logic" x1="190" y1="320" x2="220" y2="320" class="wire" />
                            <line id="w-b-s1" x1="260" y1="305" x2="300" y2="305" class="wire" />
                            <line id="w-b-en" x1="340" y1="305" x2="400" y2="310" class="wire" />
                            <line id="w-b-out" x1="440" y1="320" x2="520" y2="320" class="wire" />

                            <!-- Clock B Line -->
                            <path id="w-clk-b" d="M80,320 H120 V360 H220 V280 H200 M220,360 H300 V280 H280 M300,360 H400 V330 H380" class="wire wire-clk-b" fill="none" />


                            <!-- ================= CONTROL & FEEDBACK ================= -->
                            
                            <!-- Select Line -->
                            <path id="w-sel-main" d="M80,215 H120" class="wire wire-sel" />
                            <path id="w-sel-a" d="M120,215 V110 H148" class="wire wire-sel" /> <!-- To A (Inv Bubble handled by gate) -->
                            <path id="w-sel-b" d="M120,215 V310 H150" class="wire wire-sel" /> <!-- To B -->

                            <!-- Feedback: En_A (from 360,105) to AND B (150,330) -->
                            <path id="w-fb-a" d="M360,105 V170 H130 V330 H148" class="wire wire-feedback" stroke="#ef4444" fill="none" />
                            
                            <!-- Feedback: En_B (from 360,305) to AND A (150,130) -->
                            <path id="w-fb-b" d="M360,305 V240 H130 V130 H148" class="wire wire-feedback" stroke="#3b82f6" fill="none" />


                            <!-- ================= OUTPUT OR ================= -->
                            <g transform="translate(540, 200)">
                                <use href="#gate-or" transform="scale(1.5)" />
                                <text x="15" y="35" class="gate-text" fill="white">OR</text>
                            </g>
                            <!-- Routing A to OR -->
                            <path id="w-pre-or-a" d="M520,120 H540 V210 H550" class="wire" fill="none" />
                            <!-- Routing B to OR -->
                            <path id="w-pre-or-b" d="M520,320 H540 V250 H550" class="wire" fill="none" />
                            
                            <!-- Final Output -->
                            <line id="w-final" x1="610" y1="230" x2="750" y2="230" class="wire" stroke-width="4" />
                            <text x="760" y="235" fill="#4ade80" font-weight="bold" font-size="18" class="mono-font">GCLK_OUT</text>

                        </svg>
                    </div>
                </div>

                <!-- Waveforms -->
                <div class="bg-gray-900 rounded-xl border border-slate-800 overflow-hidden shadow-2xl">
                    <div class="bg-slate-800 px-4 py-2 flex justify-between items-center border-b border-slate-700">
                        <span class="text-xs font-bold text-slate-300 uppercase tracking-widest">Timing Analysis</span>
                        <div class="flex gap-4 text-[10px] font-mono">
                            <span class="text-red-400">CLK_A</span>
                            <span class="text-blue-400">CLK_B</span>
                            <span class="text-yellow-400">GCLK</span>
                        </div>
                    </div>
                    <div class="p-2 relative min-h-[250px]">
                        <canvas id="waveCanvas" height="250" width="800" class="wave-canvas w-full"></canvas>
                        
                        <!-- Track Labels -->
                        <div class="absolute left-2 top-0 h-full pointer-events-none text-[9px] font-mono font-bold opacity-40">
                            <div class="absolute text-red-400" style="top: 35px">CLK_A</div>
                            <div class="absolute text-blue-400" style="top: 75px">CLK_B</div>
                            <div class="absolute text-indigo-400" style="top: 115px">SELECT</div>
                            <div class="absolute text-red-300" style="top: 155px">EN_A</div>
                            <div class="absolute text-blue-300" style="top: 195px">EN_B</div>
                            <div class="absolute text-yellow-500" style="top: 235px">GCLK</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Simulation State ---
        let clkA = 0;
        let clkB = 0;
        let sel = 0;
        
        // Internal Synchronization Stages (Negative-edge)
        let pathA = [0, 0]; 
        let pathB = [0, 0];
        
        let simTime = 0;
        const history = [];
        const MAX_HISTORY = 400;

        // DOM - Cached elements
        let canvas, ctx, btnSwitch, valSel, activeDomainDisp;
        
        // Schematics Elements Cache
        let elFFA1, elFFA2, elFFB1, elFFB2;
        let wSelMain, wSelA, wSelB, wEnA, wEnB, wGclk, wFbA, wFbB, wOutA, wOutB, wFinal;
        let wClkA, wClkB, wALogic, wBLogic, wAS1, wBS1;
        let wPreOrA, wPreOrB;

        window.onload = function() {
            canvas = document.getElementById('waveCanvas');
            ctx = canvas.getContext('2d');
            btnSwitch = document.getElementById('btn-switch');
            valSel = document.getElementById('val-sel');
            activeDomainDisp = document.getElementById('active-domain');
            
            // Cache Schematic elements
            elFFA1 = document.getElementById('ff-a1');
            elFFA2 = document.getElementById('ff-a2');
            elFFB1 = document.getElementById('ff-b1');
            elFFB2 = document.getElementById('ff-b2');

            wSelMain = document.getElementById('w-sel-main');
            wSelA = document.getElementById('w-sel-a');
            wSelB = document.getElementById('w-sel-b');
            
            wALogic = document.getElementById('w-a-logic');
            wAS1 = document.getElementById('w-a-s1');
            wEnA = document.getElementById('w-a-en');
            wOutA = document.getElementById('w-a-out');

            wBLogic = document.getElementById('w-b-logic');
            wBS1 = document.getElementById('w-b-s1');
            wEnB = document.getElementById('w-b-en');
            wOutB = document.getElementById('w-b-out');

            wFbA = document.getElementById('w-fb-a');
            wFbB = document.getElementById('w-fb-b');
            
            wPreOrA = document.getElementById('w-pre-or-a');
            wPreOrB = document.getElementById('w-pre-or-b');
            wFinal = document.getElementById('w-final');
            
            wClkA = document.getElementById('w-clk-a');
            wClkB = document.getElementById('w-clk-b');
            
            // Initialize state
            resetLab();
            requestAnimationFrame(step);
        };

        function toggleSelect() {
            sel = sel ? 0 : 1;
            if(valSel) valSel.innerText = sel ? "1 (B)" : "0 (A)";
            if(btnSwitch) {
                btnSwitch.innerText = sel ? "SWITCH TO CLK_A" : "SWITCH TO CLK_B";
                btnSwitch.className = sel ? "switch-btn btn-sel-b w-full" : "switch-btn btn-sel-a w-full";
            }
        }

        function resetLab() {
            simTime = 0;
            history.length = 0;
            // Initialize with A active
            pathA = [1, 1]; 
            pathB = [0, 0];
            sel = 0;
            
            if(valSel) valSel.innerText = "0 (A)";
            if(btnSwitch) {
                btnSwitch.innerText = "SWITCH TO CLK_B";
                btnSwitch.className = "switch-btn btn-sel-a w-full";
            }
            if(ctx && canvas) ctx.clearRect(0,0,canvas.width, canvas.height);
        }

        function step() {
            simTime++;

            const prevClkA = clkA;
            const prevClkB = clkB;
            
            // Generate asynchronous clocks
            clkA = Math.floor(simTime / 8) % 2; 
            clkB = Math.floor(simTime / 22) % 2; 

            // GLITCH-FREE HANDSHAKE LOGIC
            // A Path updates on falling edge of CLK_A
            if (prevClkA === 1 && clkA === 0) {
                pathA[0] = (!sel && !pathB[1]) ? 1 : 0;
                pathA[1] = pathA[0];
            }

            // B Path updates on falling edge of CLK_B
            if (prevClkB === 1 && clkB === 0) {
                pathB[0] = (sel && !pathA[1]) ? 1 : 0;
                pathB[1] = pathB[0];
            }

            // Gated Clock logic (AND-OR)
            const gclk = (clkA && pathA[1]) || (clkB && pathB[1]);

            if(activeDomainDisp) updateVisuals(gclk);

            history.push({ clkA, clkB, sel, enA: pathA[1], enB: pathB[1], gclk });
            if (history.length > MAX_HISTORY) history.shift();

            drawWaveforms();
            requestAnimationFrame(step);
        }

        function updateVisuals(gclk) {
            // Status Badge
            if (pathA[1]) {
                activeDomainDisp.innerText = "CLK_A";
                activeDomainDisp.className = "text-red-400 font-mono font-bold tracking-widest";
            } else if (pathB[1]) {
                activeDomainDisp.innerText = "CLK_B";
                activeDomainDisp.className = "text-blue-400 font-mono font-bold tracking-widest";
            } else {
                activeDomainDisp.innerText = "HANDOVER";
                activeDomainDisp.className = "text-yellow-500 font-mono font-bold tracking-widest animate-pulse";
            }

            // Wires Helper
            const setWire = (el, val) => { if(el) el.setAttribute('class', `wire ${val ? 'wire-active' : 'wire-low'}`); };
            
            // Clocks visual
            if(wClkA) wClkA.setAttribute('class', `wire wire-clock-a ${clkA ? 'wire-clock-active' : ''}`);
            if(wClkB) wClkB.setAttribute('class', `wire wire-clock-b ${clkB ? 'wire-clock-active' : ''}`);

            // Logic Paths
            setWire(wSelMain, sel);
            setWire(wSelA, !sel);
            setWire(wSelB, sel);
            
            // Path A wires
            const logicA = (!sel && !pathB[1]); // Input to FF A1
            setWire(wALogic, logicA);
            setWire(wAS1, pathA[0]);
            setWire(wEnA, pathA[1]);

            // Path B wires
            const logicB = (sel && !pathA[1]); // Input to FF B1
            setWire(wBLogic, logicB);
            setWire(wBS1, pathB[0]);
            setWire(wEnB, pathB[1]);

            // Feedback
            setWire(wFbA, pathA[1]); // Active if A is ON
            setWire(wFbB, pathB[1]); // Active if B is ON

            // Final Output
            setWire(wPreOrA, clkA && pathA[1]);
            setWire(wPreOrB, clkB && pathB[1]);
            setWire(wFinal, gclk);
            
            // FFs
            if(elFFA1) elFFA1.setAttribute('class', `ff-box ${pathA[0] ? 'ff-active' : ''}`);
            if(elFFA2) elFFA2.setAttribute('class', `ff-box ${pathA[1] ? 'ff-active' : ''}`);
            if(elFFB1) elFFB1.setAttribute('class', `ff-box ${pathB[0] ? 'ff-active' : ''}`);
            if(elFFB2) elFFB2.setAttribute('class', `ff-box ${pathB[1] ? 'ff-active' : ''}`);
        }

        function drawWaveforms() {
            if(!canvas || !ctx) return;
            if(canvas.width !== canvas.offsetWidth) canvas.width = canvas.offsetWidth;
            const w = canvas.width;
            const h = canvas.height;
            const stepWidth = w / MAX_HISTORY;

            ctx.clearRect(0,0,w,h);

            const lanes = [
                { id: 'clkA', y: 35, c: '#f87171' },
                { id: 'clkB', y: 75, c: '#60a5fa' },
                { id: 'sel', y: 115, c: '#818cf8' },
                { id: 'enA', y: 155, c: '#fca5a5' },
                { id: 'enB', y: 195, c: '#93c5fd' },
                { id: 'gclk', y: 235, c: '#facc15' }
            ];

            lanes.forEach(lane => {
                ctx.strokeStyle = lane.c;
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                for(let i=0; i<history.length; i++) {
                    const val = history[i][lane.id];
                    const x = i * stepWidth;
                    const y = val ? lane.y - 12 : lane.y + 12;

                    if(i===0) ctx.moveTo(x, y);
                    else {
                        if (history[i-1][lane.id] !== val) ctx.lineTo(x, val ? lane.y+12 : lane.y-12);
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();

                ctx.strokeStyle = 'rgba(255,255,255,0.03)';
                ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(0, lane.y); ctx.lineTo(w, lane.y); ctx.stroke();
            });
        }

    </script>
</body>
</html>
